/*!
 * eFit Website
 * An app for financial training in educational environments
 * http://www.e-fit.com
 * @author Armin Pfurtscheller
 * @version 1.0.0
 * Copyright 2017. MIT licensed.
 */
/* global ANGULAR_MODULE, angular */
(function(module, angular) {
  'use strict';

  /**
  * @constructor
  */
  var JWT = function($injector, storage) {
    this.$injector = $injector;
    this.storage = storage.getProxy();
  };

  JWT.$inject = ['$injector', 'storage'];

  //
  // PROPERTIES
  //

  /** @var {string} tokenKey Token key for local storage. */
  JWT.prototype.tokenKey = 'NAksNyshI3';

  /** @var {string} refreshKey Refresh key for local storage. */
  JWT.prototype.refreshKey = 'i08BFNG9t5';

  //
  // METHODS
  //

  /**
   * Gets JWT token from local storage.
   *
   * @public
   * @method getToken
   * @return {string|null}
   */
  JWT.prototype.getToken = function()
    {
      return this.storage.getItem(this.tokenKey);
    };

  /**
   * Sets JWT token in local storage.
   *
   * @public
   * @method setToken
   * @param {string} token
   * @return {void}
   */
  JWT.prototype.setToken = function(token)
    {
      this.storage.setItem(this.tokenKey,token);
    };

  /**
   * Removes JWT token from local storage.
   *
   * @public
   * @method removeToken
   * @return {void}
   */
  JWT.prototype.removeToken = function()
    {
      this.storage.removeItem(this.tokenKey);
    };

  /**
   * Gets JWT refresh token from local storage.
   *
   * @public
   * @method getRefreshToken
   * @return {string|null}
   */
  JWT.prototype.getRefreshToken = function()
    {
      return this.storage.getItem(this.refreshKey);
    };

  /**
   * Sets JWT refresh token in local storage.
   *
   * @public
   * @method setRefreshToken
   * @param {string} refreshToken
   * @return {void}
   */
  JWT.prototype.setRefreshToken = function(refreshToken)
    {
      this.storage.setItem(this.refreshKey, refreshToken);
    };

  /**
   * Removes JWT refresh token from local storage.
   *
   * @public
   * @method removeToken
   * @return {void}
   */
  JWT.prototype.removeRefreshToken = function()
    {
      this.storage.removeItem(this.refreshKey);
    };

  /**
   * Converts timestamp into date object.
   *
   * @public
   * @method getExpirationDate
   * @param {string} token
   * @return {date}
   */
  JWT.prototype.getExpirationDate = function(token)
    {
      var $log = this.$injector.get('$log');

      token = token || this.getToken();
      if (!token) {
        $log.error('No token given or available!');
        return null;
      }

      var decoded = this.decode(token);
      if (typeof decoded.exp==='undefined') {
        $log.error('No `exp` property available!');
        return null;
      }

      var date = new Date(0);
      date.setUTCSeconds(decoded.exp);

      return date;
    };

  /**
   * Determines if given token is expired.
   *
   * @public
   * @method isExpired
   * @param {string} token
   * @param {number} offset In seconds.
   * @return {boolean}
   */
  JWT.prototype.isExpired = function(token, offset)
    {
      offset = offset || 0;
      token = token || this.getToken();

      var date = this.getExpirationDate(token);
      if (date === null) {
        return true;
      }

      var now = new Date().valueOf();
      offset = now + offset * 1000;
      date = date.valueOf();

      return date <= offset;
    };

  /**
   * Tries to decode a JWT token.
   *
   * @public
   * @method decode
   * @param {string} token
   * @return {object|null}
   */
  JWT.prototype.decode = function(token)
    {
      var $log = this.$injector.get('$log');

      try {
        var parts = token.split('.');
        if (parts.length !== 3) {
          throw new Error('JWT must have 3 parts!');
        }

        var decoded = this._base64Decode(parts[1]);
        if (!decoded) {
          throw new Error('Cannot decode the token!');
        }

        return angular.fromJson(decoded);
      } catch(e) {
        $log.error(e);
        return null;
      }
    };

  /**
   * Validates and decodes a base64 url.
   *
   * @private
   * @method _base64Decode
   * @param {string} input
   * @return {string}
   */
  JWT.prototype._base64Decode = function(input)
    {
      var $window = this.$injector.get('$window');
      var $log = this.$injector.get('$log');

      var output = input
        .replace(/-/g, '+')
        .replace(/_/g, '/');

      try{
        switch (output.length % 4) {
          case 0: {
            break;
          }

          case 2: {
            output += '=='; break;
          }

          case 3: {
            output += '='; break;
          }

          default: {
            throw new Error('Illegal base64url code!');
          }
        }
      } catch(e) {
        $log.error(e);
        return '';
      }

      var decoded = $window.atob(output);
      var escaped = $window.escape(decoded);

      return $window.decodeURIComponent(escaped);
    };

  //
  // REGISTRY
  //
  angular.module(module).service('jwt', JWT);

})(ANGULAR_MODULE, angular);

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9zZXJ2aWNlcy9qd3QuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJhcHAvc2VydmljZXMvand0Lm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGdsb2JhbCBBTkdVTEFSX01PRFVMRSwgYW5ndWxhciAqL1xuKGZ1bmN0aW9uKG1vZHVsZSwgYW5ndWxhcikge1xuICAndXNlIHN0cmljdCc7XG5cbiAgLyoqXG4gICogQGNvbnN0cnVjdG9yXG4gICovXG4gIHZhciBKV1QgPSBmdW5jdGlvbigkaW5qZWN0b3IsIHN0b3JhZ2UpIHtcbiAgICB0aGlzLiRpbmplY3RvciA9ICRpbmplY3RvcjtcbiAgICB0aGlzLnN0b3JhZ2UgPSBzdG9yYWdlLmdldFByb3h5KCk7XG4gIH07XG5cbiAgSldULiRpbmplY3QgPSBbJyRpbmplY3RvcicsICdzdG9yYWdlJ107XG5cbiAgLy9cbiAgLy8gUFJPUEVSVElFU1xuICAvL1xuXG4gIC8qKiBAdmFyIHtzdHJpbmd9IHRva2VuS2V5IFRva2VuIGtleSBmb3IgbG9jYWwgc3RvcmFnZS4gKi9cbiAgSldULnByb3RvdHlwZS50b2tlbktleSA9ICdOQWtzTnlzaEkzJztcblxuICAvKiogQHZhciB7c3RyaW5nfSByZWZyZXNoS2V5IFJlZnJlc2gga2V5IGZvciBsb2NhbCBzdG9yYWdlLiAqL1xuICBKV1QucHJvdG90eXBlLnJlZnJlc2hLZXkgPSAnaTA4QkZORzl0NSc7XG5cbiAgLy9cbiAgLy8gTUVUSE9EU1xuICAvL1xuXG4gIC8qKlxuICAgKiBHZXRzIEpXVCB0b2tlbiBmcm9tIGxvY2FsIHN0b3JhZ2UuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBnZXRUb2tlblxuICAgKiBAcmV0dXJuIHtzdHJpbmd8bnVsbH1cbiAgICovXG4gIEpXVC5wcm90b3R5cGUuZ2V0VG9rZW4gPSBmdW5jdGlvbigpXG4gICAge1xuICAgICAgcmV0dXJuIHRoaXMuc3RvcmFnZS5nZXRJdGVtKHRoaXMudG9rZW5LZXkpO1xuICAgIH07XG5cbiAgLyoqXG4gICAqIFNldHMgSldUIHRva2VuIGluIGxvY2FsIHN0b3JhZ2UuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBzZXRUb2tlblxuICAgKiBAcGFyYW0ge3N0cmluZ30gdG9rZW5cbiAgICogQHJldHVybiB7dm9pZH1cbiAgICovXG4gIEpXVC5wcm90b3R5cGUuc2V0VG9rZW4gPSBmdW5jdGlvbih0b2tlbilcbiAgICB7XG4gICAgICB0aGlzLnN0b3JhZ2Uuc2V0SXRlbSh0aGlzLnRva2VuS2V5LHRva2VuKTtcbiAgICB9O1xuXG4gIC8qKlxuICAgKiBSZW1vdmVzIEpXVCB0b2tlbiBmcm9tIGxvY2FsIHN0b3JhZ2UuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCByZW1vdmVUb2tlblxuICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgKi9cbiAgSldULnByb3RvdHlwZS5yZW1vdmVUb2tlbiA9IGZ1bmN0aW9uKClcbiAgICB7XG4gICAgICB0aGlzLnN0b3JhZ2UucmVtb3ZlSXRlbSh0aGlzLnRva2VuS2V5KTtcbiAgICB9O1xuXG4gIC8qKlxuICAgKiBHZXRzIEpXVCByZWZyZXNoIHRva2VuIGZyb20gbG9jYWwgc3RvcmFnZS5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIGdldFJlZnJlc2hUb2tlblxuICAgKiBAcmV0dXJuIHtzdHJpbmd8bnVsbH1cbiAgICovXG4gIEpXVC5wcm90b3R5cGUuZ2V0UmVmcmVzaFRva2VuID0gZnVuY3Rpb24oKVxuICAgIHtcbiAgICAgIHJldHVybiB0aGlzLnN0b3JhZ2UuZ2V0SXRlbSh0aGlzLnJlZnJlc2hLZXkpO1xuICAgIH07XG5cbiAgLyoqXG4gICAqIFNldHMgSldUIHJlZnJlc2ggdG9rZW4gaW4gbG9jYWwgc3RvcmFnZS5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIHNldFJlZnJlc2hUb2tlblxuICAgKiBAcGFyYW0ge3N0cmluZ30gcmVmcmVzaFRva2VuXG4gICAqIEByZXR1cm4ge3ZvaWR9XG4gICAqL1xuICBKV1QucHJvdG90eXBlLnNldFJlZnJlc2hUb2tlbiA9IGZ1bmN0aW9uKHJlZnJlc2hUb2tlbilcbiAgICB7XG4gICAgICB0aGlzLnN0b3JhZ2Uuc2V0SXRlbSh0aGlzLnJlZnJlc2hLZXksIHJlZnJlc2hUb2tlbik7XG4gICAgfTtcblxuICAvKipcbiAgICogUmVtb3ZlcyBKV1QgcmVmcmVzaCB0b2tlbiBmcm9tIGxvY2FsIHN0b3JhZ2UuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCByZW1vdmVUb2tlblxuICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgKi9cbiAgSldULnByb3RvdHlwZS5yZW1vdmVSZWZyZXNoVG9rZW4gPSBmdW5jdGlvbigpXG4gICAge1xuICAgICAgdGhpcy5zdG9yYWdlLnJlbW92ZUl0ZW0odGhpcy5yZWZyZXNoS2V5KTtcbiAgICB9O1xuXG4gIC8qKlxuICAgKiBDb252ZXJ0cyB0aW1lc3RhbXAgaW50byBkYXRlIG9iamVjdC5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIGdldEV4cGlyYXRpb25EYXRlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB0b2tlblxuICAgKiBAcmV0dXJuIHtkYXRlfVxuICAgKi9cbiAgSldULnByb3RvdHlwZS5nZXRFeHBpcmF0aW9uRGF0ZSA9IGZ1bmN0aW9uKHRva2VuKVxuICAgIHtcbiAgICAgIHZhciAkbG9nID0gdGhpcy4kaW5qZWN0b3IuZ2V0KCckbG9nJyk7XG5cbiAgICAgIHRva2VuID0gdG9rZW4gfHzCoHRoaXMuZ2V0VG9rZW4oKTtcbiAgICAgIGlmICghdG9rZW4pIHtcbiAgICAgICAgJGxvZy5lcnJvcignTm8gdG9rZW4gZ2l2ZW4gb3IgYXZhaWxhYmxlIScpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgdmFyIGRlY29kZWQgPSB0aGlzLmRlY29kZSh0b2tlbik7XG4gICAgICBpZiAodHlwZW9mIGRlY29kZWQuZXhwPT09J3VuZGVmaW5lZCcpIHtcbiAgICAgICAgJGxvZy5lcnJvcignTm8gYGV4cGAgcHJvcGVydHkgYXZhaWxhYmxlIScpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgdmFyIGRhdGUgPSBuZXcgRGF0ZSgwKTtcbiAgICAgIGRhdGUuc2V0VVRDU2Vjb25kcyhkZWNvZGVkLmV4cCk7XG5cbiAgICAgIHJldHVybiBkYXRlO1xuICAgIH07XG5cbiAgLyoqXG4gICAqIERldGVybWluZXMgaWYgZ2l2ZW4gdG9rZW4gaXMgZXhwaXJlZC5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIGlzRXhwaXJlZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gdG9rZW5cbiAgICogQHBhcmFtIHtudW1iZXJ9IG9mZnNldCBJbiBzZWNvbmRzLlxuICAgKiBAcmV0dXJuIHtib29sZWFufVxuICAgKi9cbiAgSldULnByb3RvdHlwZS5pc0V4cGlyZWQgPSBmdW5jdGlvbih0b2tlbiwgb2Zmc2V0KVxuICAgIHtcbiAgICAgIG9mZnNldCA9IG9mZnNldCB8fCAwO1xuICAgICAgdG9rZW4gPSB0b2tlbiB8fMKgdGhpcy5nZXRUb2tlbigpO1xuXG4gICAgICB2YXIgZGF0ZSA9IHRoaXMuZ2V0RXhwaXJhdGlvbkRhdGUodG9rZW4pO1xuICAgICAgaWYgKGRhdGUgPT09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG5cbiAgICAgIHZhciBub3cgPSBuZXcgRGF0ZSgpLnZhbHVlT2YoKTtcbiAgICAgIG9mZnNldCA9IG5vdyArIG9mZnNldCAqIDEwMDA7XG4gICAgICBkYXRlID0gZGF0ZS52YWx1ZU9mKCk7XG5cbiAgICAgIHJldHVybiBkYXRlIDw9IG9mZnNldDtcbiAgICB9O1xuXG4gIC8qKlxuICAgKiBUcmllcyB0byBkZWNvZGUgYSBKV1QgdG9rZW4uXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBkZWNvZGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IHRva2VuXG4gICAqIEByZXR1cm4ge29iamVjdHxudWxsfVxuICAgKi9cbiAgSldULnByb3RvdHlwZS5kZWNvZGUgPSBmdW5jdGlvbih0b2tlbilcbiAgICB7XG4gICAgICB2YXIgJGxvZyA9IHRoaXMuJGluamVjdG9yLmdldCgnJGxvZycpO1xuXG4gICAgICB0cnkge1xuICAgICAgICB2YXIgcGFydHMgPSB0b2tlbi5zcGxpdCgnLicpO1xuICAgICAgICBpZiAocGFydHMubGVuZ3RoICE9PSAzKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdKV1QgbXVzdCBoYXZlIDMgcGFydHMhJyk7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgZGVjb2RlZCA9IHRoaXMuX2Jhc2U2NERlY29kZShwYXJ0c1sxXSk7XG4gICAgICAgIGlmICghZGVjb2RlZCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGRlY29kZSB0aGUgdG9rZW4hJyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYW5ndWxhci5mcm9tSnNvbihkZWNvZGVkKTtcbiAgICAgIH0gY2F0Y2goZSkge1xuICAgICAgICAkbG9nLmVycm9yKGUpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICB9O1xuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZXMgYW5kIGRlY29kZXMgYSBiYXNlNjQgdXJsLlxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAbWV0aG9kIF9iYXNlNjREZWNvZGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IGlucHV0XG4gICAqIEByZXR1cm4ge3N0cmluZ31cbiAgICovXG4gIEpXVC5wcm90b3R5cGUuX2Jhc2U2NERlY29kZSA9IGZ1bmN0aW9uKGlucHV0KVxuICAgIHtcbiAgICAgIHZhciAkd2luZG93ID0gdGhpcy4kaW5qZWN0b3IuZ2V0KCckd2luZG93Jyk7XG4gICAgICB2YXIgJGxvZyA9IHRoaXMuJGluamVjdG9yLmdldCgnJGxvZycpO1xuXG4gICAgICB2YXIgb3V0cHV0ID0gaW5wdXRcbiAgICAgICAgLnJlcGxhY2UoLy0vZywgJysnKVxuICAgICAgICAucmVwbGFjZSgvXy9nLCAnLycpO1xuXG4gICAgICB0cnl7XG4gICAgICAgIHN3aXRjaCAob3V0cHV0Lmxlbmd0aCAlIDQpIHtcbiAgICAgICAgICBjYXNlIDA6IHtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNhc2UgMjoge1xuICAgICAgICAgICAgb3V0cHV0ICs9ICc9PSc7IGJyZWFrO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIGNhc2UgMzoge1xuICAgICAgICAgICAgb3V0cHV0ICs9ICc9JzsgYnJlYWs7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbGxlZ2FsIGJhc2U2NHVybCBjb2RlIScpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBjYXRjaChlKSB7XG4gICAgICAgICRsb2cuZXJyb3IoZSk7XG4gICAgICAgIHJldHVybiAnJztcbiAgICAgIH1cblxuICAgICAgdmFyIGRlY29kZWQgPSAkd2luZG93LmF0b2Iob3V0cHV0KTtcbiAgICAgIHZhciBlc2NhcGVkID0gJHdpbmRvdy5lc2NhcGUoZGVjb2RlZCk7XG5cbiAgICAgIHJldHVybiAkd2luZG93LmRlY29kZVVSSUNvbXBvbmVudChlc2NhcGVkKTtcbiAgICB9O1xuXG4gIC8vXG4gIC8vIFJFR0lTVFJZXG4gIC8vXG4gIGFuZ3VsYXIubW9kdWxlKG1vZHVsZSkuc2VydmljZSgnand0JywgSldUKTtcblxufSkoQU5HVUxBUl9NT0RVTEUsIGFuZ3VsYXIpO1xuIl19

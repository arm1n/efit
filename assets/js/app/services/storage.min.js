/*!
 * eFit Website
 * An app for financial training in educational environments
 * http://www.e-fit.com
 * @author Armin Pfurtscheller
 * @version 1.0.0
 * Copyright 2017. MIT licensed.
 */
/* global ANGULAR_MODULE, angular */
(function(module, angular) {
  'use strict';

  /**
   * @varructor
   */
  var Storage = function($injector) {
    this.$injector = $injector;
  };

  Storage.MODE_COOKIES = 'COOKIES';
  Storage.MODE_STORAGE = 'STORAGE';
  Storage.$inject = ['$injector'];

  /**
   * Gets the current storage interface of the service.
   * Can be one of modes `COOKIES` or `STORAGE`. If no
   * one is given will default to local storage if it's
   * supported, otherwise falls back to cookies.
   *
   * @public
   * @method getProxy
   * @param {String} mode
   * @return {Object}
   */
  Storage.prototype.getProxy = function(mode) {
    switch (mode) {
      case Storage.MODE_COOKIES:
       return this._getCookieProxy();

      case Storage.MODE_STORAGE:
       return this._getLocalStorageProxy();

     default:
      if (this.supportsLocalStorage()) {
        return this._getLocalStorageProxy();
      }

      return this._getCookieProxy();
    }
  };

  /**
   * Checks if browser supports local storage.
   *
   * @public
   * @method supportsLocalStorage
   * @return {Boolean}
   */
  Storage.prototype.supportsLocalStorage = function() {
    var $window = this.$injector.get('$window');
    var storageProxy = $window.localStorage;
    var key = '__local__storage__feature__test';
    var val = '__local__storage__feature__test';

    try {
     storageProxy.setItem(key, val);
     storageProxy.removeItem(key);
    } catch (e) {
     return false;
    }

    return true;
  };

  /**
   * Stringifies and uri encodes a value.
   *
   * @private
   * @param {Mixed} value
   * @method _encode
   *
   * @return {String}
   */
  Storage.prototype._encode = function(value) {
    try {
     value = JSON.stringify(value);
    } catch (e) {
     value = undefined;
    }

    return encodeURIComponent(value);
  };

  /**
   * Decodes a stringified and uri encoded value.
   *
   * @private
   * @param {Mixed}
   * @method _decodeValue
   *
   * @return {Mixed}
   */
  Storage.prototype._decode = function(value) {
    var decoded;
    switch (typeof value) {
     case 'string':
       decoded = decodeURIComponent(value);
       try {
         decoded = JSON.parse(decoded);
       } catch (e) {
         /* noop */
       }
       break;
     default:
       decoded = undefined;
    }

    if (decoded === 'undefined') {
     decoded = undefined;
    }

    if (decoded === undefined) {
     decoded = null;
    }

    return decoded;
  };

  /**
   * Provides cookie storage proxy layer.
   *
   * @private
   * @method _getCookieProxy
   *
   * @return {Object}
   */
  Storage.prototype._getCookieProxy = function() {
    var documentProxy = this.$injector.get('$document');

    var me = this;
    var _getAll = function(parse) {
     var items = {};

     var cookies = documentProxy.cookie.split('; ');
     if (cookies.length === 1 && cookies[0] === '') {
       return items;
     }

     for (var i = 0; i < cookies.length; i++) {
       var cookie = cookies[i].split('=');
       if (!parse) {
         items[cookie[0]] = cookie[1];
         continue;
       }

       items[cookie[0]] = me._decode(cookie[1]);
     }

     return items;
    };

    var setCookie = function(key, value, expires, domain, path, secure) {
     value = me._encode(value);

     try {
       var date = new Date(expires);
       if (isNaN(date)) {
         var input = expires;
         expires = undefined;
         throw new Error('storage.js: "' + input + '" cannot be converted to date string!');
       }

       expires = date.toUTCString();
     } catch (e) {
       /* noop */
     }

     expires = expires ? expires : false;

     var cookie = key + '=' + value;
     cookie += expires ? ';expires='+expires : '';
     cookie += domain ? ';domain='+domain : '';
     cookie += path ? ';path='+path : '';
     cookie += secure ? ';secure' : '';

     documentProxy.cookie = cookie;
    };

    var getCookie = function(key) {
     var cookies = _getAll(false);
     if (cookies.hasOwnProperty(key)) {
       return me._decode(cookies[key]);
     }

     return null;
    };

    var getAllCookies = function() {
     return _getAll(true);
    };

    var removeCookie = function(key) {
     setCookie(key, '', -1);
    };

    var removeAllCookies = function() {
     for (var key in getAllCookies()) {
       removeCookie(key);
     }
    };

    return {
     getItem: getCookie,
     getAllItems: getAllCookies,
     setItem: setCookie,
     removeItem: removeCookie,
     removeAllItems: removeAllCookies
    };
  };

  /**
   * Provides local storage proxy layer.
   *
   * @private
   * @method _getLocalStorageProxy
   *
   * @return {Object}
   */
  Storage.prototype._getLocalStorageProxy = function() {
    var $window = this.$injector.get('$window');
    var storageProxy = $window.localStorage;

    var me = this;
    var setItem = function(key, value) {
     value = me._encode(value);
     storageProxy.setItem(key, value);
    };

    var getItem = function(key) {
     var value = storageProxy.getItem(key);
     return me._decode(value);
    };

    var getAllItems = function() {
     var items = {};

     for (var i = 0; i < storageProxy.length; i++) {
       var key = storageProxy.key(i);
       items[key] = getItem(key);
     }

     return items;
    };

    var removeItem = function(key) {
     storageProxy.removeItem(key);
    };

    var removeAllItems = function() {
     storageProxy.clear();
    };

    return {
     getItem: getItem,
     getAllItems: getAllItems,
     setItem: setItem,
     removeItem: removeItem,
     removeAllItems: removeAllItems
    };
  };

  //
  // REGISTRY
  //
  angular.module(module).service('storage', Storage);

})(ANGULAR_MODULE, angular);

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9zZXJ2aWNlcy9zdG9yYWdlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImFwcC9zZXJ2aWNlcy9zdG9yYWdlLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGdsb2JhbCBBTkdVTEFSX01PRFVMRSwgYW5ndWxhciAqL1xuKGZ1bmN0aW9uKG1vZHVsZSwgYW5ndWxhcikge1xuICAndXNlIHN0cmljdCc7XG5cbiAgLyoqXG4gICAqIEB2YXJydWN0b3JcbiAgICovXG4gIHZhciBTdG9yYWdlID0gZnVuY3Rpb24oJGluamVjdG9yKSB7XG4gICAgdGhpcy4kaW5qZWN0b3IgPSAkaW5qZWN0b3I7XG4gIH07XG5cbiAgU3RvcmFnZS5NT0RFX0NPT0tJRVMgPSAnQ09PS0lFUyc7XG4gIFN0b3JhZ2UuTU9ERV9TVE9SQUdFID0gJ1NUT1JBR0UnO1xuICBTdG9yYWdlLiRpbmplY3QgPSBbJyRpbmplY3RvciddO1xuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBjdXJyZW50IHN0b3JhZ2UgaW50ZXJmYWNlIG9mIHRoZSBzZXJ2aWNlLlxuICAgKiBDYW4gYmUgb25lIG9mIG1vZGVzIGBDT09LSUVTYCBvciBgU1RPUkFHRWAuIElmIG5vXG4gICAqIG9uZSBpcyBnaXZlbiB3aWxsIGRlZmF1bHQgdG8gbG9jYWwgc3RvcmFnZSBpZiBpdCdzXG4gICAqIHN1cHBvcnRlZCwgb3RoZXJ3aXNlIGZhbGxzIGJhY2sgdG8gY29va2llcy5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIGdldFByb3h5XG4gICAqIEBwYXJhbSB7U3RyaW5nfSBtb2RlXG4gICAqIEByZXR1cm4ge09iamVjdH1cbiAgICovXG4gIFN0b3JhZ2UucHJvdG90eXBlLmdldFByb3h5ID0gZnVuY3Rpb24obW9kZSkge1xuICAgIHN3aXRjaCAobW9kZSkge1xuICAgICAgY2FzZSBTdG9yYWdlLk1PREVfQ09PS0lFUzpcbiAgICAgICByZXR1cm4gdGhpcy5fZ2V0Q29va2llUHJveHkoKTtcblxuICAgICAgY2FzZSBTdG9yYWdlLk1PREVfU1RPUkFHRTpcbiAgICAgICByZXR1cm4gdGhpcy5fZ2V0TG9jYWxTdG9yYWdlUHJveHkoKTtcblxuICAgICBkZWZhdWx0OlxuICAgICAgaWYgKHRoaXMuc3VwcG9ydHNMb2NhbFN0b3JhZ2UoKSkge1xuICAgICAgICByZXR1cm4gdGhpcy5fZ2V0TG9jYWxTdG9yYWdlUHJveHkoKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHRoaXMuX2dldENvb2tpZVByb3h5KCk7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgYnJvd3NlciBzdXBwb3J0cyBsb2NhbCBzdG9yYWdlLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2Qgc3VwcG9ydHNMb2NhbFN0b3JhZ2VcbiAgICogQHJldHVybiB7Qm9vbGVhbn1cbiAgICovXG4gIFN0b3JhZ2UucHJvdG90eXBlLnN1cHBvcnRzTG9jYWxTdG9yYWdlID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyICR3aW5kb3cgPSB0aGlzLiRpbmplY3Rvci5nZXQoJyR3aW5kb3cnKTtcbiAgICB2YXIgc3RvcmFnZVByb3h5ID0gJHdpbmRvdy5sb2NhbFN0b3JhZ2U7XG4gICAgdmFyIGtleSA9ICdfX2xvY2FsX19zdG9yYWdlX19mZWF0dXJlX190ZXN0JztcbiAgICB2YXIgdmFsID0gJ19fbG9jYWxfX3N0b3JhZ2VfX2ZlYXR1cmVfX3Rlc3QnO1xuXG4gICAgdHJ5IHtcbiAgICAgc3RvcmFnZVByb3h5LnNldEl0ZW0oa2V5LCB2YWwpO1xuICAgICBzdG9yYWdlUHJveHkucmVtb3ZlSXRlbShrZXkpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTdHJpbmdpZmllcyBhbmQgdXJpIGVuY29kZXMgYSB2YWx1ZS5cbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQHBhcmFtIHtNaXhlZH0gdmFsdWVcbiAgICogQG1ldGhvZCBfZW5jb2RlXG4gICAqXG4gICAqIEByZXR1cm4ge1N0cmluZ31cbiAgICovXG4gIFN0b3JhZ2UucHJvdG90eXBlLl9lbmNvZGUgPSBmdW5jdGlvbih2YWx1ZSkge1xuICAgIHRyeSB7XG4gICAgIHZhbHVlID0gSlNPTi5zdHJpbmdpZnkodmFsdWUpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgdmFsdWUgPSB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIGVuY29kZVVSSUNvbXBvbmVudCh2YWx1ZSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIERlY29kZXMgYSBzdHJpbmdpZmllZCBhbmQgdXJpIGVuY29kZWQgdmFsdWUuXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEBwYXJhbSB7TWl4ZWR9XG4gICAqIEBtZXRob2QgX2RlY29kZVZhbHVlXG4gICAqXG4gICAqIEByZXR1cm4ge01peGVkfVxuICAgKi9cbiAgU3RvcmFnZS5wcm90b3R5cGUuX2RlY29kZSA9IGZ1bmN0aW9uKHZhbHVlKSB7XG4gICAgdmFyIGRlY29kZWQ7XG4gICAgc3dpdGNoICh0eXBlb2YgdmFsdWUpIHtcbiAgICAgY2FzZSAnc3RyaW5nJzpcbiAgICAgICBkZWNvZGVkID0gZGVjb2RlVVJJQ29tcG9uZW50KHZhbHVlKTtcbiAgICAgICB0cnkge1xuICAgICAgICAgZGVjb2RlZCA9IEpTT04ucGFyc2UoZGVjb2RlZCk7XG4gICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgLyogbm9vcCAqL1xuICAgICAgIH1cbiAgICAgICBicmVhaztcbiAgICAgZGVmYXVsdDpcbiAgICAgICBkZWNvZGVkID0gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGlmIChkZWNvZGVkID09PSAndW5kZWZpbmVkJykge1xuICAgICBkZWNvZGVkID0gdW5kZWZpbmVkO1xuICAgIH1cblxuICAgIGlmIChkZWNvZGVkID09PSB1bmRlZmluZWQpIHtcbiAgICAgZGVjb2RlZCA9IG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRlY29kZWQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIFByb3ZpZGVzIGNvb2tpZSBzdG9yYWdlIHByb3h5IGxheWVyLlxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAbWV0aG9kIF9nZXRDb29raWVQcm94eVxuICAgKlxuICAgKiBAcmV0dXJuIHtPYmplY3R9XG4gICAqL1xuICBTdG9yYWdlLnByb3RvdHlwZS5fZ2V0Q29va2llUHJveHkgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgZG9jdW1lbnRQcm94eSA9IHRoaXMuJGluamVjdG9yLmdldCgnJGRvY3VtZW50Jyk7XG5cbiAgICB2YXIgbWUgPSB0aGlzO1xuICAgIHZhciBfZ2V0QWxsID0gZnVuY3Rpb24ocGFyc2UpIHtcbiAgICAgdmFyIGl0ZW1zID0ge307XG5cbiAgICAgdmFyIGNvb2tpZXMgPSBkb2N1bWVudFByb3h5LmNvb2tpZS5zcGxpdCgnOyAnKTtcbiAgICAgaWYgKGNvb2tpZXMubGVuZ3RoID09PSAxICYmIGNvb2tpZXNbMF0gPT09ICcnKSB7XG4gICAgICAgcmV0dXJuIGl0ZW1zO1xuICAgICB9XG5cbiAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjb29raWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgdmFyIGNvb2tpZSA9IGNvb2tpZXNbaV0uc3BsaXQoJz0nKTtcbiAgICAgICBpZiAoIXBhcnNlKSB7XG4gICAgICAgICBpdGVtc1tjb29raWVbMF1dID0gY29va2llWzFdO1xuICAgICAgICAgY29udGludWU7XG4gICAgICAgfVxuXG4gICAgICAgaXRlbXNbY29va2llWzBdXSA9IG1lLl9kZWNvZGUoY29va2llWzFdKTtcbiAgICAgfVxuXG4gICAgIHJldHVybiBpdGVtcztcbiAgICB9O1xuXG4gICAgdmFyIHNldENvb2tpZSA9IGZ1bmN0aW9uKGtleSwgdmFsdWUsIGV4cGlyZXMsIGRvbWFpbiwgcGF0aCwgc2VjdXJlKSB7XG4gICAgIHZhbHVlID0gbWUuX2VuY29kZSh2YWx1ZSk7XG5cbiAgICAgdHJ5IHtcbiAgICAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKGV4cGlyZXMpO1xuICAgICAgIGlmIChpc05hTihkYXRlKSkge1xuICAgICAgICAgdmFyIGlucHV0ID0gZXhwaXJlcztcbiAgICAgICAgIGV4cGlyZXMgPSB1bmRlZmluZWQ7XG4gICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3N0b3JhZ2UuanM6IFwiJyArIGlucHV0ICsgJ1wiIGNhbm5vdCBiZSBjb252ZXJ0ZWQgdG8gZGF0ZSBzdHJpbmchJyk7XG4gICAgICAgfVxuXG4gICAgICAgZXhwaXJlcyA9IGRhdGUudG9VVENTdHJpbmcoKTtcbiAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgIC8qIG5vb3AgKi9cbiAgICAgfVxuXG4gICAgIGV4cGlyZXMgPSBleHBpcmVzID8gZXhwaXJlcyA6IGZhbHNlO1xuXG4gICAgIHZhciBjb29raWUgPSBrZXkgKyAnPScgKyB2YWx1ZTtcbiAgICAgY29va2llICs9IGV4cGlyZXMgPyAnO2V4cGlyZXM9JytleHBpcmVzIDogJyc7XG4gICAgIGNvb2tpZSArPSBkb21haW4gPyAnO2RvbWFpbj0nK2RvbWFpbiA6ICcnO1xuICAgICBjb29raWUgKz0gcGF0aCA/ICc7cGF0aD0nK3BhdGggOiAnJztcbiAgICAgY29va2llICs9IHNlY3VyZSA/ICc7c2VjdXJlJyA6ICcnO1xuXG4gICAgIGRvY3VtZW50UHJveHkuY29va2llID0gY29va2llO1xuICAgIH07XG5cbiAgICB2YXIgZ2V0Q29va2llID0gZnVuY3Rpb24oa2V5KSB7XG4gICAgIHZhciBjb29raWVzID0gX2dldEFsbChmYWxzZSk7XG4gICAgIGlmIChjb29raWVzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICByZXR1cm4gbWUuX2RlY29kZShjb29raWVzW2tleV0pO1xuICAgICB9XG5cbiAgICAgcmV0dXJuIG51bGw7XG4gICAgfTtcblxuICAgIHZhciBnZXRBbGxDb29raWVzID0gZnVuY3Rpb24oKSB7XG4gICAgIHJldHVybiBfZ2V0QWxsKHRydWUpO1xuICAgIH07XG5cbiAgICB2YXIgcmVtb3ZlQ29va2llID0gZnVuY3Rpb24oa2V5KSB7XG4gICAgIHNldENvb2tpZShrZXksICcnLCAtMSk7XG4gICAgfTtcblxuICAgIHZhciByZW1vdmVBbGxDb29raWVzID0gZnVuY3Rpb24oKSB7XG4gICAgIGZvciAodmFyIGtleSBpbiBnZXRBbGxDb29raWVzKCkpIHtcbiAgICAgICByZW1vdmVDb29raWUoa2V5KTtcbiAgICAgfVxuICAgIH07XG5cbiAgICByZXR1cm4ge1xuICAgICBnZXRJdGVtOiBnZXRDb29raWUsXG4gICAgIGdldEFsbEl0ZW1zOiBnZXRBbGxDb29raWVzLFxuICAgICBzZXRJdGVtOiBzZXRDb29raWUsXG4gICAgIHJlbW92ZUl0ZW06IHJlbW92ZUNvb2tpZSxcbiAgICAgcmVtb3ZlQWxsSXRlbXM6IHJlbW92ZUFsbENvb2tpZXNcbiAgICB9O1xuICB9O1xuXG4gIC8qKlxuICAgKiBQcm92aWRlcyBsb2NhbCBzdG9yYWdlIHByb3h5IGxheWVyLlxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAbWV0aG9kIF9nZXRMb2NhbFN0b3JhZ2VQcm94eVxuICAgKlxuICAgKiBAcmV0dXJuIHtPYmplY3R9XG4gICAqL1xuICBTdG9yYWdlLnByb3RvdHlwZS5fZ2V0TG9jYWxTdG9yYWdlUHJveHkgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgJHdpbmRvdyA9IHRoaXMuJGluamVjdG9yLmdldCgnJHdpbmRvdycpO1xuICAgIHZhciBzdG9yYWdlUHJveHkgPSAkd2luZG93LmxvY2FsU3RvcmFnZTtcblxuICAgIHZhciBtZSA9IHRoaXM7XG4gICAgdmFyIHNldEl0ZW0gPSBmdW5jdGlvbihrZXksIHZhbHVlKSB7XG4gICAgIHZhbHVlID0gbWUuX2VuY29kZSh2YWx1ZSk7XG4gICAgIHN0b3JhZ2VQcm94eS5zZXRJdGVtKGtleSwgdmFsdWUpO1xuICAgIH07XG5cbiAgICB2YXIgZ2V0SXRlbSA9IGZ1bmN0aW9uKGtleSkge1xuICAgICB2YXIgdmFsdWUgPSBzdG9yYWdlUHJveHkuZ2V0SXRlbShrZXkpO1xuICAgICByZXR1cm4gbWUuX2RlY29kZSh2YWx1ZSk7XG4gICAgfTtcblxuICAgIHZhciBnZXRBbGxJdGVtcyA9IGZ1bmN0aW9uKCkge1xuICAgICB2YXIgaXRlbXMgPSB7fTtcblxuICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHN0b3JhZ2VQcm94eS5sZW5ndGg7IGkrKykge1xuICAgICAgIHZhciBrZXkgPSBzdG9yYWdlUHJveHkua2V5KGkpO1xuICAgICAgIGl0ZW1zW2tleV0gPSBnZXRJdGVtKGtleSk7XG4gICAgIH1cblxuICAgICByZXR1cm4gaXRlbXM7XG4gICAgfTtcblxuICAgIHZhciByZW1vdmVJdGVtID0gZnVuY3Rpb24oa2V5KSB7XG4gICAgIHN0b3JhZ2VQcm94eS5yZW1vdmVJdGVtKGtleSk7XG4gICAgfTtcblxuICAgIHZhciByZW1vdmVBbGxJdGVtcyA9IGZ1bmN0aW9uKCkge1xuICAgICBzdG9yYWdlUHJveHkuY2xlYXIoKTtcbiAgICB9O1xuXG4gICAgcmV0dXJuIHtcbiAgICAgZ2V0SXRlbTogZ2V0SXRlbSxcbiAgICAgZ2V0QWxsSXRlbXM6IGdldEFsbEl0ZW1zLFxuICAgICBzZXRJdGVtOiBzZXRJdGVtLFxuICAgICByZW1vdmVJdGVtOiByZW1vdmVJdGVtLFxuICAgICByZW1vdmVBbGxJdGVtczogcmVtb3ZlQWxsSXRlbXNcbiAgICB9O1xuICB9O1xuXG4gIC8vXG4gIC8vIFJFR0lTVFJZXG4gIC8vXG4gIGFuZ3VsYXIubW9kdWxlKG1vZHVsZSkuc2VydmljZSgnc3RvcmFnZScsIFN0b3JhZ2UpO1xuXG59KShBTkdVTEFSX01PRFVMRSwgYW5ndWxhcik7XG4iXX0=

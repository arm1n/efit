/*!
 * eFit Website
 * An app for financial training in educational environments
 * http://www.e-fit.com
 * @author Armin Pfurtscheller
 * @version 1.0.0
 * Copyright 2017. MIT licensed.
 */
/* global ANGULAR_MODULE, angular */
(function(module, angular) {
  'use strict';

  // --------------------------------------------------
  // Form Field
  // --------------------------------------------------

  //
  // CONTROLLER
  //

  /**
   * @constructor
   */
  var FormField = function($scope, $element, $attrs, $transclude, $timeout)
    {
      this.$scope = $scope;
      this.$attrs = $attrs;
      this.$element = $element;
      this.$timeout = $timeout;
      this.$transclude = $transclude;

      this._transcludeElements = [];
      this._transcludeScopes = [];
      this._cloneDefault = null;
      this._cloneLabel = null;
      this._unlisten = [];
      this._unwatch = [];
    };

  FormField.$inject = ['$scope', '$element', '$attrs', '$transclude', '$timeout'];

  //
  // PROPERTIES
  //

  /** @var {string} id Dom id form element. */
  FormField.prototype.id = '';

  /** @var {string} label Label of form element. */
  FormField.prototype.label = '';

  /** @var {ngModelController} model Added `ngModel` controller. */
  FormField.prototype.ngModel = null;

  /** @var {boolean} resetEmpty If validation resets on empty model. */
  FormField.prototype.resetEmpty = true;

  /** @var {boolean} showMessages True if `ngMessages` are visible. */
  FormField.prototype.showMessages = false;

  /** @var {string} labelClass Class to append to label. */
  FormField.prototype.labelClass = 'uk-form-label';

  /** @var {string} failureClass Class to append on failure. */
  FormField.prototype.failureClass = 'uk-form-danger';

  /** @var {string} successClass Class to append on success. */
  FormField.prototype.successClass = 'uk-form-success';

  //
  // METHODS
  //

  /**
   * Renders custom transclusion (form element) and
   * sets up watchers as well as clean up methods.
   *
   * @public
   * @method $onInit
   * @return {Void}
   */
  FormField.prototype.$onInit = function()
    {
      // create dom id from `name` and $scope id
      // controller properties are only available
      // in $onInit() callback from Angular 1.5.x
      this.id = 'form-field-' + this.$scope.$id;

      // add watch properties
      this._addWatches();

      // transclude contents
      this._transclude();
    };

  /**
   * Removes transcluded elements, scope and watches.
   *
   * @public
   * @method $onDestroy
   * @return {void}
   */
  FormField.prototype.$onDestroy = function()
    {
      angular.forEach(this._transcludeElements, function(element){
        element.remove();
      });

      angular.forEach(this._transcludeScopes, function(scope){
        scope.$destroy();
      });

      angular.forEach(this._unlisten, function(unlisten){
        unlisten();
      });

      angular.forEach(this._unwatch, function(unwatch){
        unwatch();
      });
    };

  /**
   * Sets model controller from transcluded form
   * element using the `ng-model` attribute and
   * the `form-field-model` helper component.
   *
   * @public
   * @method setModel
   * @param {NgModelController} ngModel
   * @return {void}
   */
  FormField.prototype.setModel = function(ngModel)
    {
      this.ngModel = ngModel;
    };

  /**
   * Updates validation depending on `ngModel.$valid`.
   *
   * @private
   * @method _update
   * @return {void}
   */
  FormField.prototype._update = function()
    {
      if (this.ngModel.$valid) {
        this._cloneDefault.removeClass(this.failureClass);
        this._cloneDefault.addClass(this.successClass);
      } else {
        this._cloneDefault.removeClass(this.successClass);
        this._cloneDefault.addClass(this.failureClass);
      }

      this.showMessages = this.ngModel.$invalid;
    };

  /**
   * Resets corresponding validation properties.
   *
   * @private
   * @method _reset
   * @return {boolean}
   */
  FormField.prototype._reset = function()
    {
      this._cloneDefault.removeClass(this.failureClass);
      this._cloneDefault.removeClass(this.successClass);
      this.ngModel.$setUntouched();
      this.showMessages = false;
    };

  /**
   * Adds scope watches for `isValid()` and `isInvalid()`.
   *
   * @private
   * @method _addWatches
   * @return {void}
   */
  FormField.prototype._addWatches = function()
    {
      var me = this;

      // observes `ngModel` controller for changing any
      // of its validation properties such as `$valid`
      var unwatchModel = this.$scope.$watchCollection(
        'formFieldController.ngModel',
        function(newModel, oldModel)
        {
          // ignore initial invocation
          if (newModel === oldModel) {
            return;
          }

          // as long as model hasn't been
          // touched no validation's made
          if (!newModel.$touched) {
              return;
          }

          // wait for async validators
          if (newModel.$pending) {
            return;
          }

          // if no view value is present
          // reset all validation props!
          if (!newModel.$viewValue) {
            if (me.resetEmpty) {
              me._reset();
              return;
            }
          }

          me._update();
        }
      );

      this._unwatch.push(unwatchModel);
    };

  /**
   * Transcludes `default` and `label` slot programmatically
   * to append custom attributes and events to dom elements.
   *
   * @private
   * @method _transclude
   * @return {void}
   */
  FormField.prototype._transclude = function()
    {
      var me = this;

      // adds `id` attribute to be focues by <label>
      var transcludeDefault = function(clone, scope)
      {
        var domId = '#default-' + me.id;
        var template = angular.element(domId);

        clone.attr('id', me.id);

        template.replaceWith(clone);

        me._cloneDefault = clone;

        me._transcludeScopes.push(scope);
        me._transcludeElements.push(clone);
      };

      // adds `labelClass` and sets `for` attribute
      // for <label> in order to auto focus element
      var transcludeLabel = function(clone, scope)
      {
        var domId = '#label-' + me.id;
        var template = angular.element(domId);

        clone.attr('for', me.id);
        clone.addClass(me.labelClass);

        template.replaceWith(clone);

        me._cloneLabel = clone;

        me._transcludeScopes.push(scope);
        me._transcludeElements.push(clone);
      };

      // wait for dom to be ready before transclude
      var timeout = function()
      {
        me.$transclude(transcludeDefault, null, null);
        me.$transclude(transcludeLabel, null, 'label');
      };

      this.$timeout(timeout);
    };

  //
  // REGISTRY
  //
  angular.module(ANGULAR_MODULE).directive('formField',function() {
    return {
      scope: {
          name: '=formField',
          resetEmpty: '=?formFieldResetEmpty',
          labelClass: '=?formFieldLabelClass',
          failureClass: '=?formFieldFailureClass',
          successClass: '=?formFieldSuccessClass'
      },
      transclude: {
        label: '?label',
        messageUrl: '?messageUrl',
        messageEmail: '?messageEmail',
        messageNumber: '?messageNumber',
        messagePattern: '?messagePattern',
        messageRequired: '?messageRequired',
        messageMinlength: '?messageMinlength',
        messageMaxlength: '?messageMaxlength',
        messagesCustom: '?messagesCustom'
      },
      restrict: 'A',
      controller: FormField,
      bindToController: true,
      controllerAs: 'formFieldController',
      templateUrl: 'views/directives/form-field.html'
    };
  });

  // --------------------------------------------------
  // Form Field Model
  // --------------------------------------------------

  /**
   * @constructor
   */
  var FormFieldModel = function($scope, $attrs, $element, $log) {
    this.$log = $log;
    this.$scope = $scope;
    this.$attrs = $attrs;
    this.$element = $element;
  };

  FormFieldModel.$inject = ['$scope', '$attrs', '$element', '$log'];

  //
  // METHODS
  //

  /**
   * Registers `ngModel` on `formField` controller.
   *
   * @public
   * @method $onInit
   * @return {Void}
   */
  FormFieldModel.prototype.$onInit = function()
    {
      if (!this.formField) {
        this.$log.warn('formFieldModel: No form field controller found!');
        return;
      }

      this.formField.setModel(this.ngModel);
    };

  //
  // REGISTRY
  //
  angular.module(module).directive('formFieldModel', function(){
    return {
      restrict: 'A',
      require: {
        'ngModel': 'ngModel',
        'formField': '^?formField'
      },
      bindToController: true,
      controller: FormFieldModel
    };
  });

})(ANGULAR_MODULE, angular);

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9kaXJlY3RpdmVzL2Zvcm0tZmllbGQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImFwcC9kaXJlY3RpdmVzL2Zvcm0tZmllbGQubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZ2xvYmFsIEFOR1VMQVJfTU9EVUxFLCBhbmd1bGFyICovXG4oZnVuY3Rpb24obW9kdWxlLCBhbmd1bGFyKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBGb3JtIEZpZWxkXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgLy9cbiAgLy8gQ09OVFJPTExFUlxuICAvL1xuXG4gIC8qKlxuICAgKiBAY29uc3RydWN0b3JcbiAgICovXG4gIHZhciBGb3JtRmllbGQgPSBmdW5jdGlvbigkc2NvcGUsICRlbGVtZW50LCAkYXR0cnMsICR0cmFuc2NsdWRlLCAkdGltZW91dClcbiAgICB7XG4gICAgICB0aGlzLiRzY29wZSA9ICRzY29wZTtcbiAgICAgIHRoaXMuJGF0dHJzID0gJGF0dHJzO1xuICAgICAgdGhpcy4kZWxlbWVudCA9ICRlbGVtZW50O1xuICAgICAgdGhpcy4kdGltZW91dCA9ICR0aW1lb3V0O1xuICAgICAgdGhpcy4kdHJhbnNjbHVkZSA9ICR0cmFuc2NsdWRlO1xuXG4gICAgICB0aGlzLl90cmFuc2NsdWRlRWxlbWVudHMgPSBbXTtcbiAgICAgIHRoaXMuX3RyYW5zY2x1ZGVTY29wZXMgPSBbXTtcbiAgICAgIHRoaXMuX2Nsb25lRGVmYXVsdCA9IG51bGw7XG4gICAgICB0aGlzLl9jbG9uZUxhYmVsID0gbnVsbDtcbiAgICAgIHRoaXMuX3VubGlzdGVuID0gW107XG4gICAgICB0aGlzLl91bndhdGNoID0gW107XG4gICAgfTtcblxuICBGb3JtRmllbGQuJGluamVjdCA9IFsnJHNjb3BlJywgJyRlbGVtZW50JywgJyRhdHRycycsICckdHJhbnNjbHVkZScsICckdGltZW91dCddO1xuXG4gIC8vXG4gIC8vIFBST1BFUlRJRVNcbiAgLy9cblxuICAvKiogQHZhciB7c3RyaW5nfSBpZCBEb20gaWQgZm9ybSBlbGVtZW50LiAqL1xuICBGb3JtRmllbGQucHJvdG90eXBlLmlkID0gJyc7XG5cbiAgLyoqIEB2YXIge3N0cmluZ30gbGFiZWwgTGFiZWwgb2YgZm9ybSBlbGVtZW50LiAqL1xuICBGb3JtRmllbGQucHJvdG90eXBlLmxhYmVsID0gJyc7XG5cbiAgLyoqIEB2YXIge25nTW9kZWxDb250cm9sbGVyfSBtb2RlbCBBZGRlZCBgbmdNb2RlbGAgY29udHJvbGxlci4gKi9cbiAgRm9ybUZpZWxkLnByb3RvdHlwZS5uZ01vZGVsID0gbnVsbDtcblxuICAvKiogQHZhciB7Ym9vbGVhbn0gcmVzZXRFbXB0eSBJZiB2YWxpZGF0aW9uIHJlc2V0cyBvbiBlbXB0eSBtb2RlbC4gKi9cbiAgRm9ybUZpZWxkLnByb3RvdHlwZS5yZXNldEVtcHR5ID0gdHJ1ZTtcblxuICAvKiogQHZhciB7Ym9vbGVhbn0gc2hvd01lc3NhZ2VzIFRydWUgaWYgYG5nTWVzc2FnZXNgIGFyZSB2aXNpYmxlLiAqL1xuICBGb3JtRmllbGQucHJvdG90eXBlLnNob3dNZXNzYWdlcyA9IGZhbHNlO1xuXG4gIC8qKiBAdmFyIHtzdHJpbmd9IGxhYmVsQ2xhc3MgQ2xhc3MgdG8gYXBwZW5kIHRvIGxhYmVsLiAqL1xuICBGb3JtRmllbGQucHJvdG90eXBlLmxhYmVsQ2xhc3MgPSAndWstZm9ybS1sYWJlbCc7XG5cbiAgLyoqIEB2YXIge3N0cmluZ30gZmFpbHVyZUNsYXNzIENsYXNzIHRvIGFwcGVuZCBvbiBmYWlsdXJlLiAqL1xuICBGb3JtRmllbGQucHJvdG90eXBlLmZhaWx1cmVDbGFzcyA9ICd1ay1mb3JtLWRhbmdlcic7XG5cbiAgLyoqIEB2YXIge3N0cmluZ30gc3VjY2Vzc0NsYXNzIENsYXNzIHRvIGFwcGVuZCBvbiBzdWNjZXNzLiAqL1xuICBGb3JtRmllbGQucHJvdG90eXBlLnN1Y2Nlc3NDbGFzcyA9ICd1ay1mb3JtLXN1Y2Nlc3MnO1xuXG4gIC8vXG4gIC8vIE1FVEhPRFNcbiAgLy9cblxuICAvKipcbiAgICogUmVuZGVycyBjdXN0b20gdHJhbnNjbHVzaW9uIChmb3JtIGVsZW1lbnQpIGFuZFxuICAgKiBzZXRzIHVwIHdhdGNoZXJzIGFzIHdlbGwgYXMgY2xlYW4gdXAgbWV0aG9kcy5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kICRvbkluaXRcbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEZvcm1GaWVsZC5wcm90b3R5cGUuJG9uSW5pdCA9IGZ1bmN0aW9uKClcbiAgICB7XG4gICAgICAvLyBjcmVhdGUgZG9tIGlkIGZyb20gYG5hbWVgIGFuZCAkc2NvcGUgaWRcbiAgICAgIC8vIGNvbnRyb2xsZXIgcHJvcGVydGllcyBhcmUgb25seSBhdmFpbGFibGVcbiAgICAgIC8vIGluICRvbkluaXQoKSBjYWxsYmFjayBmcm9tIEFuZ3VsYXIgMS41LnhcbiAgICAgIHRoaXMuaWQgPSAnZm9ybS1maWVsZC0nICsgdGhpcy4kc2NvcGUuJGlkO1xuXG4gICAgICAvLyBhZGQgd2F0Y2ggcHJvcGVydGllc1xuICAgICAgdGhpcy5fYWRkV2F0Y2hlcygpO1xuXG4gICAgICAvLyB0cmFuc2NsdWRlIGNvbnRlbnRzXG4gICAgICB0aGlzLl90cmFuc2NsdWRlKCk7XG4gICAgfTtcblxuICAvKipcbiAgICogUmVtb3ZlcyB0cmFuc2NsdWRlZCBlbGVtZW50cywgc2NvcGUgYW5kIHdhdGNoZXMuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCAkb25EZXN0cm95XG4gICAqIEByZXR1cm4ge3ZvaWR9XG4gICAqL1xuICBGb3JtRmllbGQucHJvdG90eXBlLiRvbkRlc3Ryb3kgPSBmdW5jdGlvbigpXG4gICAge1xuICAgICAgYW5ndWxhci5mb3JFYWNoKHRoaXMuX3RyYW5zY2x1ZGVFbGVtZW50cywgZnVuY3Rpb24oZWxlbWVudCl7XG4gICAgICAgIGVsZW1lbnQucmVtb3ZlKCk7XG4gICAgICB9KTtcblxuICAgICAgYW5ndWxhci5mb3JFYWNoKHRoaXMuX3RyYW5zY2x1ZGVTY29wZXMsIGZ1bmN0aW9uKHNjb3BlKXtcbiAgICAgICAgc2NvcGUuJGRlc3Ryb3koKTtcbiAgICAgIH0pO1xuXG4gICAgICBhbmd1bGFyLmZvckVhY2godGhpcy5fdW5saXN0ZW4sIGZ1bmN0aW9uKHVubGlzdGVuKXtcbiAgICAgICAgdW5saXN0ZW4oKTtcbiAgICAgIH0pO1xuXG4gICAgICBhbmd1bGFyLmZvckVhY2godGhpcy5fdW53YXRjaCwgZnVuY3Rpb24odW53YXRjaCl7XG4gICAgICAgIHVud2F0Y2goKTtcbiAgICAgIH0pO1xuICAgIH07XG5cbiAgLyoqXG4gICAqIFNldHMgbW9kZWwgY29udHJvbGxlciBmcm9tIHRyYW5zY2x1ZGVkIGZvcm1cbiAgICogZWxlbWVudCB1c2luZyB0aGUgYG5nLW1vZGVsYCBhdHRyaWJ1dGUgYW5kXG4gICAqIHRoZSBgZm9ybS1maWVsZC1tb2RlbGAgaGVscGVyIGNvbXBvbmVudC5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIHNldE1vZGVsXG4gICAqIEBwYXJhbSB7TmdNb2RlbENvbnRyb2xsZXJ9IG5nTW9kZWxcbiAgICogQHJldHVybiB7dm9pZH1cbiAgICovXG4gIEZvcm1GaWVsZC5wcm90b3R5cGUuc2V0TW9kZWwgPSBmdW5jdGlvbihuZ01vZGVsKVxuICAgIHtcbiAgICAgIHRoaXMubmdNb2RlbCA9IG5nTW9kZWw7XG4gICAgfTtcblxuICAvKipcbiAgICogVXBkYXRlcyB2YWxpZGF0aW9uIGRlcGVuZGluZyBvbiBgbmdNb2RlbC4kdmFsaWRgLlxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAbWV0aG9kIF91cGRhdGVcbiAgICogQHJldHVybiB7dm9pZH1cbiAgICovXG4gIEZvcm1GaWVsZC5wcm90b3R5cGUuX3VwZGF0ZSA9IGZ1bmN0aW9uKClcbiAgICB7XG4gICAgICBpZiAodGhpcy5uZ01vZGVsLiR2YWxpZCkge1xuICAgICAgICB0aGlzLl9jbG9uZURlZmF1bHQucmVtb3ZlQ2xhc3ModGhpcy5mYWlsdXJlQ2xhc3MpO1xuICAgICAgICB0aGlzLl9jbG9uZURlZmF1bHQuYWRkQ2xhc3ModGhpcy5zdWNjZXNzQ2xhc3MpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5fY2xvbmVEZWZhdWx0LnJlbW92ZUNsYXNzKHRoaXMuc3VjY2Vzc0NsYXNzKTtcbiAgICAgICAgdGhpcy5fY2xvbmVEZWZhdWx0LmFkZENsYXNzKHRoaXMuZmFpbHVyZUNsYXNzKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5zaG93TWVzc2FnZXMgPSB0aGlzLm5nTW9kZWwuJGludmFsaWQ7XG4gICAgfTtcblxuICAvKipcbiAgICogUmVzZXRzIGNvcnJlc3BvbmRpbmcgdmFsaWRhdGlvbiBwcm9wZXJ0aWVzLlxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAbWV0aG9kIF9yZXNldFxuICAgKiBAcmV0dXJuIHtib29sZWFufVxuICAgKi9cbiAgRm9ybUZpZWxkLnByb3RvdHlwZS5fcmVzZXQgPSBmdW5jdGlvbigpXG4gICAge1xuICAgICAgdGhpcy5fY2xvbmVEZWZhdWx0LnJlbW92ZUNsYXNzKHRoaXMuZmFpbHVyZUNsYXNzKTtcbiAgICAgIHRoaXMuX2Nsb25lRGVmYXVsdC5yZW1vdmVDbGFzcyh0aGlzLnN1Y2Nlc3NDbGFzcyk7XG4gICAgICB0aGlzLm5nTW9kZWwuJHNldFVudG91Y2hlZCgpO1xuICAgICAgdGhpcy5zaG93TWVzc2FnZXMgPSBmYWxzZTtcbiAgICB9O1xuXG4gIC8qKlxuICAgKiBBZGRzIHNjb3BlIHdhdGNoZXMgZm9yIGBpc1ZhbGlkKClgIGFuZCBgaXNJbnZhbGlkKClgLlxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAbWV0aG9kIF9hZGRXYXRjaGVzXG4gICAqIEByZXR1cm4ge3ZvaWR9XG4gICAqL1xuICBGb3JtRmllbGQucHJvdG90eXBlLl9hZGRXYXRjaGVzID0gZnVuY3Rpb24oKVxuICAgIHtcbiAgICAgIHZhciBtZSA9IHRoaXM7XG5cbiAgICAgIC8vIG9ic2VydmVzIGBuZ01vZGVsYCBjb250cm9sbGVyIGZvciBjaGFuZ2luZyBhbnlcbiAgICAgIC8vIG9mIGl0cyB2YWxpZGF0aW9uIHByb3BlcnRpZXMgc3VjaCBhcyBgJHZhbGlkYFxuICAgICAgdmFyIHVud2F0Y2hNb2RlbCA9IHRoaXMuJHNjb3BlLiR3YXRjaENvbGxlY3Rpb24oXG4gICAgICAgICdmb3JtRmllbGRDb250cm9sbGVyLm5nTW9kZWwnLFxuICAgICAgICBmdW5jdGlvbihuZXdNb2RlbCwgb2xkTW9kZWwpXG4gICAgICAgIHtcbiAgICAgICAgICAvLyBpZ25vcmUgaW5pdGlhbCBpbnZvY2F0aW9uXG4gICAgICAgICAgaWYgKG5ld01vZGVsID09PSBvbGRNb2RlbCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIGFzIGxvbmcgYXMgbW9kZWwgaGFzbid0IGJlZW5cbiAgICAgICAgICAvLyB0b3VjaGVkIG5vIHZhbGlkYXRpb24ncyBtYWRlXG4gICAgICAgICAgaWYgKCFuZXdNb2RlbC4kdG91Y2hlZCkge1xuICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgLy8gd2FpdCBmb3IgYXN5bmMgdmFsaWRhdG9yc1xuICAgICAgICAgIGlmIChuZXdNb2RlbC4kcGVuZGluZykge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIC8vIGlmIG5vIHZpZXcgdmFsdWUgaXMgcHJlc2VudFxuICAgICAgICAgIC8vIHJlc2V0IGFsbCB2YWxpZGF0aW9uIHByb3BzIVxuICAgICAgICAgIGlmICghbmV3TW9kZWwuJHZpZXdWYWx1ZSkge1xuICAgICAgICAgICAgaWYgKG1lLnJlc2V0RW1wdHkpIHtcbiAgICAgICAgICAgICAgbWUuX3Jlc2V0KCk7XG4gICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICBtZS5fdXBkYXRlKCk7XG4gICAgICAgIH1cbiAgICAgICk7XG5cbiAgICAgIHRoaXMuX3Vud2F0Y2gucHVzaCh1bndhdGNoTW9kZWwpO1xuICAgIH07XG5cbiAgLyoqXG4gICAqIFRyYW5zY2x1ZGVzIGBkZWZhdWx0YCBhbmQgYGxhYmVsYCBzbG90IHByb2dyYW1tYXRpY2FsbHlcbiAgICogdG8gYXBwZW5kIGN1c3RvbSBhdHRyaWJ1dGVzIGFuZCBldmVudHMgdG8gZG9tIGVsZW1lbnRzLlxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAbWV0aG9kIF90cmFuc2NsdWRlXG4gICAqIEByZXR1cm4ge3ZvaWR9XG4gICAqL1xuICBGb3JtRmllbGQucHJvdG90eXBlLl90cmFuc2NsdWRlID0gZnVuY3Rpb24oKVxuICAgIHtcbiAgICAgIHZhciBtZSA9IHRoaXM7XG5cbiAgICAgIC8vIGFkZHMgYGlkYCBhdHRyaWJ1dGUgdG8gYmUgZm9jdWVzIGJ5IDxsYWJlbD5cbiAgICAgIHZhciB0cmFuc2NsdWRlRGVmYXVsdCA9IGZ1bmN0aW9uKGNsb25lLCBzY29wZSlcbiAgICAgIHtcbiAgICAgICAgdmFyIGRvbUlkID0gJyNkZWZhdWx0LScgKyBtZS5pZDtcbiAgICAgICAgdmFyIHRlbXBsYXRlID0gYW5ndWxhci5lbGVtZW50KGRvbUlkKTtcblxuICAgICAgICBjbG9uZS5hdHRyKCdpZCcsIG1lLmlkKTtcblxuICAgICAgICB0ZW1wbGF0ZS5yZXBsYWNlV2l0aChjbG9uZSk7XG5cbiAgICAgICAgbWUuX2Nsb25lRGVmYXVsdCA9IGNsb25lO1xuXG4gICAgICAgIG1lLl90cmFuc2NsdWRlU2NvcGVzLnB1c2goc2NvcGUpO1xuICAgICAgICBtZS5fdHJhbnNjbHVkZUVsZW1lbnRzLnB1c2goY2xvbmUpO1xuICAgICAgfTtcblxuICAgICAgLy8gYWRkcyBgbGFiZWxDbGFzc2AgYW5kIHNldHMgYGZvcmAgYXR0cmlidXRlXG4gICAgICAvLyBmb3IgPGxhYmVsPiBpbiBvcmRlciB0byBhdXRvIGZvY3VzIGVsZW1lbnRcbiAgICAgIHZhciB0cmFuc2NsdWRlTGFiZWwgPSBmdW5jdGlvbihjbG9uZSwgc2NvcGUpXG4gICAgICB7XG4gICAgICAgIHZhciBkb21JZCA9ICcjbGFiZWwtJyArIG1lLmlkO1xuICAgICAgICB2YXIgdGVtcGxhdGUgPSBhbmd1bGFyLmVsZW1lbnQoZG9tSWQpO1xuXG4gICAgICAgIGNsb25lLmF0dHIoJ2ZvcicsIG1lLmlkKTtcbiAgICAgICAgY2xvbmUuYWRkQ2xhc3MobWUubGFiZWxDbGFzcyk7XG5cbiAgICAgICAgdGVtcGxhdGUucmVwbGFjZVdpdGgoY2xvbmUpO1xuXG4gICAgICAgIG1lLl9jbG9uZUxhYmVsID0gY2xvbmU7XG5cbiAgICAgICAgbWUuX3RyYW5zY2x1ZGVTY29wZXMucHVzaChzY29wZSk7XG4gICAgICAgIG1lLl90cmFuc2NsdWRlRWxlbWVudHMucHVzaChjbG9uZSk7XG4gICAgICB9O1xuXG4gICAgICAvLyB3YWl0IGZvciBkb20gdG8gYmUgcmVhZHkgYmVmb3JlIHRyYW5zY2x1ZGVcbiAgICAgIHZhciB0aW1lb3V0ID0gZnVuY3Rpb24oKVxuICAgICAge1xuICAgICAgICBtZS4kdHJhbnNjbHVkZSh0cmFuc2NsdWRlRGVmYXVsdCwgbnVsbCwgbnVsbCk7XG4gICAgICAgIG1lLiR0cmFuc2NsdWRlKHRyYW5zY2x1ZGVMYWJlbCwgbnVsbCwgJ2xhYmVsJyk7XG4gICAgICB9O1xuXG4gICAgICB0aGlzLiR0aW1lb3V0KHRpbWVvdXQpO1xuICAgIH07XG5cbiAgLy9cbiAgLy8gUkVHSVNUUllcbiAgLy9cbiAgYW5ndWxhci5tb2R1bGUoQU5HVUxBUl9NT0RVTEUpLmRpcmVjdGl2ZSgnZm9ybUZpZWxkJyxmdW5jdGlvbigpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc2NvcGU6IHtcbiAgICAgICAgICBuYW1lOiAnPWZvcm1GaWVsZCcsXG4gICAgICAgICAgcmVzZXRFbXB0eTogJz0/Zm9ybUZpZWxkUmVzZXRFbXB0eScsXG4gICAgICAgICAgbGFiZWxDbGFzczogJz0/Zm9ybUZpZWxkTGFiZWxDbGFzcycsXG4gICAgICAgICAgZmFpbHVyZUNsYXNzOiAnPT9mb3JtRmllbGRGYWlsdXJlQ2xhc3MnLFxuICAgICAgICAgIHN1Y2Nlc3NDbGFzczogJz0/Zm9ybUZpZWxkU3VjY2Vzc0NsYXNzJ1xuICAgICAgfSxcbiAgICAgIHRyYW5zY2x1ZGU6IHtcbiAgICAgICAgbGFiZWw6ICc/bGFiZWwnLFxuICAgICAgICBtZXNzYWdlVXJsOiAnP21lc3NhZ2VVcmwnLFxuICAgICAgICBtZXNzYWdlRW1haWw6ICc/bWVzc2FnZUVtYWlsJyxcbiAgICAgICAgbWVzc2FnZU51bWJlcjogJz9tZXNzYWdlTnVtYmVyJyxcbiAgICAgICAgbWVzc2FnZVBhdHRlcm46ICc/bWVzc2FnZVBhdHRlcm4nLFxuICAgICAgICBtZXNzYWdlUmVxdWlyZWQ6ICc/bWVzc2FnZVJlcXVpcmVkJyxcbiAgICAgICAgbWVzc2FnZU1pbmxlbmd0aDogJz9tZXNzYWdlTWlubGVuZ3RoJyxcbiAgICAgICAgbWVzc2FnZU1heGxlbmd0aDogJz9tZXNzYWdlTWF4bGVuZ3RoJyxcbiAgICAgICAgbWVzc2FnZXNDdXN0b206ICc/bWVzc2FnZXNDdXN0b20nXG4gICAgICB9LFxuICAgICAgcmVzdHJpY3Q6ICdBJyxcbiAgICAgIGNvbnRyb2xsZXI6IEZvcm1GaWVsZCxcbiAgICAgIGJpbmRUb0NvbnRyb2xsZXI6IHRydWUsXG4gICAgICBjb250cm9sbGVyQXM6ICdmb3JtRmllbGRDb250cm9sbGVyJyxcbiAgICAgIHRlbXBsYXRlVXJsOiAndmlld3MvZGlyZWN0aXZlcy9mb3JtLWZpZWxkLmh0bWwnXG4gICAgfTtcbiAgfSk7XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gRm9ybSBGaWVsZCBNb2RlbFxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4gIC8qKlxuICAgKiBAY29uc3RydWN0b3JcbiAgICovXG4gIHZhciBGb3JtRmllbGRNb2RlbCA9IGZ1bmN0aW9uKCRzY29wZSwgJGF0dHJzLCAkZWxlbWVudCwgJGxvZykge1xuICAgIHRoaXMuJGxvZyA9ICRsb2c7XG4gICAgdGhpcy4kc2NvcGUgPSAkc2NvcGU7XG4gICAgdGhpcy4kYXR0cnMgPSAkYXR0cnM7XG4gICAgdGhpcy4kZWxlbWVudCA9ICRlbGVtZW50O1xuICB9O1xuXG4gIEZvcm1GaWVsZE1vZGVsLiRpbmplY3QgPSBbJyRzY29wZScsICckYXR0cnMnLCAnJGVsZW1lbnQnLCAnJGxvZyddO1xuXG4gIC8vXG4gIC8vIE1FVEhPRFNcbiAgLy9cblxuICAvKipcbiAgICogUmVnaXN0ZXJzIGBuZ01vZGVsYCBvbiBgZm9ybUZpZWxkYCBjb250cm9sbGVyLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgJG9uSW5pdFxuICAgKiBAcmV0dXJuIHtWb2lkfVxuICAgKi9cbiAgRm9ybUZpZWxkTW9kZWwucHJvdG90eXBlLiRvbkluaXQgPSBmdW5jdGlvbigpXG4gICAge1xuICAgICAgaWYgKCF0aGlzLmZvcm1GaWVsZCkge1xuICAgICAgICB0aGlzLiRsb2cud2FybignZm9ybUZpZWxkTW9kZWw6IE5vIGZvcm0gZmllbGQgY29udHJvbGxlciBmb3VuZCEnKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmZvcm1GaWVsZC5zZXRNb2RlbCh0aGlzLm5nTW9kZWwpO1xuICAgIH07XG5cbiAgLy9cbiAgLy8gUkVHSVNUUllcbiAgLy9cbiAgYW5ndWxhci5tb2R1bGUobW9kdWxlKS5kaXJlY3RpdmUoJ2Zvcm1GaWVsZE1vZGVsJywgZnVuY3Rpb24oKXtcbiAgICByZXR1cm4ge1xuICAgICAgcmVzdHJpY3Q6ICdBJyxcbiAgICAgIHJlcXVpcmU6IHtcbiAgICAgICAgJ25nTW9kZWwnOiAnbmdNb2RlbCcsXG4gICAgICAgICdmb3JtRmllbGQnOiAnXj9mb3JtRmllbGQnXG4gICAgICB9LFxuICAgICAgYmluZFRvQ29udHJvbGxlcjogdHJ1ZSxcbiAgICAgIGNvbnRyb2xsZXI6IEZvcm1GaWVsZE1vZGVsXG4gICAgfTtcbiAgfSk7XG5cbn0pKEFOR1VMQVJfTU9EVUxFLCBhbmd1bGFyKTtcbiJdfQ==

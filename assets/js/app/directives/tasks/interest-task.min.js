/*!
 * eFit Website
 * An app for financial training in educational environments
 * http://www.e-fit.com
 * @author Armin Pfurtscheller
 * @version 1.0.0
 * Copyright 2017. MIT licensed.
 */
/* global ANGULAR_MODULE, angular */
(function(module, angular) {
  'use strict';

  // --------------------------------------------------
  // InterestTask
  // --------------------------------------------------

  //
  // CONTROLLER
  //

  /**
   * @constructor
   */
  var InterestTask = function($scope, $element, $attrs, $injector) {
    var type = $injector.get('TYPE_INTEREST');
    var user = $injector.get('user');

    this.$scope = $scope;
    this.$attrs = $attrs;
    this.$element = $element;
    this.$injector = $injector;

    this.task = user.getTaskByType(type);
  };

  InterestTask.$inject = ['$scope', '$element', '$attrs', '$injector'];

  //
  // PROPERTIES
  //

  // SERVER

  /** @var {object} task Task's resource from server. */
  InterestTask.prototype.task = null;

  // GAMEPLAY

  /** @var {boolean} resolved If player has resolved the game. */
  InterestTask.prototype.resolved = false;

   /** @var {number} correctAnswers Count of correct answers. */
  InterestTask.prototype.correctAnswers = 0;

  /** @var {number} exercise1Answer Answer for first exercise. */
  InterestTask.prototype.exercise1Answer = 0;

  /** @var {number} exercise2Answer Answer for second exercise. */
  InterestTask.prototype.exercise2Answer = 0;

  /** @var {boolean} exercise1Correct Resolution state of first exercise. */
  InterestTask.prototype.exercise1Correct = false;

  /** @var {boolean} exercise2Correct Resolution state of second exercise. */
  InterestTask.prototype.exercise2Correct = false;

  /** @var {number} exercise1Result Correct result for first exercise. */
  InterestTask.prototype.exercise1Result = 0;

  /** @var {number} exercise2Result Correct result for second exercise. */
  InterestTask.prototype.exercise2Result = 0;

  // SETTINGS

  /** @var {number} amount Amount of money. */
  InterestTask.prototype.amount = 1000;

  /** @var {number} rate Interest rate. */
  InterestTask.prototype.rate = 0.02;

  /** @var {number} years Number of years. */
  InterestTask.prototype.years = 1;

  //
  // METHODS
  //

  /**
   * Proxies to `init()` if controller's ready.
   *
   * @public
   * @method $onInit
   * @return {Void}
   */
  InterestTask.prototype.$onInit = function() {
    this.init();
  };

  /**
   * Retrieves result payload for server.
   *
   * @public
   * @method getPayload
   * @return {Void}
   */
  InterestTask.prototype.getPayload = function() {
    /* jshint camelcase: false */
    return {
      task: this.task,
      json: {
        exercise1: {
          current_result: this.exercise1Result,
          actual_result: this.exercise1Answer,
          is_valid: this.exercise1Correct
        },
        exercise2: {
          current_result: this.exercise2Result,
          actual_result: this.exercise2Answer,
          is_valid: this.exercise2Correct
        }
      }
    };
    /* jshint camelcase: true */
  };

  /**
   * Whether or not task is currently locked.
   *
   * @public
   * @method isLocked
   * @return {boolean}
   */
  InterestTask.prototype.isLocked = function() {
    if (this.task === null) {
      return true;
    }

    return !this.task.isActive;
  };

  /**
   * Whether or not task can be sent to server.
   *
   * @public
   * @method canResolve
   * @return {boolean}
   */
  InterestTask.prototype.canResolve = function() {
    var user = this.$injector.get('user');
    if (!user.isUser()) {
      return false;
    }

    if (this.isLocked()) {
      return false;
    }

    if (this.resolved) {
      return false;
    }

    if (!this.exercise1Answer) {
      return false;
    }

    if (!this.exercise2Answer) {
      return false;
    }

    return true;
  };

  /**
   * Sets up initial state.
   *
   * @public
   * @method init
   * @return {Void}
   */
  InterestTask.prototype.init = function() {
    this.resolved = false;
    this.correctAnswers = 0;
    this.exercise1Answer = 0;
    this.exercise2Answer = 0;
    this.exercise1Correct = false;
    this.exercise2Correct = false;
    this.exercise1Result = this._calculateResult(1);
    this.exercise2Result = this._calculateResult(1 + this.years);
  };

  /**
   * Resets initial state.
   *
   * @public
   * @method reset
   * @return {Void}
   */
  InterestTask.prototype.reset = function(){
    this.init();
  };

  /**
   * Updates answers, state and counters
   * for given exercise for evaluation.
   *
   * @public
   * @method update
   * @param {number} value
   * @param {string} exercise
   * @return {Void}
   */
  InterestTask.prototype.update = function(value, exercise){
    switch(exercise) {
      case 'exercise1':
        this.exercise1Answer = value;
        break;
      case 'exercise2':
        this.exercise2Answer = value;
        break;
      default:
    }

    this.exercise1Correct = this.exercise1Answer === this.exercise1Result;
    this.exercise2Correct = this.exercise2Answer === this.exercise2Result;

    if (this.exercise1Correct && this.exercise2Correct) {
      this.correctAnswers = 2;
    } else if (this.exercise1Correct) {
      this.correctAnswers = 1;
    } else if (this.exercise2Correct) {
      this.correctAnswers = 1;
    } else {
      this.correctAnswers = 0;
    }
  };

  /**
   * Sets `resolved` flag. Calls `onResolve`
   * callback with JSON result for consumer.
   *
   * @public
   * @method resolve
   * @return {Void}
   */
  InterestTask.prototype.resolve = function(){
    var $q = this.$injector.get('$q');
    var result = this.onResolve({
      payload: this.getPayload()
    });

    var me = this;
    var successCallback = function() {
      me.resolved = true;
    };
    var failureCallback = function() {

    };

    var promise = $q.when(result);
    promise.then(
      successCallback,
      failureCallback
    );

    return promise;
  };

  /**
   * Calculates result for given years.
   *
   * @private
   * @method _calculateResult
   * @param {number} years
   * @return {number}
   */
  InterestTask.prototype._calculateResult = function(years) {
    return this.amount * Math.pow(1 + this.rate, years || 1);
  };

  //
  // REGISTRY
  //
  angular.module(module).directive('interestTask', function(){
    return {
      scope: {
        rate: '=?interestTaskRate',
        years: '=?interestTaskYears',
        amount: '=?interestTaskAmount',
        onResolve: '&interestTaskOnResolve'
      },
      restrict: 'A',
      transclude: true,
      controller: InterestTask,
      bindToController: true,
      controllerAs: 'interestTaskController',
      templateUrl: 'views/directives/tasks/interest-task.html'
    };
  });

  // --------------------------------------------------
  // InterestTask Exercise
  // --------------------------------------------------

  //
  // CONTROLLER
  //

  /**
   * @constructor
   */
  var InterestTaskExercise = function($scope,$element,$attrs) {
    this.$element = $element;
    this.$scope = $scope;
    this.$attrs = $attrs;

    this.disabled = false;
    this.stack = [];
    this.sum = 0;

    var me = this;
    this._unwatch = $scope.$watch(
      function(){Â return me.sum; },
      function(sum) {
        if (!sum) {
          me.sum = 0;
          me.stack = [];
        }
      }
    );
  };

  InterestTaskExercise.$inject = ['$scope','$element','$attrs'];

  //
  // PROPERTIES
  //

  /** @var {boolean} disabled If exercise is currently disabled. */
  InterestTaskExercise.prototype.disabled = false;

  /** @var {array} stack Stack collection all notes and coins. */
  InterestTaskExercise.prototype.stack = [];

  /** @var {number} sum Total sum of all values from `stack`. */
  InterestTaskExercise.prototype.sum = 0;

  /** @var {array} notes All selectable notes for exercise. */
  InterestTaskExercise.prototype.notes = [500,200,100,50,20,10,5];

  /** @var {array} notes All selectable coins for exercise. */
  InterestTaskExercise.prototype.coins = [2,1,0.5,0.2,0.1,0.05,0.02,0.01];

  //
  // METHODS
  //

  /**
   * Removes event listener and watches.
   *
   * @public
   * @method $onDestroy
   * @return {void}
   */
  InterestTaskExercise.prototype.$onDestroy = function() {
    this._unwatch();
  };

  /**
   * Adds value to `stack`, increases `sum`
   * and invokes the `onUpdate` callback.
   *
   * @public
   * @method onDrop
   * @return {Void}
   */
  InterestTaskExercise.prototype.onDrop = function(value){
    this.stack.push(value);
    this.sum += value;

    this.onUpdate({
      sum: this.sum
    });
  };

  /**
   * Removes last item from `stack`, decreases
   * `sum` and invokes the `onUpdate` callback.
   *
   * @public
   * @method revert
   * @return {Void}
   */
  InterestTaskExercise.prototype.revert = function() {
    this.sum -= this.stack.pop();

    this.onUpdate({
      sum: this.sum
    });
  };

  //
  // REGISTRY
  //
  angular.module(module).directive('interestTaskExercise', function(){
    return {
      scope: {
        sum: '=?interestTaskExerciseSum',
        onUpdate: '&interestTaskExerciseOnUpdate',
        disabled: '=?interestTaskExerciseDisabled'
      },
      restrict: 'A',
      transclude: true,
      controller: InterestTaskExercise,
      bindToController: true,
      controllerAs: 'interestTaskExerciseController',
      templateUrl: 'views/directives/tasks/interest-task-exercise.html'
    };
  });

})(ANGULAR_MODULE, angular);

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9kaXJlY3RpdmVzL3Rhc2tzL2ludGVyZXN0LXRhc2suanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImFwcC9kaXJlY3RpdmVzL3Rhc2tzL2ludGVyZXN0LXRhc2subWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyogZ2xvYmFsIEFOR1VMQVJfTU9EVUxFLCBhbmd1bGFyICovXG4oZnVuY3Rpb24obW9kdWxlLCBhbmd1bGFyKSB7XG4gICd1c2Ugc3RyaWN0JztcblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBJbnRlcmVzdFRhc2tcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICAvL1xuICAvLyBDT05UUk9MTEVSXG4gIC8vXG5cbiAgLyoqXG4gICAqIEBjb25zdHJ1Y3RvclxuICAgKi9cbiAgdmFyIEludGVyZXN0VGFzayA9IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgJGluamVjdG9yKSB7XG4gICAgdmFyIHR5cGUgPSAkaW5qZWN0b3IuZ2V0KCdUWVBFX0lOVEVSRVNUJyk7XG4gICAgdmFyIHVzZXIgPSAkaW5qZWN0b3IuZ2V0KCd1c2VyJyk7XG5cbiAgICB0aGlzLiRzY29wZSA9ICRzY29wZTtcbiAgICB0aGlzLiRhdHRycyA9ICRhdHRycztcbiAgICB0aGlzLiRlbGVtZW50ID0gJGVsZW1lbnQ7XG4gICAgdGhpcy4kaW5qZWN0b3IgPSAkaW5qZWN0b3I7XG5cbiAgICB0aGlzLnRhc2sgPSB1c2VyLmdldFRhc2tCeVR5cGUodHlwZSk7XG4gIH07XG5cbiAgSW50ZXJlc3RUYXNrLiRpbmplY3QgPSBbJyRzY29wZScsICckZWxlbWVudCcsICckYXR0cnMnLCAnJGluamVjdG9yJ107XG5cbiAgLy9cbiAgLy8gUFJPUEVSVElFU1xuICAvL1xuXG4gIC8vIFNFUlZFUlxuXG4gIC8qKiBAdmFyIHtvYmplY3R9IHRhc2sgVGFzaydzIHJlc291cmNlIGZyb20gc2VydmVyLiAqL1xuICBJbnRlcmVzdFRhc2sucHJvdG90eXBlLnRhc2sgPSBudWxsO1xuXG4gIC8vIEdBTUVQTEFZXG5cbiAgLyoqIEB2YXIge2Jvb2xlYW59IHJlc29sdmVkIElmIHBsYXllciBoYXMgcmVzb2x2ZWQgdGhlIGdhbWUuICovXG4gIEludGVyZXN0VGFzay5wcm90b3R5cGUucmVzb2x2ZWQgPSBmYWxzZTtcblxuICAgLyoqIEB2YXIge251bWJlcn0gY29ycmVjdEFuc3dlcnMgQ291bnQgb2YgY29ycmVjdCBhbnN3ZXJzLiAqL1xuICBJbnRlcmVzdFRhc2sucHJvdG90eXBlLmNvcnJlY3RBbnN3ZXJzID0gMDtcblxuICAvKiogQHZhciB7bnVtYmVyfSBleGVyY2lzZTFBbnN3ZXIgQW5zd2VyIGZvciBmaXJzdCBleGVyY2lzZS4gKi9cbiAgSW50ZXJlc3RUYXNrLnByb3RvdHlwZS5leGVyY2lzZTFBbnN3ZXIgPSAwO1xuXG4gIC8qKiBAdmFyIHtudW1iZXJ9IGV4ZXJjaXNlMkFuc3dlciBBbnN3ZXIgZm9yIHNlY29uZCBleGVyY2lzZS4gKi9cbiAgSW50ZXJlc3RUYXNrLnByb3RvdHlwZS5leGVyY2lzZTJBbnN3ZXIgPSAwO1xuXG4gIC8qKiBAdmFyIHtib29sZWFufSBleGVyY2lzZTFDb3JyZWN0IFJlc29sdXRpb24gc3RhdGUgb2YgZmlyc3QgZXhlcmNpc2UuICovXG4gIEludGVyZXN0VGFzay5wcm90b3R5cGUuZXhlcmNpc2UxQ29ycmVjdCA9IGZhbHNlO1xuXG4gIC8qKiBAdmFyIHtib29sZWFufSBleGVyY2lzZTJDb3JyZWN0IFJlc29sdXRpb24gc3RhdGUgb2Ygc2Vjb25kIGV4ZXJjaXNlLiAqL1xuICBJbnRlcmVzdFRhc2sucHJvdG90eXBlLmV4ZXJjaXNlMkNvcnJlY3QgPSBmYWxzZTtcblxuICAvKiogQHZhciB7bnVtYmVyfSBleGVyY2lzZTFSZXN1bHQgQ29ycmVjdCByZXN1bHQgZm9yIGZpcnN0IGV4ZXJjaXNlLiAqL1xuICBJbnRlcmVzdFRhc2sucHJvdG90eXBlLmV4ZXJjaXNlMVJlc3VsdCA9IDA7XG5cbiAgLyoqIEB2YXIge251bWJlcn0gZXhlcmNpc2UyUmVzdWx0IENvcnJlY3QgcmVzdWx0IGZvciBzZWNvbmQgZXhlcmNpc2UuICovXG4gIEludGVyZXN0VGFzay5wcm90b3R5cGUuZXhlcmNpc2UyUmVzdWx0ID0gMDtcblxuICAvLyBTRVRUSU5HU1xuXG4gIC8qKiBAdmFyIHtudW1iZXJ9IGFtb3VudCBBbW91bnQgb2YgbW9uZXkuICovXG4gIEludGVyZXN0VGFzay5wcm90b3R5cGUuYW1vdW50ID0gMTAwMDtcblxuICAvKiogQHZhciB7bnVtYmVyfSByYXRlIEludGVyZXN0IHJhdGUuICovXG4gIEludGVyZXN0VGFzay5wcm90b3R5cGUucmF0ZSA9IDAuMDI7XG5cbiAgLyoqIEB2YXIge251bWJlcn0geWVhcnMgTnVtYmVyIG9mIHllYXJzLiAqL1xuICBJbnRlcmVzdFRhc2sucHJvdG90eXBlLnllYXJzID0gMTtcblxuICAvL1xuICAvLyBNRVRIT0RTXG4gIC8vXG5cbiAgLyoqXG4gICAqIFByb3hpZXMgdG8gYGluaXQoKWAgaWYgY29udHJvbGxlcidzIHJlYWR5LlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgJG9uSW5pdFxuICAgKiBAcmV0dXJuIHtWb2lkfVxuICAgKi9cbiAgSW50ZXJlc3RUYXNrLnByb3RvdHlwZS4kb25Jbml0ID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5pbml0KCk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFJldHJpZXZlcyByZXN1bHQgcGF5bG9hZCBmb3Igc2VydmVyLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgZ2V0UGF5bG9hZFxuICAgKiBAcmV0dXJuIHtWb2lkfVxuICAgKi9cbiAgSW50ZXJlc3RUYXNrLnByb3RvdHlwZS5nZXRQYXlsb2FkID0gZnVuY3Rpb24oKSB7XG4gICAgLyoganNoaW50IGNhbWVsY2FzZTogZmFsc2UgKi9cbiAgICByZXR1cm4ge1xuICAgICAgdGFzazogdGhpcy50YXNrLFxuICAgICAganNvbjoge1xuICAgICAgICBleGVyY2lzZTE6IHtcbiAgICAgICAgICBjdXJyZW50X3Jlc3VsdDogdGhpcy5leGVyY2lzZTFSZXN1bHQsXG4gICAgICAgICAgYWN0dWFsX3Jlc3VsdDogdGhpcy5leGVyY2lzZTFBbnN3ZXIsXG4gICAgICAgICAgaXNfdmFsaWQ6IHRoaXMuZXhlcmNpc2UxQ29ycmVjdFxuICAgICAgICB9LFxuICAgICAgICBleGVyY2lzZTI6IHtcbiAgICAgICAgICBjdXJyZW50X3Jlc3VsdDogdGhpcy5leGVyY2lzZTJSZXN1bHQsXG4gICAgICAgICAgYWN0dWFsX3Jlc3VsdDogdGhpcy5leGVyY2lzZTJBbnN3ZXIsXG4gICAgICAgICAgaXNfdmFsaWQ6IHRoaXMuZXhlcmNpc2UyQ29ycmVjdFxuICAgICAgICB9XG4gICAgICB9XG4gICAgfTtcbiAgICAvKiBqc2hpbnQgY2FtZWxjYXNlOiB0cnVlICovXG4gIH07XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgb3Igbm90IHRhc2sgaXMgY3VycmVudGx5IGxvY2tlZC5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIGlzTG9ja2VkXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59XG4gICAqL1xuICBJbnRlcmVzdFRhc2sucHJvdG90eXBlLmlzTG9ja2VkID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMudGFzayA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuICF0aGlzLnRhc2suaXNBY3RpdmU7XG4gIH07XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgb3Igbm90IHRhc2sgY2FuIGJlIHNlbnQgdG8gc2VydmVyLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgY2FuUmVzb2x2ZVxuICAgKiBAcmV0dXJuIHtib29sZWFufVxuICAgKi9cbiAgSW50ZXJlc3RUYXNrLnByb3RvdHlwZS5jYW5SZXNvbHZlID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIHVzZXIgPSB0aGlzLiRpbmplY3Rvci5nZXQoJ3VzZXInKTtcbiAgICBpZiAoIXVzZXIuaXNVc2VyKCkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc0xvY2tlZCgpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMucmVzb2x2ZWQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuZXhlcmNpc2UxQW5zd2VyKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmV4ZXJjaXNlMkFuc3dlcikge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTZXRzIHVwIGluaXRpYWwgc3RhdGUuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBpbml0XG4gICAqIEByZXR1cm4ge1ZvaWR9XG4gICAqL1xuICBJbnRlcmVzdFRhc2sucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLnJlc29sdmVkID0gZmFsc2U7XG4gICAgdGhpcy5jb3JyZWN0QW5zd2VycyA9IDA7XG4gICAgdGhpcy5leGVyY2lzZTFBbnN3ZXIgPSAwO1xuICAgIHRoaXMuZXhlcmNpc2UyQW5zd2VyID0gMDtcbiAgICB0aGlzLmV4ZXJjaXNlMUNvcnJlY3QgPSBmYWxzZTtcbiAgICB0aGlzLmV4ZXJjaXNlMkNvcnJlY3QgPSBmYWxzZTtcbiAgICB0aGlzLmV4ZXJjaXNlMVJlc3VsdCA9IHRoaXMuX2NhbGN1bGF0ZVJlc3VsdCgxKTtcbiAgICB0aGlzLmV4ZXJjaXNlMlJlc3VsdCA9IHRoaXMuX2NhbGN1bGF0ZVJlc3VsdCgxICsgdGhpcy55ZWFycyk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFJlc2V0cyBpbml0aWFsIHN0YXRlLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgcmVzZXRcbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEludGVyZXN0VGFzay5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbigpe1xuICAgIHRoaXMuaW5pdCgpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBVcGRhdGVzIGFuc3dlcnMsIHN0YXRlIGFuZCBjb3VudGVyc1xuICAgKiBmb3IgZ2l2ZW4gZXhlcmNpc2UgZm9yIGV2YWx1YXRpb24uXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCB1cGRhdGVcbiAgICogQHBhcmFtIHtudW1iZXJ9IHZhbHVlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBleGVyY2lzZVxuICAgKiBAcmV0dXJuIHtWb2lkfVxuICAgKi9cbiAgSW50ZXJlc3RUYXNrLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbih2YWx1ZSwgZXhlcmNpc2Upe1xuICAgIHN3aXRjaChleGVyY2lzZSkge1xuICAgICAgY2FzZSAnZXhlcmNpc2UxJzpcbiAgICAgICAgdGhpcy5leGVyY2lzZTFBbnN3ZXIgPSB2YWx1ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdleGVyY2lzZTInOlxuICAgICAgICB0aGlzLmV4ZXJjaXNlMkFuc3dlciA9IHZhbHVlO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgfVxuXG4gICAgdGhpcy5leGVyY2lzZTFDb3JyZWN0ID0gdGhpcy5leGVyY2lzZTFBbnN3ZXIgPT09IHRoaXMuZXhlcmNpc2UxUmVzdWx0O1xuICAgIHRoaXMuZXhlcmNpc2UyQ29ycmVjdCA9IHRoaXMuZXhlcmNpc2UyQW5zd2VyID09PSB0aGlzLmV4ZXJjaXNlMlJlc3VsdDtcblxuICAgIGlmICh0aGlzLmV4ZXJjaXNlMUNvcnJlY3QgJiYgdGhpcy5leGVyY2lzZTJDb3JyZWN0KSB7XG4gICAgICB0aGlzLmNvcnJlY3RBbnN3ZXJzID0gMjtcbiAgICB9IGVsc2UgaWYgKHRoaXMuZXhlcmNpc2UxQ29ycmVjdCkge1xuICAgICAgdGhpcy5jb3JyZWN0QW5zd2VycyA9IDE7XG4gICAgfSBlbHNlIGlmICh0aGlzLmV4ZXJjaXNlMkNvcnJlY3QpIHtcbiAgICAgIHRoaXMuY29ycmVjdEFuc3dlcnMgPSAxO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmNvcnJlY3RBbnN3ZXJzID0gMDtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIFNldHMgYHJlc29sdmVkYCBmbGFnLiBDYWxscyBgb25SZXNvbHZlYFxuICAgKiBjYWxsYmFjayB3aXRoIEpTT04gcmVzdWx0IGZvciBjb25zdW1lci5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIHJlc29sdmVcbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEludGVyZXN0VGFzay5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uKCl7XG4gICAgdmFyICRxID0gdGhpcy4kaW5qZWN0b3IuZ2V0KCckcScpO1xuICAgIHZhciByZXN1bHQgPSB0aGlzLm9uUmVzb2x2ZSh7XG4gICAgICBwYXlsb2FkOiB0aGlzLmdldFBheWxvYWQoKVxuICAgIH0pO1xuXG4gICAgdmFyIG1lID0gdGhpcztcbiAgICB2YXIgc3VjY2Vzc0NhbGxiYWNrID0gZnVuY3Rpb24oKSB7XG4gICAgICBtZS5yZXNvbHZlZCA9IHRydWU7XG4gICAgfTtcbiAgICB2YXIgZmFpbHVyZUNhbGxiYWNrID0gZnVuY3Rpb24oKSB7XG5cbiAgICB9O1xuXG4gICAgdmFyIHByb21pc2UgPSAkcS53aGVuKHJlc3VsdCk7XG4gICAgcHJvbWlzZS50aGVuKFxuICAgICAgc3VjY2Vzc0NhbGxiYWNrLFxuICAgICAgZmFpbHVyZUNhbGxiYWNrXG4gICAgKTtcblxuICAgIHJldHVybiBwcm9taXNlO1xuICB9O1xuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGVzIHJlc3VsdCBmb3IgZ2l2ZW4geWVhcnMuXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEBtZXRob2QgX2NhbGN1bGF0ZVJlc3VsdFxuICAgKiBAcGFyYW0ge251bWJlcn0geWVhcnNcbiAgICogQHJldHVybiB7bnVtYmVyfVxuICAgKi9cbiAgSW50ZXJlc3RUYXNrLnByb3RvdHlwZS5fY2FsY3VsYXRlUmVzdWx0ID0gZnVuY3Rpb24oeWVhcnMpIHtcbiAgICByZXR1cm4gdGhpcy5hbW91bnQgKiBNYXRoLnBvdygxICsgdGhpcy5yYXRlLCB5ZWFycyB8fCAxKTtcbiAgfTtcblxuICAvL1xuICAvLyBSRUdJU1RSWVxuICAvL1xuICBhbmd1bGFyLm1vZHVsZShtb2R1bGUpLmRpcmVjdGl2ZSgnaW50ZXJlc3RUYXNrJywgZnVuY3Rpb24oKXtcbiAgICByZXR1cm4ge1xuICAgICAgc2NvcGU6IHtcbiAgICAgICAgcmF0ZTogJz0/aW50ZXJlc3RUYXNrUmF0ZScsXG4gICAgICAgIHllYXJzOiAnPT9pbnRlcmVzdFRhc2tZZWFycycsXG4gICAgICAgIGFtb3VudDogJz0/aW50ZXJlc3RUYXNrQW1vdW50JyxcbiAgICAgICAgb25SZXNvbHZlOiAnJmludGVyZXN0VGFza09uUmVzb2x2ZSdcbiAgICAgIH0sXG4gICAgICByZXN0cmljdDogJ0EnLFxuICAgICAgdHJhbnNjbHVkZTogdHJ1ZSxcbiAgICAgIGNvbnRyb2xsZXI6IEludGVyZXN0VGFzayxcbiAgICAgIGJpbmRUb0NvbnRyb2xsZXI6IHRydWUsXG4gICAgICBjb250cm9sbGVyQXM6ICdpbnRlcmVzdFRhc2tDb250cm9sbGVyJyxcbiAgICAgIHRlbXBsYXRlVXJsOiAndmlld3MvZGlyZWN0aXZlcy90YXNrcy9pbnRlcmVzdC10YXNrLmh0bWwnXG4gICAgfTtcbiAgfSk7XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gSW50ZXJlc3RUYXNrIEV4ZXJjaXNlXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgLy9cbiAgLy8gQ09OVFJPTExFUlxuICAvL1xuXG4gIC8qKlxuICAgKiBAY29uc3RydWN0b3JcbiAgICovXG4gIHZhciBJbnRlcmVzdFRhc2tFeGVyY2lzZSA9IGZ1bmN0aW9uKCRzY29wZSwkZWxlbWVudCwkYXR0cnMpIHtcbiAgICB0aGlzLiRlbGVtZW50ID0gJGVsZW1lbnQ7XG4gICAgdGhpcy4kc2NvcGUgPSAkc2NvcGU7XG4gICAgdGhpcy4kYXR0cnMgPSAkYXR0cnM7XG5cbiAgICB0aGlzLmRpc2FibGVkID0gZmFsc2U7XG4gICAgdGhpcy5zdGFjayA9IFtdO1xuICAgIHRoaXMuc3VtID0gMDtcblxuICAgIHZhciBtZSA9IHRoaXM7XG4gICAgdGhpcy5fdW53YXRjaCA9ICRzY29wZS4kd2F0Y2goXG4gICAgICBmdW5jdGlvbigpe8KgcmV0dXJuIG1lLnN1bTsgfSxcbiAgICAgIGZ1bmN0aW9uKHN1bSkge1xuICAgICAgICBpZiAoIXN1bSkge1xuICAgICAgICAgIG1lLnN1bSA9IDA7XG4gICAgICAgICAgbWUuc3RhY2sgPSBbXTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICk7XG4gIH07XG5cbiAgSW50ZXJlc3RUYXNrRXhlcmNpc2UuJGluamVjdCA9IFsnJHNjb3BlJywnJGVsZW1lbnQnLCckYXR0cnMnXTtcblxuICAvL1xuICAvLyBQUk9QRVJUSUVTXG4gIC8vXG5cbiAgLyoqIEB2YXIge2Jvb2xlYW59IGRpc2FibGVkIElmIGV4ZXJjaXNlIGlzIGN1cnJlbnRseSBkaXNhYmxlZC4gKi9cbiAgSW50ZXJlc3RUYXNrRXhlcmNpc2UucHJvdG90eXBlLmRpc2FibGVkID0gZmFsc2U7XG5cbiAgLyoqIEB2YXIge2FycmF5fSBzdGFjayBTdGFjayBjb2xsZWN0aW9uIGFsbCBub3RlcyBhbmQgY29pbnMuICovXG4gIEludGVyZXN0VGFza0V4ZXJjaXNlLnByb3RvdHlwZS5zdGFjayA9IFtdO1xuXG4gIC8qKiBAdmFyIHtudW1iZXJ9IHN1bSBUb3RhbCBzdW0gb2YgYWxsIHZhbHVlcyBmcm9tIGBzdGFja2AuICovXG4gIEludGVyZXN0VGFza0V4ZXJjaXNlLnByb3RvdHlwZS5zdW0gPSAwO1xuXG4gIC8qKiBAdmFyIHthcnJheX0gbm90ZXMgQWxsIHNlbGVjdGFibGUgbm90ZXMgZm9yIGV4ZXJjaXNlLiAqL1xuICBJbnRlcmVzdFRhc2tFeGVyY2lzZS5wcm90b3R5cGUubm90ZXMgPSBbNTAwLDIwMCwxMDAsNTAsMjAsMTAsNV07XG5cbiAgLyoqIEB2YXIge2FycmF5fSBub3RlcyBBbGwgc2VsZWN0YWJsZSBjb2lucyBmb3IgZXhlcmNpc2UuICovXG4gIEludGVyZXN0VGFza0V4ZXJjaXNlLnByb3RvdHlwZS5jb2lucyA9IFsyLDEsMC41LDAuMiwwLjEsMC4wNSwwLjAyLDAuMDFdO1xuXG4gIC8vXG4gIC8vIE1FVEhPRFNcbiAgLy9cblxuICAvKipcbiAgICogUmVtb3ZlcyBldmVudCBsaXN0ZW5lciBhbmQgd2F0Y2hlcy5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kICRvbkRlc3Ryb3lcbiAgICogQHJldHVybiB7dm9pZH1cbiAgICovXG4gIEludGVyZXN0VGFza0V4ZXJjaXNlLnByb3RvdHlwZS4kb25EZXN0cm95ID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fdW53YXRjaCgpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBBZGRzIHZhbHVlIHRvIGBzdGFja2AsIGluY3JlYXNlcyBgc3VtYFxuICAgKiBhbmQgaW52b2tlcyB0aGUgYG9uVXBkYXRlYCBjYWxsYmFjay5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIG9uRHJvcFxuICAgKiBAcmV0dXJuIHtWb2lkfVxuICAgKi9cbiAgSW50ZXJlc3RUYXNrRXhlcmNpc2UucHJvdG90eXBlLm9uRHJvcCA9IGZ1bmN0aW9uKHZhbHVlKXtcbiAgICB0aGlzLnN0YWNrLnB1c2godmFsdWUpO1xuICAgIHRoaXMuc3VtICs9IHZhbHVlO1xuXG4gICAgdGhpcy5vblVwZGF0ZSh7XG4gICAgICBzdW06IHRoaXMuc3VtXG4gICAgfSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFJlbW92ZXMgbGFzdCBpdGVtIGZyb20gYHN0YWNrYCwgZGVjcmVhc2VzXG4gICAqIGBzdW1gIGFuZCBpbnZva2VzIHRoZSBgb25VcGRhdGVgIGNhbGxiYWNrLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgcmV2ZXJ0XG4gICAqIEByZXR1cm4ge1ZvaWR9XG4gICAqL1xuICBJbnRlcmVzdFRhc2tFeGVyY2lzZS5wcm90b3R5cGUucmV2ZXJ0ID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5zdW0gLT0gdGhpcy5zdGFjay5wb3AoKTtcblxuICAgIHRoaXMub25VcGRhdGUoe1xuICAgICAgc3VtOiB0aGlzLnN1bVxuICAgIH0pO1xuICB9O1xuXG4gIC8vXG4gIC8vIFJFR0lTVFJZXG4gIC8vXG4gIGFuZ3VsYXIubW9kdWxlKG1vZHVsZSkuZGlyZWN0aXZlKCdpbnRlcmVzdFRhc2tFeGVyY2lzZScsIGZ1bmN0aW9uKCl7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNjb3BlOiB7XG4gICAgICAgIHN1bTogJz0/aW50ZXJlc3RUYXNrRXhlcmNpc2VTdW0nLFxuICAgICAgICBvblVwZGF0ZTogJyZpbnRlcmVzdFRhc2tFeGVyY2lzZU9uVXBkYXRlJyxcbiAgICAgICAgZGlzYWJsZWQ6ICc9P2ludGVyZXN0VGFza0V4ZXJjaXNlRGlzYWJsZWQnXG4gICAgICB9LFxuICAgICAgcmVzdHJpY3Q6ICdBJyxcbiAgICAgIHRyYW5zY2x1ZGU6IHRydWUsXG4gICAgICBjb250cm9sbGVyOiBJbnRlcmVzdFRhc2tFeGVyY2lzZSxcbiAgICAgIGJpbmRUb0NvbnRyb2xsZXI6IHRydWUsXG4gICAgICBjb250cm9sbGVyQXM6ICdpbnRlcmVzdFRhc2tFeGVyY2lzZUNvbnRyb2xsZXInLFxuICAgICAgdGVtcGxhdGVVcmw6ICd2aWV3cy9kaXJlY3RpdmVzL3Rhc2tzL2ludGVyZXN0LXRhc2stZXhlcmNpc2UuaHRtbCdcbiAgICB9O1xuICB9KTtcblxufSkoQU5HVUxBUl9NT0RVTEUsIGFuZ3VsYXIpO1xuIl19

/*!
 * eFit Website
 * An app for financial training in educational environments
 * http://www.e-fit.com
 * @author Armin Pfurtscheller
 * @version 1.0.0
 * Copyright 2017. MIT licensed.
 */
/* global ANGULAR_MODULE, angular */
(function(module, angular) {
  'use strict';

  // --------------------------------------------------
  // DiversificationTask
  // --------------------------------------------------

  //
  // CONTROLLER
  //

  /**
   * @constructor
   */
  var DiversificationTask = function($scope, $elemnt, $attrs, $injector) {
    var type = $injector.get('TYPE_DIVERSIFICATION');
    var user = $injector.get('user');

    this.$injector = $injector;
    this.task = user.getTaskByType(type);
  };

  DiversificationTask.$inject = ['$scope','$element','$attrs', '$injector'];

  // SERVER

  /** @var {object} task Task's resource from server. */
  DiversificationTask.prototype.task = null;

  // GAMEPLAY

  /** @var {boolean} resolved If player has resolved the game. */
  DiversificationTask.prototype.resolved = false;

  /** @var {string} heads Current class of heads side. */
  DiversificationTask.prototype.heads = 'K';

  /** @var {string} tails Current class of tails side. */
  DiversificationTask.prototype.tails = 'Z';

  /** @var {array} companies Data for companies. */
  DiversificationTask.prototype.companies = {};

  /** @var {array} tickets Data for tickets. */
  DiversificationTask.prototype.tickets = {};

  /** @var {array} sides Two values for coin. */
  DiversificationTask.prototype.sides = [];

  /** @var {number} result Final result. */
  DiversificationTask.prototype.sides = [];

  //
  // METHODS
  //

  /**
   * Proxies to `init()` if controller's ready.
   *
   * @public
   * @method $onInit
   * @return {void}
   */
  DiversificationTask.prototype.$onInit = function() {
    this.init();
  };

  /**
   * Retrieves result payload for server.
   *
   * @public
   * @method getPayload
   * @return {void}
   */
  DiversificationTask.prototype.getPayload = function() {
    return {
      task: this.task,
      json: {
        tickets: {
          one: this.tickets.one.company,
          two: this.tickets.two.company
        },
        throws: {
          one: this.throws.one.toss,
          two: this.throws.two.toss
        }
      },
      ticketCount: this.getTicketCount()
    };
  };

  /**
   * Whether or not task is currently locked.
   *
   * @public
   * @method isLocked
   * @return {boolean}
   */
  DiversificationTask.prototype.isLocked = function() {
    if (this.task === null) {
      return true;
    }

    return !this.task.isActive;
  };

  /**
   * Whether or not task can be sent to server.
   *
   * @public
   * @method canResolve
   * @return {boolean}
   */
  DiversificationTask.prototype.canResolve = function() {
    var user = this.$injector.get('user');
    if (!user.isUser()) {
      return false;
    }

    if (this.isLocked()) {
      return false;
    }

    if (this.resolved) {
      return false;
    }

    if (!this.tickets.one.company) {
      return false;
    }

    if (!this.tickets.two.company) {
      return false;
    }

    return true;
  };

  /**
   * Sets up initial state.
   *
   * @public
   * @method init
   * @return {void}
   */
  DiversificationTask.prototype.init = function() {
    var random = this.$injector.get('random');

    this.sides = [
      this.heads,
      this.tails
    ];

    this.throws = {
      one: {
        id: 1,
        toss: random.pick(this.sides)
      },
      two: {
        id: 2,
        toss: random.pick(this.sides)
      }
    };

    this.tickets = {
      one: {
        id: 1,
        company: null
      },
      two: {
        id: 2,
        company: null
      }
    };

    this.companies = {
      one: {
        id: 1,
        count: 0,
        tickets: {},
        name: 'Smart',
        image: 'company-a.svg'
      },
      two: {
        id: 2,
        count: 0,
        tickets: {},
        name: 'Phone',
        image: 'company-b.svg'
      }
    };

    this.resolved = false;
  };

  /**
   * Resets initial state.
   *
   * @public
   * @method reset
   * @return {void}
   */
  DiversificationTask.prototype.reset = function(){
    this.init();
  };

  /**
   * Adds or removes a ticket from given company.
   *
   * @public
   * @method update
   * @param ticket
   * @param company
   * @param action
   * @return {void}
   */
  DiversificationTask.prototype.update = function(ticket, company, action){
    switch (action) {
      case 'add':
        if (!company.tickets[ticket.id]) {
          company.tickets[ticket.id] = ticket;
          ticket.company = company.name;
          company.count++;
        }
        break;
      case 'remove':
        if (company.tickets[ticket.id]) {
          delete company.tickets[ticket.id];
          ticket.company = null;
          company.count--;
        }
        break;
      default:
    }
  };

  /**
   * Sets `resolved` flag. Calls `onResolve`
   * callback with JSON result for consumer.
   *
   * @public
   * @method resolve
   * @return {void}
   */
  DiversificationTask.prototype.resolve = function(){
    var $q = this.$injector.get('$q');

    var result = this.onResolve({
      payload: this.getPayload()
    });

    var me = this;
    var successCallback = function() {
      me.resolved = true;
    };
    var failureCallback = function() {

    };

    var promise = $q.when(result);
    promise.then(
      successCallback,
      failureCallback
    );

    return promise;
  };

  /**
   * Calculates final ticket amount by predefined formula.
   *
   * @public
   * @method getTicketCount
   * @return {number}
   */
  DiversificationTask.prototype.getTicketCount = function(){
    var factorA = this.throws.one.toss === this.heads ? 2 : 1;
    var factorB = this.throws.two.toss === this.heads ? 2 : 1;

    var ticketsA = this.companies.one.count * factorA;
    var ticketsB = this.companies.two.count * factorB;

    return ticketsA + ticketsB;
  };

  //
  // REGISTRY
  //
  angular.module(module).directive('diversificationTask', function(){
    return {
      scope: {
        onResolve: '&diversificationTaskOnResolve'
      },
      restrict: 'A',
      transclude: true,
      bindToController: true,
      controller: DiversificationTask,
      controllerAs: 'diversificationTaskController',
      templateUrl: 'views/directives/tasks/diversification-task.html'
    };
  });

  // --------------------------------------------------
  // DiversificationTask Coin
  // --------------------------------------------------

  //
  // CONTROLLER
  //

  /**
   * @constructor
   */
  var DiversificationTaskCoin = function($scope,$element,$attrs,$injector) {
    this.$scope = $scope;
    this.$attrs = $attrs;
    this.$element = $element;
    this.$injector = $injector;

    this.animate
    this._element = this.$element.find('.coin');
    this._animationEndEvent = this._getAnimationEndEvent();
  };

  DiversificationTaskCoin.$inject = ['$scope','$element','$attrs','$injector'];

  //
  // PROPERTIES
  //

  /** @var {string} toss One of `heads` or `tails`. */
  DiversificationTaskCoin.prototype.toss = null;

  /** @var {string} heads Current class of heads side. */
  DiversificationTaskCoin.prototype.sides = [];

  /** @var {string} heads Current class of heads side. */
  DiversificationTaskCoin.prototype.heads = 'K';

  /** @var {string} tails Current class of tails side. */
  DiversificationTaskCoin.prototype.tails = 'Z';

  /** @var {boolean} flip Flag to invoke a new toss. */
  DiversificationTaskCoin.prototype.flip = false;

  /** @var {boolean} flip Flag to apply CSS classes. */
  DiversificationTaskCoin.prototype.animate = false;

  /** @var {string} backClass CSS class for back side. */
  DiversificationTaskCoin.prototype.back = 'back';

  /** @var {string} frontClass CSS class for front side. */
  DiversificationTaskCoin.prototype.front = 'front';

  /** @var {string} startSide Initially displayed side of coin. */
  DiversificationTaskCoin.prototype.startSide = 'K';

  //
  // METHODS
  //

  /**
   * Sets up
   *
   * @public
   * @method $onDestroy
   * @return {void}
   */
  DiversificationTaskCoin.prototype.$onInit = function() {
    var $timeout = this.$injector.get('$timeout');
    var me = this;

    this.sides = [
      {
        value: this.heads,
        class: this.front
      },
      {
        value: this.tails,
        class: this.back
      }
    ];

    if (this.startSide !== this.heads) {
      this.sides[0].class = this.back;
      this.sides[1].class = this.front;
    }

    me._toss = me._getToss();

    var _timeoutCallback = function() {
      var _iterateSides = function(side) {
        if (side.value === me._toss.value) {
          side.class = me.front;
          return;
        }

        side.class = me.back;
      };

      angular.forEach(me.sides, _iterateSides);
    };

    var _watchFlipCallback = function(newFlip/*,oldFlip*/) {
      if (newFlip) {
        me.onStart({toss: me._toss.value});
        $timeout(_timeoutCallback, 100);
        me.animate = true;
      }
    };

    var _watchFlipExpression = function() {
      return me.flip;
    };

    var _watchTossCallback = function(newToss, oldToss) {
      if (newToss !== oldToss) {
        me._toss = me._getToss();
      }
    };

    var _watchTossExpression = function() {
      return me.toss;
    };

    var _evalAsyncCallback = function() {
      me.onFinish({toss: me._toss.value});
      me.animate = false;
    };

    var _animationEndCallback = function() {
      me.$scope.$evalAsync(_evalAsyncCallback);
    };

    this.onInit({toss: me._toss.value});

    if (this._animationEndEvent) {
      this._element.on(this._animationEndEvent, _animationEndCallback);
    }

    this._unwatchFlip = this.$scope.$watch(_watchFlipExpression, _watchFlipCallback);
    this._unwatchToss = this.$scope.$watch(_watchTossExpression, _watchTossCallback);
  };

  /**
   * Removes event listener and watches.
   *
   * @public
   * @method $onDestroy
   * @return {void}
   */
  DiversificationTaskCoin.prototype.$onDestroy = function() {
    this._element.off(this._animationEndEvent);
    this._unwatchToss();
    this._unwatchFlip();
  };

  /**
   * Gets correctly prefixed transition event.
   *
   * @private
   * @method _getTransitionEvent
   * @return {void}
   */
  DiversificationTaskCoin.prototype._getAnimationEndEvent = function() {
    var dummy = document.createElement('div');
    var transitions = {
      'WebkitAnimation': 'webkitAnimationEnd',
      'MozTAnimation': 'animationend',
      'animation': 'animationend'
    };

    for(var key in transitions){
        var event = dummy.style[key];
        if( event !== undefined ){
          return transitions[key];
        }
    }

    return null;
  };

  /**
   * Transforms `toss` to one side either
   * by random or by given consumer input.
   *
   * @private
   * @method _getToss
   * @return {void}
   */
  DiversificationTaskCoin.prototype._getToss = function() {
    var $filter = this.$injector.get('$filter');
    var random = this.$injector.get('random');
    var picked = random.pick(this.sides);

    if (this.toss === null) {
      return picked;
    }

    var filtered = $filter('filter')(
      this.sides,
      {
        value: this.toss
      }
    );

    if (filtered.length === 0) {
      console.warn('Invalid value for `toss` - using random value!');
      return picked;
    }

    return filtered[0];
  };

  //
  // REGISTRY
  //
  angular.module(module).directive('diversificationTaskCoin', function(){
    return {
      scope: {
        toss: '=?diversificationTaskCoinToss',
        flip: '=?diversificationTaskCoinFlip',
        onInit: '&diversificationTaskCoinOnInit',
        onStart: '&diversificationTaskCoinOnStart',
        onFinish: '&diversificationTaskCoinOnFinish',
        startSide: '=?diversificationTaskCoinStartSide'
      },
      restrict: 'A',
      transclude: true,
      bindToController: true,
      controller: DiversificationTaskCoin,
      controllerAs: 'diversificationTaskCoinController',
      templateUrl: 'views/directives/tasks/diversification-task-coin.html'
    };
  });

})(ANGULAR_MODULE, angular);

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9kaXJlY3RpdmVzL3Rhc2tzL2RpdmVyc2lmaWNhdGlvbi10YXNrLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJhcHAvZGlyZWN0aXZlcy90YXNrcy9kaXZlcnNpZmljYXRpb24tdGFzay5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBnbG9iYWwgQU5HVUxBUl9NT0RVTEUsIGFuZ3VsYXIgKi9cbihmdW5jdGlvbihtb2R1bGUsIGFuZ3VsYXIpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIERpdmVyc2lmaWNhdGlvblRhc2tcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICAvL1xuICAvLyBDT05UUk9MTEVSXG4gIC8vXG5cbiAgLyoqXG4gICAqIEBjb25zdHJ1Y3RvclxuICAgKi9cbiAgdmFyIERpdmVyc2lmaWNhdGlvblRhc2sgPSBmdW5jdGlvbigkc2NvcGUsICRlbGVtbnQsICRhdHRycywgJGluamVjdG9yKSB7XG4gICAgdmFyIHR5cGUgPSAkaW5qZWN0b3IuZ2V0KCdUWVBFX0RJVkVSU0lGSUNBVElPTicpO1xuICAgIHZhciB1c2VyID0gJGluamVjdG9yLmdldCgndXNlcicpO1xuXG4gICAgdGhpcy4kaW5qZWN0b3IgPSAkaW5qZWN0b3I7XG4gICAgdGhpcy50YXNrID0gdXNlci5nZXRUYXNrQnlUeXBlKHR5cGUpO1xuICB9O1xuXG4gIERpdmVyc2lmaWNhdGlvblRhc2suJGluamVjdCA9IFsnJHNjb3BlJywnJGVsZW1lbnQnLCckYXR0cnMnLCAnJGluamVjdG9yJ107XG5cbiAgLy8gU0VSVkVSXG5cbiAgLyoqIEB2YXIge29iamVjdH0gdGFzayBUYXNrJ3MgcmVzb3VyY2UgZnJvbSBzZXJ2ZXIuICovXG4gIERpdmVyc2lmaWNhdGlvblRhc2sucHJvdG90eXBlLnRhc2sgPSBudWxsO1xuXG4gIC8vIEdBTUVQTEFZXG5cbiAgLyoqIEB2YXIge2Jvb2xlYW59IHJlc29sdmVkIElmIHBsYXllciBoYXMgcmVzb2x2ZWQgdGhlIGdhbWUuICovXG4gIERpdmVyc2lmaWNhdGlvblRhc2sucHJvdG90eXBlLnJlc29sdmVkID0gZmFsc2U7XG5cbiAgLyoqIEB2YXIge3N0cmluZ30gaGVhZHMgQ3VycmVudCBjbGFzcyBvZiBoZWFkcyBzaWRlLiAqL1xuICBEaXZlcnNpZmljYXRpb25UYXNrLnByb3RvdHlwZS5oZWFkcyA9ICdLJztcblxuICAvKiogQHZhciB7c3RyaW5nfSB0YWlscyBDdXJyZW50IGNsYXNzIG9mIHRhaWxzIHNpZGUuICovXG4gIERpdmVyc2lmaWNhdGlvblRhc2sucHJvdG90eXBlLnRhaWxzID0gJ1onO1xuXG4gIC8qKiBAdmFyIHthcnJheX0gY29tcGFuaWVzIERhdGEgZm9yIGNvbXBhbmllcy4gKi9cbiAgRGl2ZXJzaWZpY2F0aW9uVGFzay5wcm90b3R5cGUuY29tcGFuaWVzID0ge307XG5cbiAgLyoqIEB2YXIge2FycmF5fSB0aWNrZXRzIERhdGEgZm9yIHRpY2tldHMuICovXG4gIERpdmVyc2lmaWNhdGlvblRhc2sucHJvdG90eXBlLnRpY2tldHMgPSB7fTtcblxuICAvKiogQHZhciB7YXJyYXl9IHNpZGVzIFR3byB2YWx1ZXMgZm9yIGNvaW4uICovXG4gIERpdmVyc2lmaWNhdGlvblRhc2sucHJvdG90eXBlLnNpZGVzID0gW107XG5cbiAgLyoqIEB2YXIge251bWJlcn0gcmVzdWx0IEZpbmFsIHJlc3VsdC4gKi9cbiAgRGl2ZXJzaWZpY2F0aW9uVGFzay5wcm90b3R5cGUuc2lkZXMgPSBbXTtcblxuICAvL1xuICAvLyBNRVRIT0RTXG4gIC8vXG5cbiAgLyoqXG4gICAqIFByb3hpZXMgdG8gYGluaXQoKWAgaWYgY29udHJvbGxlcidzIHJlYWR5LlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgJG9uSW5pdFxuICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgKi9cbiAgRGl2ZXJzaWZpY2F0aW9uVGFzay5wcm90b3R5cGUuJG9uSW5pdCA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuaW5pdCgpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZXMgcmVzdWx0IHBheWxvYWQgZm9yIHNlcnZlci5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIGdldFBheWxvYWRcbiAgICogQHJldHVybiB7dm9pZH1cbiAgICovXG4gIERpdmVyc2lmaWNhdGlvblRhc2sucHJvdG90eXBlLmdldFBheWxvYWQgPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdGFzazogdGhpcy50YXNrLFxuICAgICAganNvbjoge1xuICAgICAgICB0aWNrZXRzOiB7XG4gICAgICAgICAgb25lOiB0aGlzLnRpY2tldHMub25lLmNvbXBhbnksXG4gICAgICAgICAgdHdvOiB0aGlzLnRpY2tldHMudHdvLmNvbXBhbnlcbiAgICAgICAgfSxcbiAgICAgICAgdGhyb3dzOiB7XG4gICAgICAgICAgb25lOiB0aGlzLnRocm93cy5vbmUudG9zcyxcbiAgICAgICAgICB0d286IHRoaXMudGhyb3dzLnR3by50b3NzXG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICB0aWNrZXRDb3VudDogdGhpcy5nZXRUaWNrZXRDb3VudCgpXG4gICAgfTtcbiAgfTtcblxuICAvKipcbiAgICogV2hldGhlciBvciBub3QgdGFzayBpcyBjdXJyZW50bHkgbG9ja2VkLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgaXNMb2NrZWRcbiAgICogQHJldHVybiB7Ym9vbGVhbn1cbiAgICovXG4gIERpdmVyc2lmaWNhdGlvblRhc2sucHJvdG90eXBlLmlzTG9ja2VkID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMudGFzayA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuICF0aGlzLnRhc2suaXNBY3RpdmU7XG4gIH07XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgb3Igbm90IHRhc2sgY2FuIGJlIHNlbnQgdG8gc2VydmVyLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgY2FuUmVzb2x2ZVxuICAgKiBAcmV0dXJuIHtib29sZWFufVxuICAgKi9cbiAgRGl2ZXJzaWZpY2F0aW9uVGFzay5wcm90b3R5cGUuY2FuUmVzb2x2ZSA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciB1c2VyID0gdGhpcy4kaW5qZWN0b3IuZ2V0KCd1c2VyJyk7XG4gICAgaWYgKCF1c2VyLmlzVXNlcigpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNMb2NrZWQoKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnJlc29sdmVkKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnRpY2tldHMub25lLmNvbXBhbnkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMudGlja2V0cy50d28uY29tcGFueSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTZXRzIHVwIGluaXRpYWwgc3RhdGUuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBpbml0XG4gICAqIEByZXR1cm4ge3ZvaWR9XG4gICAqL1xuICBEaXZlcnNpZmljYXRpb25UYXNrLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIHJhbmRvbSA9IHRoaXMuJGluamVjdG9yLmdldCgncmFuZG9tJyk7XG5cbiAgICB0aGlzLnNpZGVzID0gW1xuICAgICAgdGhpcy5oZWFkcyxcbiAgICAgIHRoaXMudGFpbHNcbiAgICBdO1xuXG4gICAgdGhpcy50aHJvd3MgPSB7XG4gICAgICBvbmU6IHtcbiAgICAgICAgaWQ6IDEsXG4gICAgICAgIHRvc3M6IHJhbmRvbS5waWNrKHRoaXMuc2lkZXMpXG4gICAgICB9LFxuICAgICAgdHdvOiB7XG4gICAgICAgIGlkOiAyLFxuICAgICAgICB0b3NzOiByYW5kb20ucGljayh0aGlzLnNpZGVzKVxuICAgICAgfVxuICAgIH07XG5cbiAgICB0aGlzLnRpY2tldHMgPSB7XG4gICAgICBvbmU6IHtcbiAgICAgICAgaWQ6IDEsXG4gICAgICAgIGNvbXBhbnk6IG51bGxcbiAgICAgIH0sXG4gICAgICB0d286IHtcbiAgICAgICAgaWQ6IDIsXG4gICAgICAgIGNvbXBhbnk6IG51bGxcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5jb21wYW5pZXMgPSB7XG4gICAgICBvbmU6IHtcbiAgICAgICAgaWQ6IDEsXG4gICAgICAgIGNvdW50OiAwLFxuICAgICAgICB0aWNrZXRzOiB7fSxcbiAgICAgICAgbmFtZTogJ1NtYXJ0JyxcbiAgICAgICAgaW1hZ2U6ICdjb21wYW55LWEuc3ZnJ1xuICAgICAgfSxcbiAgICAgIHR3bzoge1xuICAgICAgICBpZDogMixcbiAgICAgICAgY291bnQ6IDAsXG4gICAgICAgIHRpY2tldHM6IHt9LFxuICAgICAgICBuYW1lOiAnUGhvbmUnLFxuICAgICAgICBpbWFnZTogJ2NvbXBhbnktYi5zdmcnXG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMucmVzb2x2ZWQgPSBmYWxzZTtcbiAgfTtcblxuICAvKipcbiAgICogUmVzZXRzIGluaXRpYWwgc3RhdGUuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCByZXNldFxuICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgKi9cbiAgRGl2ZXJzaWZpY2F0aW9uVGFzay5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbigpe1xuICAgIHRoaXMuaW5pdCgpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBBZGRzIG9yIHJlbW92ZXMgYSB0aWNrZXQgZnJvbSBnaXZlbiBjb21wYW55LlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgdXBkYXRlXG4gICAqIEBwYXJhbSB0aWNrZXRcbiAgICogQHBhcmFtIGNvbXBhbnlcbiAgICogQHBhcmFtIGFjdGlvblxuICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgKi9cbiAgRGl2ZXJzaWZpY2F0aW9uVGFzay5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24odGlja2V0LCBjb21wYW55LCBhY3Rpb24pe1xuICAgIHN3aXRjaCAoYWN0aW9uKSB7XG4gICAgICBjYXNlICdhZGQnOlxuICAgICAgICBpZiAoIWNvbXBhbnkudGlja2V0c1t0aWNrZXQuaWRdKSB7XG4gICAgICAgICAgY29tcGFueS50aWNrZXRzW3RpY2tldC5pZF0gPSB0aWNrZXQ7XG4gICAgICAgICAgdGlja2V0LmNvbXBhbnkgPSBjb21wYW55Lm5hbWU7XG4gICAgICAgICAgY29tcGFueS5jb3VudCsrO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAncmVtb3ZlJzpcbiAgICAgICAgaWYgKGNvbXBhbnkudGlja2V0c1t0aWNrZXQuaWRdKSB7XG4gICAgICAgICAgZGVsZXRlIGNvbXBhbnkudGlja2V0c1t0aWNrZXQuaWRdO1xuICAgICAgICAgIHRpY2tldC5jb21wYW55ID0gbnVsbDtcbiAgICAgICAgICBjb21wYW55LmNvdW50LS07XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBkZWZhdWx0OlxuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogU2V0cyBgcmVzb2x2ZWRgIGZsYWcuIENhbGxzIGBvblJlc29sdmVgXG4gICAqIGNhbGxiYWNrIHdpdGggSlNPTiByZXN1bHQgZm9yIGNvbnN1bWVyLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgcmVzb2x2ZVxuICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgKi9cbiAgRGl2ZXJzaWZpY2F0aW9uVGFzay5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uKCl7XG4gICAgdmFyICRxID0gdGhpcy4kaW5qZWN0b3IuZ2V0KCckcScpO1xuXG4gICAgdmFyIHJlc3VsdCA9IHRoaXMub25SZXNvbHZlKHtcbiAgICAgIHBheWxvYWQ6IHRoaXMuZ2V0UGF5bG9hZCgpXG4gICAgfSk7XG5cbiAgICB2YXIgbWUgPSB0aGlzO1xuICAgIHZhciBzdWNjZXNzQ2FsbGJhY2sgPSBmdW5jdGlvbigpIHtcbiAgICAgIG1lLnJlc29sdmVkID0gdHJ1ZTtcbiAgICB9O1xuICAgIHZhciBmYWlsdXJlQ2FsbGJhY2sgPSBmdW5jdGlvbigpIHtcblxuICAgIH07XG5cbiAgICB2YXIgcHJvbWlzZSA9ICRxLndoZW4ocmVzdWx0KTtcbiAgICBwcm9taXNlLnRoZW4oXG4gICAgICBzdWNjZXNzQ2FsbGJhY2ssXG4gICAgICBmYWlsdXJlQ2FsbGJhY2tcbiAgICApO1xuXG4gICAgcmV0dXJuIHByb21pc2U7XG4gIH07XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZXMgZmluYWwgdGlja2V0IGFtb3VudCBieSBwcmVkZWZpbmVkIGZvcm11bGEuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBnZXRUaWNrZXRDb3VudFxuICAgKiBAcmV0dXJuIHtudW1iZXJ9XG4gICAqL1xuICBEaXZlcnNpZmljYXRpb25UYXNrLnByb3RvdHlwZS5nZXRUaWNrZXRDb3VudCA9IGZ1bmN0aW9uKCl7XG4gICAgdmFyIGZhY3RvckEgPSB0aGlzLnRocm93cy5vbmUudG9zcyA9PT0gdGhpcy5oZWFkcyA/IDIgOiAxO1xuICAgIHZhciBmYWN0b3JCID0gdGhpcy50aHJvd3MudHdvLnRvc3MgPT09IHRoaXMuaGVhZHMgPyAyIDogMTtcblxuICAgIHZhciB0aWNrZXRzQSA9IHRoaXMuY29tcGFuaWVzLm9uZS5jb3VudCAqIGZhY3RvckE7XG4gICAgdmFyIHRpY2tldHNCID0gdGhpcy5jb21wYW5pZXMudHdvLmNvdW50ICogZmFjdG9yQjtcblxuICAgIHJldHVybiB0aWNrZXRzQSArIHRpY2tldHNCO1xuICB9O1xuXG4gIC8vXG4gIC8vIFJFR0lTVFJZXG4gIC8vXG4gIGFuZ3VsYXIubW9kdWxlKG1vZHVsZSkuZGlyZWN0aXZlKCdkaXZlcnNpZmljYXRpb25UYXNrJywgZnVuY3Rpb24oKXtcbiAgICByZXR1cm4ge1xuICAgICAgc2NvcGU6IHtcbiAgICAgICAgb25SZXNvbHZlOiAnJmRpdmVyc2lmaWNhdGlvblRhc2tPblJlc29sdmUnXG4gICAgICB9LFxuICAgICAgcmVzdHJpY3Q6ICdBJyxcbiAgICAgIHRyYW5zY2x1ZGU6IHRydWUsXG4gICAgICBiaW5kVG9Db250cm9sbGVyOiB0cnVlLFxuICAgICAgY29udHJvbGxlcjogRGl2ZXJzaWZpY2F0aW9uVGFzayxcbiAgICAgIGNvbnRyb2xsZXJBczogJ2RpdmVyc2lmaWNhdGlvblRhc2tDb250cm9sbGVyJyxcbiAgICAgIHRlbXBsYXRlVXJsOiAndmlld3MvZGlyZWN0aXZlcy90YXNrcy9kaXZlcnNpZmljYXRpb24tdGFzay5odG1sJ1xuICAgIH07XG4gIH0pO1xuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIERpdmVyc2lmaWNhdGlvblRhc2sgQ29pblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuXG4gIC8vXG4gIC8vIENPTlRST0xMRVJcbiAgLy9cblxuICAvKipcbiAgICogQGNvbnN0cnVjdG9yXG4gICAqL1xuICB2YXIgRGl2ZXJzaWZpY2F0aW9uVGFza0NvaW4gPSBmdW5jdGlvbigkc2NvcGUsJGVsZW1lbnQsJGF0dHJzLCRpbmplY3Rvcikge1xuICAgIHRoaXMuJHNjb3BlID0gJHNjb3BlO1xuICAgIHRoaXMuJGF0dHJzID0gJGF0dHJzO1xuICAgIHRoaXMuJGVsZW1lbnQgPSAkZWxlbWVudDtcbiAgICB0aGlzLiRpbmplY3RvciA9ICRpbmplY3RvcjtcblxuICAgIHRoaXMuYW5pbWF0ZVxuICAgIHRoaXMuX2VsZW1lbnQgPSB0aGlzLiRlbGVtZW50LmZpbmQoJy5jb2luJyk7XG4gICAgdGhpcy5fYW5pbWF0aW9uRW5kRXZlbnQgPSB0aGlzLl9nZXRBbmltYXRpb25FbmRFdmVudCgpO1xuICB9O1xuXG4gIERpdmVyc2lmaWNhdGlvblRhc2tDb2luLiRpbmplY3QgPSBbJyRzY29wZScsJyRlbGVtZW50JywnJGF0dHJzJywnJGluamVjdG9yJ107XG5cbiAgLy9cbiAgLy8gUFJPUEVSVElFU1xuICAvL1xuXG4gIC8qKiBAdmFyIHtzdHJpbmd9IHRvc3MgT25lIG9mIGBoZWFkc2Agb3IgYHRhaWxzYC4gKi9cbiAgRGl2ZXJzaWZpY2F0aW9uVGFza0NvaW4ucHJvdG90eXBlLnRvc3MgPSBudWxsO1xuXG4gIC8qKiBAdmFyIHtzdHJpbmd9IGhlYWRzIEN1cnJlbnQgY2xhc3Mgb2YgaGVhZHMgc2lkZS4gKi9cbiAgRGl2ZXJzaWZpY2F0aW9uVGFza0NvaW4ucHJvdG90eXBlLnNpZGVzID0gW107XG5cbiAgLyoqIEB2YXIge3N0cmluZ30gaGVhZHMgQ3VycmVudCBjbGFzcyBvZiBoZWFkcyBzaWRlLiAqL1xuICBEaXZlcnNpZmljYXRpb25UYXNrQ29pbi5wcm90b3R5cGUuaGVhZHMgPSAnSyc7XG5cbiAgLyoqIEB2YXIge3N0cmluZ30gdGFpbHMgQ3VycmVudCBjbGFzcyBvZiB0YWlscyBzaWRlLiAqL1xuICBEaXZlcnNpZmljYXRpb25UYXNrQ29pbi5wcm90b3R5cGUudGFpbHMgPSAnWic7XG5cbiAgLyoqIEB2YXIge2Jvb2xlYW59IGZsaXAgRmxhZyB0byBpbnZva2UgYSBuZXcgdG9zcy4gKi9cbiAgRGl2ZXJzaWZpY2F0aW9uVGFza0NvaW4ucHJvdG90eXBlLmZsaXAgPSBmYWxzZTtcblxuICAvKiogQHZhciB7Ym9vbGVhbn0gZmxpcCBGbGFnIHRvIGFwcGx5IENTUyBjbGFzc2VzLiAqL1xuICBEaXZlcnNpZmljYXRpb25UYXNrQ29pbi5wcm90b3R5cGUuYW5pbWF0ZSA9IGZhbHNlO1xuXG4gIC8qKiBAdmFyIHtzdHJpbmd9IGJhY2tDbGFzcyBDU1MgY2xhc3MgZm9yIGJhY2sgc2lkZS4gKi9cbiAgRGl2ZXJzaWZpY2F0aW9uVGFza0NvaW4ucHJvdG90eXBlLmJhY2sgPSAnYmFjayc7XG5cbiAgLyoqIEB2YXIge3N0cmluZ30gZnJvbnRDbGFzcyBDU1MgY2xhc3MgZm9yIGZyb250IHNpZGUuICovXG4gIERpdmVyc2lmaWNhdGlvblRhc2tDb2luLnByb3RvdHlwZS5mcm9udCA9ICdmcm9udCc7XG5cbiAgLyoqIEB2YXIge3N0cmluZ30gc3RhcnRTaWRlIEluaXRpYWxseSBkaXNwbGF5ZWQgc2lkZSBvZiBjb2luLiAqL1xuICBEaXZlcnNpZmljYXRpb25UYXNrQ29pbi5wcm90b3R5cGUuc3RhcnRTaWRlID0gJ0snO1xuXG4gIC8vXG4gIC8vIE1FVEhPRFNcbiAgLy9cblxuICAvKipcbiAgICogU2V0cyB1cFxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgJG9uRGVzdHJveVxuICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgKi9cbiAgRGl2ZXJzaWZpY2F0aW9uVGFza0NvaW4ucHJvdG90eXBlLiRvbkluaXQgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgJHRpbWVvdXQgPSB0aGlzLiRpbmplY3Rvci5nZXQoJyR0aW1lb3V0Jyk7XG4gICAgdmFyIG1lID0gdGhpcztcblxuICAgIHRoaXMuc2lkZXMgPSBbXG4gICAgICB7XG4gICAgICAgIHZhbHVlOiB0aGlzLmhlYWRzLFxuICAgICAgICBjbGFzczogdGhpcy5mcm9udFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgdmFsdWU6IHRoaXMudGFpbHMsXG4gICAgICAgIGNsYXNzOiB0aGlzLmJhY2tcbiAgICAgIH1cbiAgICBdO1xuXG4gICAgaWYgKHRoaXMuc3RhcnRTaWRlICE9PSB0aGlzLmhlYWRzKSB7XG4gICAgICB0aGlzLnNpZGVzWzBdLmNsYXNzID0gdGhpcy5iYWNrO1xuICAgICAgdGhpcy5zaWRlc1sxXS5jbGFzcyA9IHRoaXMuZnJvbnQ7XG4gICAgfVxuXG4gICAgbWUuX3Rvc3MgPSBtZS5fZ2V0VG9zcygpO1xuXG4gICAgdmFyIF90aW1lb3V0Q2FsbGJhY2sgPSBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBfaXRlcmF0ZVNpZGVzID0gZnVuY3Rpb24oc2lkZSkge1xuICAgICAgICBpZiAoc2lkZS52YWx1ZSA9PT0gbWUuX3Rvc3MudmFsdWUpIHtcbiAgICAgICAgICBzaWRlLmNsYXNzID0gbWUuZnJvbnQ7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgc2lkZS5jbGFzcyA9IG1lLmJhY2s7XG4gICAgICB9O1xuXG4gICAgICBhbmd1bGFyLmZvckVhY2gobWUuc2lkZXMsIF9pdGVyYXRlU2lkZXMpO1xuICAgIH07XG5cbiAgICB2YXIgX3dhdGNoRmxpcENhbGxiYWNrID0gZnVuY3Rpb24obmV3RmxpcC8qLG9sZEZsaXAqLykge1xuICAgICAgaWYgKG5ld0ZsaXApIHtcbiAgICAgICAgbWUub25TdGFydCh7dG9zczogbWUuX3Rvc3MudmFsdWV9KTtcbiAgICAgICAgJHRpbWVvdXQoX3RpbWVvdXRDYWxsYmFjaywgMTAwKTtcbiAgICAgICAgbWUuYW5pbWF0ZSA9IHRydWU7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHZhciBfd2F0Y2hGbGlwRXhwcmVzc2lvbiA9IGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIG1lLmZsaXA7XG4gICAgfTtcblxuICAgIHZhciBfd2F0Y2hUb3NzQ2FsbGJhY2sgPSBmdW5jdGlvbihuZXdUb3NzLCBvbGRUb3NzKSB7XG4gICAgICBpZiAobmV3VG9zcyAhPT0gb2xkVG9zcykge1xuICAgICAgICBtZS5fdG9zcyA9IG1lLl9nZXRUb3NzKCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIHZhciBfd2F0Y2hUb3NzRXhwcmVzc2lvbiA9IGZ1bmN0aW9uKCkge1xuICAgICAgcmV0dXJuIG1lLnRvc3M7XG4gICAgfTtcblxuICAgIHZhciBfZXZhbEFzeW5jQ2FsbGJhY2sgPSBmdW5jdGlvbigpIHtcbiAgICAgIG1lLm9uRmluaXNoKHt0b3NzOiBtZS5fdG9zcy52YWx1ZX0pO1xuICAgICAgbWUuYW5pbWF0ZSA9IGZhbHNlO1xuICAgIH07XG5cbiAgICB2YXIgX2FuaW1hdGlvbkVuZENhbGxiYWNrID0gZnVuY3Rpb24oKSB7XG4gICAgICBtZS4kc2NvcGUuJGV2YWxBc3luYyhfZXZhbEFzeW5jQ2FsbGJhY2spO1xuICAgIH07XG5cbiAgICB0aGlzLm9uSW5pdCh7dG9zczogbWUuX3Rvc3MudmFsdWV9KTtcblxuICAgIGlmICh0aGlzLl9hbmltYXRpb25FbmRFdmVudCkge1xuICAgICAgdGhpcy5fZWxlbWVudC5vbih0aGlzLl9hbmltYXRpb25FbmRFdmVudCwgX2FuaW1hdGlvbkVuZENhbGxiYWNrKTtcbiAgICB9XG5cbiAgICB0aGlzLl91bndhdGNoRmxpcCA9IHRoaXMuJHNjb3BlLiR3YXRjaChfd2F0Y2hGbGlwRXhwcmVzc2lvbiwgX3dhdGNoRmxpcENhbGxiYWNrKTtcbiAgICB0aGlzLl91bndhdGNoVG9zcyA9IHRoaXMuJHNjb3BlLiR3YXRjaChfd2F0Y2hUb3NzRXhwcmVzc2lvbiwgX3dhdGNoVG9zc0NhbGxiYWNrKTtcbiAgfTtcblxuICAvKipcbiAgICogUmVtb3ZlcyBldmVudCBsaXN0ZW5lciBhbmQgd2F0Y2hlcy5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kICRvbkRlc3Ryb3lcbiAgICogQHJldHVybiB7dm9pZH1cbiAgICovXG4gIERpdmVyc2lmaWNhdGlvblRhc2tDb2luLnByb3RvdHlwZS4kb25EZXN0cm95ID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5fZWxlbWVudC5vZmYodGhpcy5fYW5pbWF0aW9uRW5kRXZlbnQpO1xuICAgIHRoaXMuX3Vud2F0Y2hUb3NzKCk7XG4gICAgdGhpcy5fdW53YXRjaEZsaXAoKTtcbiAgfTtcblxuICAvKipcbiAgICogR2V0cyBjb3JyZWN0bHkgcHJlZml4ZWQgdHJhbnNpdGlvbiBldmVudC5cbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQG1ldGhvZCBfZ2V0VHJhbnNpdGlvbkV2ZW50XG4gICAqIEByZXR1cm4ge3ZvaWR9XG4gICAqL1xuICBEaXZlcnNpZmljYXRpb25UYXNrQ29pbi5wcm90b3R5cGUuX2dldEFuaW1hdGlvbkVuZEV2ZW50ID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIGR1bW15ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgdmFyIHRyYW5zaXRpb25zID0ge1xuICAgICAgJ1dlYmtpdEFuaW1hdGlvbic6ICd3ZWJraXRBbmltYXRpb25FbmQnLFxuICAgICAgJ01velRBbmltYXRpb24nOiAnYW5pbWF0aW9uZW5kJyxcbiAgICAgICdhbmltYXRpb24nOiAnYW5pbWF0aW9uZW5kJ1xuICAgIH07XG5cbiAgICBmb3IodmFyIGtleSBpbiB0cmFuc2l0aW9ucyl7XG4gICAgICAgIHZhciBldmVudCA9IGR1bW15LnN0eWxlW2tleV07XG4gICAgICAgIGlmKCBldmVudCAhPT0gdW5kZWZpbmVkICl7XG4gICAgICAgICAgcmV0dXJuIHRyYW5zaXRpb25zW2tleV07XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbnVsbDtcbiAgfTtcblxuICAvKipcbiAgICogVHJhbnNmb3JtcyBgdG9zc2AgdG8gb25lIHNpZGUgZWl0aGVyXG4gICAqIGJ5IHJhbmRvbSBvciBieSBnaXZlbiBjb25zdW1lciBpbnB1dC5cbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQG1ldGhvZCBfZ2V0VG9zc1xuICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgKi9cbiAgRGl2ZXJzaWZpY2F0aW9uVGFza0NvaW4ucHJvdG90eXBlLl9nZXRUb3NzID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyICRmaWx0ZXIgPSB0aGlzLiRpbmplY3Rvci5nZXQoJyRmaWx0ZXInKTtcbiAgICB2YXIgcmFuZG9tID0gdGhpcy4kaW5qZWN0b3IuZ2V0KCdyYW5kb20nKTtcbiAgICB2YXIgcGlja2VkID0gcmFuZG9tLnBpY2sodGhpcy5zaWRlcyk7XG5cbiAgICBpZiAodGhpcy50b3NzID09PSBudWxsKSB7XG4gICAgICByZXR1cm4gcGlja2VkO1xuICAgIH1cblxuICAgIHZhciBmaWx0ZXJlZCA9ICRmaWx0ZXIoJ2ZpbHRlcicpKFxuICAgICAgdGhpcy5zaWRlcyxcbiAgICAgIHtcbiAgICAgICAgdmFsdWU6IHRoaXMudG9zc1xuICAgICAgfVxuICAgICk7XG5cbiAgICBpZiAoZmlsdGVyZWQubGVuZ3RoID09PSAwKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ0ludmFsaWQgdmFsdWUgZm9yIGB0b3NzYCAtIHVzaW5nIHJhbmRvbSB2YWx1ZSEnKTtcbiAgICAgIHJldHVybiBwaWNrZWQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZpbHRlcmVkWzBdO1xuICB9O1xuXG4gIC8vXG4gIC8vIFJFR0lTVFJZXG4gIC8vXG4gIGFuZ3VsYXIubW9kdWxlKG1vZHVsZSkuZGlyZWN0aXZlKCdkaXZlcnNpZmljYXRpb25UYXNrQ29pbicsIGZ1bmN0aW9uKCl7XG4gICAgcmV0dXJuIHtcbiAgICAgIHNjb3BlOiB7XG4gICAgICAgIHRvc3M6ICc9P2RpdmVyc2lmaWNhdGlvblRhc2tDb2luVG9zcycsXG4gICAgICAgIGZsaXA6ICc9P2RpdmVyc2lmaWNhdGlvblRhc2tDb2luRmxpcCcsXG4gICAgICAgIG9uSW5pdDogJyZkaXZlcnNpZmljYXRpb25UYXNrQ29pbk9uSW5pdCcsXG4gICAgICAgIG9uU3RhcnQ6ICcmZGl2ZXJzaWZpY2F0aW9uVGFza0NvaW5PblN0YXJ0JyxcbiAgICAgICAgb25GaW5pc2g6ICcmZGl2ZXJzaWZpY2F0aW9uVGFza0NvaW5PbkZpbmlzaCcsXG4gICAgICAgIHN0YXJ0U2lkZTogJz0/ZGl2ZXJzaWZpY2F0aW9uVGFza0NvaW5TdGFydFNpZGUnXG4gICAgICB9LFxuICAgICAgcmVzdHJpY3Q6ICdBJyxcbiAgICAgIHRyYW5zY2x1ZGU6IHRydWUsXG4gICAgICBiaW5kVG9Db250cm9sbGVyOiB0cnVlLFxuICAgICAgY29udHJvbGxlcjogRGl2ZXJzaWZpY2F0aW9uVGFza0NvaW4sXG4gICAgICBjb250cm9sbGVyQXM6ICdkaXZlcnNpZmljYXRpb25UYXNrQ29pbkNvbnRyb2xsZXInLFxuICAgICAgdGVtcGxhdGVVcmw6ICd2aWV3cy9kaXJlY3RpdmVzL3Rhc2tzL2RpdmVyc2lmaWNhdGlvbi10YXNrLWNvaW4uaHRtbCdcbiAgICB9O1xuICB9KTtcblxufSkoQU5HVUxBUl9NT0RVTEUsIGFuZ3VsYXIpO1xuIl19

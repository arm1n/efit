/*!
 * eFit Website
 * An app for financial training in educational environments
 * http://www.e-fit.com
 * @author Armin Pfurtscheller
 * @version 1.0.0
 * Copyright 2017. MIT licensed.
 */
/* global ANGULAR_MODULE, angular */
(function(module, angular) {
  'use strict';

  // --------------------------------------------------
  // BombTask
  // --------------------------------------------------

  //
  // CONTROLLER
  //

  /**
   * @constructor
   */
  var BombTask = function($scope, $attrs, $element, $filter, $interval, randomService) {
    this.$interval = $interval;
    this.$element = $element;
    this.$filter = $filter;
    this.$attrs = $attrs;
    this.$scope = $scope;

    this.randomService = randomService;

    this.avg = 12;
    this.rows = 5;
    this.cols = 5;
    this.interval = 1;
    this.random = false;
    this.dynamic = false;

    this.totalBoxes = 0;
    this.stopped = false;
    this.started = false;
    this.hasBomb = false;
    this.resolved = false;
    this.remainingBoxes = 0;
    this.collectedBoxes = 0;
  };

  BombTask.$inject = ['$scope', '$attrs', '$element', '$filter', '$interval', 'random'];

  //
  // METHODS
  //

  /**
   * Proxies to `init()` if controller's ready.
   *
   * @public
   * @method $onInit
   * @return {Void}
   */
  BombTask.prototype.$onInit = function() {
    this.init();
  };

  /**
   * Sets up initial state.
   *
   * @public
   * @method init
   * @return {Void}
   */
  BombTask.prototype.init = function() {
    this._initMembers();
    this._initMatrix();
    this._initBomb();

    if (!this.dynamic) {
      this.start();
    }
  };

  /**
   * Resets initial state.
   *
   * @public
   * @method reset
   * @return {Void}
   */
  BombTask.prototype.reset = function() {
    this.init();
  };

  /**
   * Sets `started` flag. If `dynamic` is true,
   * the interval will start to reveal cards.
   *
   * @public
   * @method start
   * @return {Void}
   */
  BombTask.prototype.start = function(index) {
    if (this.dynamic) {
      var me = this;
      var max = this.iterator.length;

      this._intIndex = index || 0;
      this._intervalId = me.$interval(
        function(){

          var item = me.iterator[me._intIndex];
          me.update(item,true);

          me._intIndex++;
          if (me._intIndex===max) {
            me.stop();
          }

        },
        this.interval*1000, // = from seconds
        max - this._intIndex // = max iterations
      );
    }

    this.started = true;
  };

  /**
   * Sets `stopped` flag. If `dynamic` is true,
   * the interval will be stopped in addition.
   *
   * @public
   * @method start
   * @return {Void}
   */
  BombTask.prototype.stop = function() {
    if (this.dynamic && this._intervalId) {
      this.$interval.cancel(this._intervalId);
    }

    this.stopped = true;
  };

  /**
   * Sets `resolved` flag. Calls `onResolve`
   * callback with JSON result for consumer.
   *
   * @public
   * @method resolve
   * @return {Void}
   */
  BombTask.prototype.resolve = function() {
    for (var i=0; i<this.collection.length; i++) {
      this.collection[i].$$resolved = true;
    }

    this.resolved = true;
    this.onResolve();
  };

  /**
   * Callback for card click. Updates all
   * related properties for final result.
   *
   * @public
   * @method update
   * @param {object} column
   * @param {boolean} active
   * @return {Void}
   */
  BombTask.prototype.update = function(column, active) {
    var index = this.collection.indexOf(column);

    if (active) {
      if (index<0)Â {
        this.collection.push(column);
        this.collectedBoxes++;
      }

      column.$$active = true;
    } else {
      if (index>=0) {
        this.collection.splice(index,1);
        column.$$active = false;
        this.collectedBoxes--;
      }
    }

    if (this.isBomb(column)) {
      this.hasBomb = true;
    }

    var total = this.totalBoxes;
    var collected = this.collectedBoxes;
    this.remainingBoxes = total - collected;
  };

  /**
   * Provides indiviual tracking id for column.
   *
   * @public
   * @method trackId
   * @param {object} column
   * @return {Void}
   */
  BombTask.prototype.trackId = function(column) {
    return column.row + '_' + column.col;
  };

  /**
   * Determines if column is actual bomb.
   *
   * @public
   * @method isBomb
   * @param {object} column
   * @return {Void}
   */
  BombTask.prototype.isBomb = function(column) {
    return angular.equals(this.bomb,column);
  };

  /**
   * Initialzes internal properties.
   *
   * @private
   * @method _initMembers
   * @return {Void}
   */
  BombTask.prototype._initMembers = function() {
    this.collection = [];

    this.hasBomb = false;
    this.started = false;
    this.stopped = false;
    this.resolved = false;

    this.collectedBoxes = 0;
    this.remainingBoxes = 0;
    this.totalBoxes = this.rows * this.cols;
  };

  /**
   * Calculates the actual matrix.
   *
   * @private
   * @method _initMatrix
   * @return {Void}
   */
  BombTask.prototype._initMatrix = function() {
    this.matrix = [];
    this.iterator = [];

    for (var i=0; i<this.rows; i++) {

      var columns = [];
      for( var j=0; j<this.cols; j++ ) {
        var data = {
          row: i+1,
          col: j+1
        };

        columns.push(data);

        if (this.dynamic) {
          if (!this.random) {
            this.iterator.push(data);
          } else {
            this.randomService.push(this.iterator,data);
          }
        }
      }

      this.matrix.push(columns);
    }
  };

  /**
   * Initializes bomb's actual location.
   *
   * @private
   * @method _initBomb
   * @return {Void}
   */
  BombTask.prototype._initBomb = function() {
    var row = this.randomService.between(0,this.rows-1);
    var col = this.randomService.between(0,this.cols-1);

    this.bomb = this.matrix[row][col];
  };

  //
  // REGISTRY
  //
  angular.module(module).directive('bombTask',function(){
    return {
      scope: {
        avg: '=?bombTaskAvg',
        rows: '=?bombTaskRows',
        cols: '=?bombTaskCols',
        random: '=?bombTaskRandom',
        dynamic: '=?bombTaskDynamic',
        interval: '=?bombTaskInterval',
        onResolve: '&bombTaskOnResolve'
      },
      restrict: 'A',
      transclude: true,
      controller: BombTask,
      bindToController: true,
      controllerAs: 'bombTaskController',
      templateUrl: 'views/directives/bomb-task.html'
    };
  });

  // --------------------------------------------------
  // BombTask Card
  // --------------------------------------------------

  //
  // CONTROLLER
  //

  /**
   * @constructor
   */
  var BombTaskCard = function(){
  };

  //
  // PROPERTIES
  //

  /** @var {string} id Card's accociated model. */
  BombTaskCard.prototype.model = null;

  /** @var {string} isActive If card is active. */
  BombTaskCard.prototype.isActive = false;

  /** @var {string} isDisabled If card is disabled. */
  BombTaskCard.prototype.isDisabled = false;

  /** @var {string} isClickable If card is clickable. */
  BombTaskCard.prototype.isClickable = true;

  //
  // METHODS
  //

  /**
   * Toggles `isActive` if `isDisabled` and
   * `isClickable` allow the action. Invokes
   * `onToggle` callback for consumer.
   *
   * @public
   * @method toggle
   * @return {Void}
   */
  BombTaskCard.prototype.toggle = function() {
    if (this.isDisabled || !this.isClickable) {
      return;
    }

    this.isActive = !this.isActive;

    this.onToggle({
      model:this.model,
      state:this.isActive
    });
  };

  // registry
  angular.module(module).directive('bombTaskCard', function(){
    return {
      scope: {
        model:'=bombTaskCard',
        onToggle:'&bombTaskCardOnToggle',
        isActive:'=?bombTaskCardIsActive',
        isDisabled:'=?bombTaskCardIsDisabled',
        isClickable:'=?bombTaskCardIsClickable'
      },
      restrict: 'A',
      transclude: true,
      controller: BombTaskCard,
      bindToController: true,
      controllerAs: 'bombTaskCardController',
      templateUrl: 'views/directives/bomb-task-card.html'
    };
  });

})(ANGULAR_MODULE, angular);

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9kaXJlY3RpdmVzL2JvbWItdGFzay5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImFwcC9kaXJlY3RpdmVzL2JvbWItdGFzay5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBnbG9iYWwgQU5HVUxBUl9NT0RVTEUsIGFuZ3VsYXIgKi9cbihmdW5jdGlvbihtb2R1bGUsIGFuZ3VsYXIpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIEJvbWJUYXNrXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgLy9cbiAgLy8gQ09OVFJPTExFUlxuICAvL1xuXG4gIC8qKlxuICAgKiBAY29uc3RydWN0b3JcbiAgICovXG4gIHZhciBCb21iVGFzayA9IGZ1bmN0aW9uKCRzY29wZSwgJGF0dHJzLCAkZWxlbWVudCwgJGZpbHRlciwgJGludGVydmFsLCByYW5kb21TZXJ2aWNlKSB7XG4gICAgdGhpcy4kaW50ZXJ2YWwgPSAkaW50ZXJ2YWw7XG4gICAgdGhpcy4kZWxlbWVudCA9ICRlbGVtZW50O1xuICAgIHRoaXMuJGZpbHRlciA9ICRmaWx0ZXI7XG4gICAgdGhpcy4kYXR0cnMgPSAkYXR0cnM7XG4gICAgdGhpcy4kc2NvcGUgPSAkc2NvcGU7XG5cbiAgICB0aGlzLnJhbmRvbVNlcnZpY2UgPSByYW5kb21TZXJ2aWNlO1xuXG4gICAgdGhpcy5hdmcgPSAxMjtcbiAgICB0aGlzLnJvd3MgPSA1O1xuICAgIHRoaXMuY29scyA9IDU7XG4gICAgdGhpcy5pbnRlcnZhbCA9IDE7XG4gICAgdGhpcy5yYW5kb20gPSBmYWxzZTtcbiAgICB0aGlzLmR5bmFtaWMgPSBmYWxzZTtcblxuICAgIHRoaXMudG90YWxCb3hlcyA9IDA7XG4gICAgdGhpcy5zdG9wcGVkID0gZmFsc2U7XG4gICAgdGhpcy5zdGFydGVkID0gZmFsc2U7XG4gICAgdGhpcy5oYXNCb21iID0gZmFsc2U7XG4gICAgdGhpcy5yZXNvbHZlZCA9IGZhbHNlO1xuICAgIHRoaXMucmVtYWluaW5nQm94ZXMgPSAwO1xuICAgIHRoaXMuY29sbGVjdGVkQm94ZXMgPSAwO1xuICB9O1xuXG4gIEJvbWJUYXNrLiRpbmplY3QgPSBbJyRzY29wZScsICckYXR0cnMnLCAnJGVsZW1lbnQnLCAnJGZpbHRlcicsICckaW50ZXJ2YWwnLCAncmFuZG9tJ107XG5cbiAgLy9cbiAgLy8gTUVUSE9EU1xuICAvL1xuXG4gIC8qKlxuICAgKiBQcm94aWVzIHRvIGBpbml0KClgIGlmIGNvbnRyb2xsZXIncyByZWFkeS5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kICRvbkluaXRcbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEJvbWJUYXNrLnByb3RvdHlwZS4kb25Jbml0ID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5pbml0KCk7XG4gIH07XG5cbiAgLyoqXG4gICAqIFNldHMgdXAgaW5pdGlhbCBzdGF0ZS5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIGluaXRcbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEJvbWJUYXNrLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5faW5pdE1lbWJlcnMoKTtcbiAgICB0aGlzLl9pbml0TWF0cml4KCk7XG4gICAgdGhpcy5faW5pdEJvbWIoKTtcblxuICAgIGlmICghdGhpcy5keW5hbWljKSB7XG4gICAgICB0aGlzLnN0YXJ0KCk7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBSZXNldHMgaW5pdGlhbCBzdGF0ZS5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIHJlc2V0XG4gICAqIEByZXR1cm4ge1ZvaWR9XG4gICAqL1xuICBCb21iVGFzay5wcm90b3R5cGUucmVzZXQgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLmluaXQoKTtcbiAgfTtcblxuICAvKipcbiAgICogU2V0cyBgc3RhcnRlZGAgZmxhZy4gSWYgYGR5bmFtaWNgIGlzIHRydWUsXG4gICAqIHRoZSBpbnRlcnZhbCB3aWxsIHN0YXJ0IHRvIHJldmVhbCBjYXJkcy5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIHN0YXJ0XG4gICAqIEByZXR1cm4ge1ZvaWR9XG4gICAqL1xuICBCb21iVGFzay5wcm90b3R5cGUuc3RhcnQgPSBmdW5jdGlvbihpbmRleCkge1xuICAgIGlmICh0aGlzLmR5bmFtaWMpIHtcbiAgICAgIHZhciBtZSA9IHRoaXM7XG4gICAgICB2YXIgbWF4ID0gdGhpcy5pdGVyYXRvci5sZW5ndGg7XG5cbiAgICAgIHRoaXMuX2ludEluZGV4ID0gaW5kZXggfHwgMDtcbiAgICAgIHRoaXMuX2ludGVydmFsSWQgPSBtZS4kaW50ZXJ2YWwoXG4gICAgICAgIGZ1bmN0aW9uKCl7XG5cbiAgICAgICAgICB2YXIgaXRlbSA9IG1lLml0ZXJhdG9yW21lLl9pbnRJbmRleF07XG4gICAgICAgICAgbWUudXBkYXRlKGl0ZW0sdHJ1ZSk7XG5cbiAgICAgICAgICBtZS5faW50SW5kZXgrKztcbiAgICAgICAgICBpZiAobWUuX2ludEluZGV4PT09bWF4KSB7XG4gICAgICAgICAgICBtZS5zdG9wKCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgIH0sXG4gICAgICAgIHRoaXMuaW50ZXJ2YWwqMTAwMCwgLy8gPSBmcm9tIHNlY29uZHNcbiAgICAgICAgbWF4IC0gdGhpcy5faW50SW5kZXggLy8gPSBtYXggaXRlcmF0aW9uc1xuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLnN0YXJ0ZWQgPSB0cnVlO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTZXRzIGBzdG9wcGVkYCBmbGFnLiBJZiBgZHluYW1pY2AgaXMgdHJ1ZSxcbiAgICogdGhlIGludGVydmFsIHdpbGwgYmUgc3RvcHBlZCBpbiBhZGRpdGlvbi5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIHN0YXJ0XG4gICAqIEByZXR1cm4ge1ZvaWR9XG4gICAqL1xuICBCb21iVGFzay5wcm90b3R5cGUuc3RvcCA9IGZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLmR5bmFtaWMgJiYgdGhpcy5faW50ZXJ2YWxJZCkge1xuICAgICAgdGhpcy4kaW50ZXJ2YWwuY2FuY2VsKHRoaXMuX2ludGVydmFsSWQpO1xuICAgIH1cblxuICAgIHRoaXMuc3RvcHBlZCA9IHRydWU7XG4gIH07XG5cbiAgLyoqXG4gICAqIFNldHMgYHJlc29sdmVkYCBmbGFnLiBDYWxscyBgb25SZXNvbHZlYFxuICAgKiBjYWxsYmFjayB3aXRoIEpTT04gcmVzdWx0IGZvciBjb25zdW1lci5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIHJlc29sdmVcbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEJvbWJUYXNrLnByb3RvdHlwZS5yZXNvbHZlID0gZnVuY3Rpb24oKSB7XG4gICAgZm9yICh2YXIgaT0wOyBpPHRoaXMuY29sbGVjdGlvbi5sZW5ndGg7IGkrKykge1xuICAgICAgdGhpcy5jb2xsZWN0aW9uW2ldLiQkcmVzb2x2ZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIHRoaXMucmVzb2x2ZWQgPSB0cnVlO1xuICAgIHRoaXMub25SZXNvbHZlKCk7XG4gIH07XG5cbiAgLyoqXG4gICAqIENhbGxiYWNrIGZvciBjYXJkIGNsaWNrLiBVcGRhdGVzIGFsbFxuICAgKiByZWxhdGVkIHByb3BlcnRpZXMgZm9yIGZpbmFsIHJlc3VsdC5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIHVwZGF0ZVxuICAgKiBAcGFyYW0ge29iamVjdH0gY29sdW1uXG4gICAqIEBwYXJhbSB7Ym9vbGVhbn0gYWN0aXZlXG4gICAqIEByZXR1cm4ge1ZvaWR9XG4gICAqL1xuICBCb21iVGFzay5wcm90b3R5cGUudXBkYXRlID0gZnVuY3Rpb24oY29sdW1uLCBhY3RpdmUpIHtcbiAgICB2YXIgaW5kZXggPSB0aGlzLmNvbGxlY3Rpb24uaW5kZXhPZihjb2x1bW4pO1xuXG4gICAgaWYgKGFjdGl2ZSkge1xuICAgICAgaWYgKGluZGV4PDApwqB7XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbi5wdXNoKGNvbHVtbik7XG4gICAgICAgIHRoaXMuY29sbGVjdGVkQm94ZXMrKztcbiAgICAgIH1cblxuICAgICAgY29sdW1uLiQkYWN0aXZlID0gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKGluZGV4Pj0wKSB7XG4gICAgICAgIHRoaXMuY29sbGVjdGlvbi5zcGxpY2UoaW5kZXgsMSk7XG4gICAgICAgIGNvbHVtbi4kJGFjdGl2ZSA9IGZhbHNlO1xuICAgICAgICB0aGlzLmNvbGxlY3RlZEJveGVzLS07XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNCb21iKGNvbHVtbikpIHtcbiAgICAgIHRoaXMuaGFzQm9tYiA9IHRydWU7XG4gICAgfVxuXG4gICAgdmFyIHRvdGFsID0gdGhpcy50b3RhbEJveGVzO1xuICAgIHZhciBjb2xsZWN0ZWQgPSB0aGlzLmNvbGxlY3RlZEJveGVzO1xuICAgIHRoaXMucmVtYWluaW5nQm94ZXMgPSB0b3RhbCAtIGNvbGxlY3RlZDtcbiAgfTtcblxuICAvKipcbiAgICogUHJvdmlkZXMgaW5kaXZpdWFsIHRyYWNraW5nIGlkIGZvciBjb2x1bW4uXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCB0cmFja0lkXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBjb2x1bW5cbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEJvbWJUYXNrLnByb3RvdHlwZS50cmFja0lkID0gZnVuY3Rpb24oY29sdW1uKSB7XG4gICAgcmV0dXJuIGNvbHVtbi5yb3cgKyAnXycgKyBjb2x1bW4uY29sO1xuICB9O1xuXG4gIC8qKlxuICAgKiBEZXRlcm1pbmVzIGlmIGNvbHVtbiBpcyBhY3R1YWwgYm9tYi5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIGlzQm9tYlxuICAgKiBAcGFyYW0ge29iamVjdH0gY29sdW1uXG4gICAqIEByZXR1cm4ge1ZvaWR9XG4gICAqL1xuICBCb21iVGFzay5wcm90b3R5cGUuaXNCb21iID0gZnVuY3Rpb24oY29sdW1uKSB7XG4gICAgcmV0dXJuIGFuZ3VsYXIuZXF1YWxzKHRoaXMuYm9tYixjb2x1bW4pO1xuICB9O1xuXG4gIC8qKlxuICAgKiBJbml0aWFsemVzIGludGVybmFsIHByb3BlcnRpZXMuXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEBtZXRob2QgX2luaXRNZW1iZXJzXG4gICAqIEByZXR1cm4ge1ZvaWR9XG4gICAqL1xuICBCb21iVGFzay5wcm90b3R5cGUuX2luaXRNZW1iZXJzID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5jb2xsZWN0aW9uID0gW107XG5cbiAgICB0aGlzLmhhc0JvbWIgPSBmYWxzZTtcbiAgICB0aGlzLnN0YXJ0ZWQgPSBmYWxzZTtcbiAgICB0aGlzLnN0b3BwZWQgPSBmYWxzZTtcbiAgICB0aGlzLnJlc29sdmVkID0gZmFsc2U7XG5cbiAgICB0aGlzLmNvbGxlY3RlZEJveGVzID0gMDtcbiAgICB0aGlzLnJlbWFpbmluZ0JveGVzID0gMDtcbiAgICB0aGlzLnRvdGFsQm94ZXMgPSB0aGlzLnJvd3MgKiB0aGlzLmNvbHM7XG4gIH07XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZXMgdGhlIGFjdHVhbCBtYXRyaXguXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEBtZXRob2QgX2luaXRNYXRyaXhcbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEJvbWJUYXNrLnByb3RvdHlwZS5faW5pdE1hdHJpeCA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMubWF0cml4ID0gW107XG4gICAgdGhpcy5pdGVyYXRvciA9IFtdO1xuXG4gICAgZm9yICh2YXIgaT0wOyBpPHRoaXMucm93czsgaSsrKSB7XG5cbiAgICAgIHZhciBjb2x1bW5zID0gW107XG4gICAgICBmb3IoIHZhciBqPTA7IGo8dGhpcy5jb2xzOyBqKysgKSB7XG4gICAgICAgIHZhciBkYXRhID0ge1xuICAgICAgICAgIHJvdzogaSsxLFxuICAgICAgICAgIGNvbDogaisxXG4gICAgICAgIH07XG5cbiAgICAgICAgY29sdW1ucy5wdXNoKGRhdGEpO1xuXG4gICAgICAgIGlmICh0aGlzLmR5bmFtaWMpIHtcbiAgICAgICAgICBpZiAoIXRoaXMucmFuZG9tKSB7XG4gICAgICAgICAgICB0aGlzLml0ZXJhdG9yLnB1c2goZGF0YSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMucmFuZG9tU2VydmljZS5wdXNoKHRoaXMuaXRlcmF0b3IsZGF0YSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHRoaXMubWF0cml4LnB1c2goY29sdW1ucyk7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplcyBib21iJ3MgYWN0dWFsIGxvY2F0aW9uLlxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAbWV0aG9kIF9pbml0Qm9tYlxuICAgKiBAcmV0dXJuIHtWb2lkfVxuICAgKi9cbiAgQm9tYlRhc2sucHJvdG90eXBlLl9pbml0Qm9tYiA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciByb3cgPSB0aGlzLnJhbmRvbVNlcnZpY2UuYmV0d2VlbigwLHRoaXMucm93cy0xKTtcbiAgICB2YXIgY29sID0gdGhpcy5yYW5kb21TZXJ2aWNlLmJldHdlZW4oMCx0aGlzLmNvbHMtMSk7XG5cbiAgICB0aGlzLmJvbWIgPSB0aGlzLm1hdHJpeFtyb3ddW2NvbF07XG4gIH07XG5cbiAgLy9cbiAgLy8gUkVHSVNUUllcbiAgLy9cbiAgYW5ndWxhci5tb2R1bGUobW9kdWxlKS5kaXJlY3RpdmUoJ2JvbWJUYXNrJyxmdW5jdGlvbigpe1xuICAgIHJldHVybiB7XG4gICAgICBzY29wZToge1xuICAgICAgICBhdmc6ICc9P2JvbWJUYXNrQXZnJyxcbiAgICAgICAgcm93czogJz0/Ym9tYlRhc2tSb3dzJyxcbiAgICAgICAgY29sczogJz0/Ym9tYlRhc2tDb2xzJyxcbiAgICAgICAgcmFuZG9tOiAnPT9ib21iVGFza1JhbmRvbScsXG4gICAgICAgIGR5bmFtaWM6ICc9P2JvbWJUYXNrRHluYW1pYycsXG4gICAgICAgIGludGVydmFsOiAnPT9ib21iVGFza0ludGVydmFsJyxcbiAgICAgICAgb25SZXNvbHZlOiAnJmJvbWJUYXNrT25SZXNvbHZlJ1xuICAgICAgfSxcbiAgICAgIHJlc3RyaWN0OiAnQScsXG4gICAgICB0cmFuc2NsdWRlOiB0cnVlLFxuICAgICAgY29udHJvbGxlcjogQm9tYlRhc2ssXG4gICAgICBiaW5kVG9Db250cm9sbGVyOiB0cnVlLFxuICAgICAgY29udHJvbGxlckFzOiAnYm9tYlRhc2tDb250cm9sbGVyJyxcbiAgICAgIHRlbXBsYXRlVXJsOiAndmlld3MvZGlyZWN0aXZlcy9ib21iLXRhc2suaHRtbCdcbiAgICB9O1xuICB9KTtcblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBCb21iVGFzayBDYXJkXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgLy9cbiAgLy8gQ09OVFJPTExFUlxuICAvL1xuXG4gIC8qKlxuICAgKiBAY29uc3RydWN0b3JcbiAgICovXG4gIHZhciBCb21iVGFza0NhcmQgPSBmdW5jdGlvbigpe1xuICB9O1xuXG4gIC8vXG4gIC8vIFBST1BFUlRJRVNcbiAgLy9cblxuICAvKiogQHZhciB7c3RyaW5nfSBpZCBDYXJkJ3MgYWNjb2NpYXRlZCBtb2RlbC4gKi9cbiAgQm9tYlRhc2tDYXJkLnByb3RvdHlwZS5tb2RlbCA9IG51bGw7XG5cbiAgLyoqIEB2YXIge3N0cmluZ30gaXNBY3RpdmUgSWYgY2FyZCBpcyBhY3RpdmUuICovXG4gIEJvbWJUYXNrQ2FyZC5wcm90b3R5cGUuaXNBY3RpdmUgPSBmYWxzZTtcblxuICAvKiogQHZhciB7c3RyaW5nfSBpc0Rpc2FibGVkIElmIGNhcmQgaXMgZGlzYWJsZWQuICovXG4gIEJvbWJUYXNrQ2FyZC5wcm90b3R5cGUuaXNEaXNhYmxlZCA9IGZhbHNlO1xuXG4gIC8qKiBAdmFyIHtzdHJpbmd9IGlzQ2xpY2thYmxlIElmIGNhcmQgaXMgY2xpY2thYmxlLiAqL1xuICBCb21iVGFza0NhcmQucHJvdG90eXBlLmlzQ2xpY2thYmxlID0gdHJ1ZTtcblxuICAvL1xuICAvLyBNRVRIT0RTXG4gIC8vXG5cbiAgLyoqXG4gICAqIFRvZ2dsZXMgYGlzQWN0aXZlYCBpZiBgaXNEaXNhYmxlZGAgYW5kXG4gICAqIGBpc0NsaWNrYWJsZWAgYWxsb3cgdGhlIGFjdGlvbi4gSW52b2tlc1xuICAgKiBgb25Ub2dnbGVgIGNhbGxiYWNrIGZvciBjb25zdW1lci5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIHRvZ2dsZVxuICAgKiBAcmV0dXJuIHtWb2lkfVxuICAgKi9cbiAgQm9tYlRhc2tDYXJkLnByb3RvdHlwZS50b2dnbGUgPSBmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5pc0Rpc2FibGVkIHx8ICF0aGlzLmlzQ2xpY2thYmxlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5pc0FjdGl2ZSA9ICF0aGlzLmlzQWN0aXZlO1xuXG4gICAgdGhpcy5vblRvZ2dsZSh7XG4gICAgICBtb2RlbDp0aGlzLm1vZGVsLFxuICAgICAgc3RhdGU6dGhpcy5pc0FjdGl2ZVxuICAgIH0pO1xuICB9O1xuXG4gIC8vIHJlZ2lzdHJ5XG4gIGFuZ3VsYXIubW9kdWxlKG1vZHVsZSkuZGlyZWN0aXZlKCdib21iVGFza0NhcmQnLCBmdW5jdGlvbigpe1xuICAgIHJldHVybiB7XG4gICAgICBzY29wZToge1xuICAgICAgICBtb2RlbDonPWJvbWJUYXNrQ2FyZCcsXG4gICAgICAgIG9uVG9nZ2xlOicmYm9tYlRhc2tDYXJkT25Ub2dnbGUnLFxuICAgICAgICBpc0FjdGl2ZTonPT9ib21iVGFza0NhcmRJc0FjdGl2ZScsXG4gICAgICAgIGlzRGlzYWJsZWQ6Jz0/Ym9tYlRhc2tDYXJkSXNEaXNhYmxlZCcsXG4gICAgICAgIGlzQ2xpY2thYmxlOic9P2JvbWJUYXNrQ2FyZElzQ2xpY2thYmxlJ1xuICAgICAgfSxcbiAgICAgIHJlc3RyaWN0OiAnQScsXG4gICAgICB0cmFuc2NsdWRlOiB0cnVlLFxuICAgICAgY29udHJvbGxlcjogQm9tYlRhc2tDYXJkLFxuICAgICAgYmluZFRvQ29udHJvbGxlcjogdHJ1ZSxcbiAgICAgIGNvbnRyb2xsZXJBczogJ2JvbWJUYXNrQ2FyZENvbnRyb2xsZXInLFxuICAgICAgdGVtcGxhdGVVcmw6ICd2aWV3cy9kaXJlY3RpdmVzL2JvbWItdGFzay1jYXJkLmh0bWwnXG4gICAgfTtcbiAgfSk7XG5cbn0pKEFOR1VMQVJfTU9EVUxFLCBhbmd1bGFyKTtcbiJdfQ==

/*!
 * eFit Website
 * An app for financial training in educational environments
 * http://www.e-fit.com
 * @author Armin Pfurtscheller
 * @version 1.0.0
 * Copyright 2017. MIT licensed.
 */
/* global ANGULAR_MODULE, angular */
(function(module, angular) {
  'use strict';

  //
  // SERVICE
  //

  /**
   * @constructor
   */
  var User = function($injector) {
    this.$injector = $injector;

    this._states = [
      $injector.get('STATE_BEGINNER'),
      $injector.get('STATE_AMATEUR'),
      $injector.get('STATE_ADVANCED'),
      $injector.get('STATE_EXPERT')
    ];

    this._eventSource = null;
    this._payload = {};
    this._pending = {};
    this._tasks = {};
  };

  User.$inject = ['$injector'];

  //
  // PROPERTIES
  //

  /** @var {number} state Current state of user. */
  User.prototype.state = null;

  /** @var {number} group Current state of user. */
  User.prototype.group = null;

  /** @var {number} tickets Current state of user. */
  User.prototype.tickets = null;

  //
  // METHODS
  //

  /**
   * Fetches current user through `User` resource.
   *
   * @public
   * @method load
   * @return {void}
   */
  User.prototype.load = function() {
    var User = this.$injector.get('User');

    var me = this;
    var successCallback = function(user) {

      // save only json payload from
      // ng-resource's `user` object
      me._payload = user.toJSON();

      // initialize members
      me._initTickets();
      me._initState();
      me._initGroup();

      // gameplay setup calls
      // only for `ROLE_USER`!
      if (!me.isUser()) {
        return;
      }

      me._initWatches();
      me._initPending();
      me._initTasks();
      me._initSSE();
    };

    var failureCallback = function() {
      // noop
    };

    var current = User.current();

    current.$promise.then(
      successCallback,
      failureCallback
    );

    return current;
  };

  /**
   * Resets current user session from application.
   *
   * @public
   * @method reset
   * @return {void}
   */
  User.prototype.unload = function() {
    var sse = this.$injector.get('sse');

    if (this._eventSource) {
      sse.removeSource(this._eventSource);
    }

    if (this._unwatchTickets) {
      this._unwatchTickets();
    }

    if (this._unwatchState) {
      this._unwatchState();
    }

    this._eventSource = null;
    this._payload = {};
    this._pending = {};
    this._tasks = {};

    this.tickets = null;
    this.state = null;
    this.group = null;
  };

  /**
   * Updates user from external scopes.
   * This is helpful for refreshing its
   * state without invoking a request to
   * the server when user was embedded in
   * another request's response.
   *
   * @public
   * @method update
   * @param {object} user
   * @return {void}
   *
   */
  User.prototype.update = function(user) {
    this._payload = user;

    this._initTickets();
    this._initState();
    this._initGroup();
  };

  /**
   * Checks if current user has role `ROLE_USER`.
   *
   * @public
   * @method isUser
   * @return {boolean}
   */
  User.prototype.isUser = function() {
    return this.hasRole('ROLE_USER');
  };

  /**
   * Checks if current user has role `ROLE_ADMIN`.
   *
   * @public
   * @method isAdmin
   * @return {boolean}
   */
  User.prototype.isAdmin = function() {
    return this.hasRole('ROLE_ADMIN');
  };

  /**
   * Checks if current user has role `ROLE_SUPER_ADMIN`.
   *
   * @public
   * @method isSuperAdmin
   * @return {boolean}
   */
  User.prototype.isSuperAdmin = function() {
    return this.hasRole('ROLE_SUPER_ADMIN');
  };

  /**
   * Checks if current user's workshop is active.
   *
   * @public
   * @method isInWorkshop
   * @return {boolean}
   */
  User.prototype.isInWorkshop = function() {
    if (!this.isUser()) {
      return true;
    }

    return this._payload.workshop.isActive;
  };

  /**
   * Checks if current user has given role.
   *
   * @public
   * @method hasRole
   * @param {string|array} role
   * @return {boolean}
   */
  User.prototype.hasRole = function(role) {
    if (!angular.isArray(role)) {
      role = [role];
    }

    var roles = this._payload.roles || [];
    for (var i=0; i<role.length; i++) {
      if (roles.indexOf(role[i])>=0) {
        return true;
      }
    }

    return false;
  };

  /**
   * Gets `task` resource of user by type.
   *
   * @public
   * @method getTaskByType
   * @param {string} type
   * @return {object|null}
   */
  User.prototype.getTaskByType = function(type) {
    return this._tasks[type] || null;
  };

  /**
   * Gets `result` resource of user by type.
   *
   * @public
   * @method getResultByType
   * @param {string} type
   * @return {object|null}
   */
  User.prototype.getPendingByType = function(type) {
    return this._pending[type] || null;
  };

  /**
   * Gets `state` mapped to string representation.
   *
   * @public
   * @method getGroupAsString
   * @return {string}
   */
  User.prototype.getGroupAsString = function() {
    switch(this.group) {
      case this.$injector.get('GROUP_A'):
        return 'GROUP_A';
      case this.$injector.get('GROUP_B'):
        return 'GROUP_B';
      default:
        return null;
    }
  };

  /**
   * Gets `state` mapped to string representation.
   *
   * @public
   * @method getStateAsString
   * @return {string}
   */
  User.prototype.getStateAsString = function() {
    switch(this.state) {
      case this.$injector.get('STATE_AMATEUR'):
        return 'STATE_AMATEUR';
      case this.$injector.get('STATE_ADVANCED'):
        return 'STATE_ADVANCED';
      case this.$injector.get('STATE_EXPERT'):
        return 'STATE_EXPERT';
      default:
        return 'STATE_BEGINNER';
    }
  };

  /**
   * Initializes `state` member.
   *
   * @private
   * @method _initState
   * @return {void}
   */
  User.prototype._initState = function() {
    var STATE_BEGINNER = this.$injector.get('STATE_BEGINNER');
    this.state = this._payload.state || STATE_BEGINNER;
  };

  /**
   * Initializes `group` member.
   *
   * @private
   * @method _initGroup
   * @return {void}
   */
  User.prototype._initGroup = function() {
    this.group = this._payload.group || null;
  };

  /**
   * Initializes `tickets` member.
   *
   * @private
   * @method init
   * @return {void}
   */
  User.prototype._initTickets = function() {
    var tickets = this._payload.tickets;
    this.tickets = tickets || 0;
  };

  /**
   * Watches `state` and `tickets` for changes to
   * show the corresponding user notifications.
   *
   * @private
   * @method _initWatches
   * @return {void}
   */
  User.prototype._initWatches = function() {
    var notification = this.$injector.get('notification');
    var $rootScope = this.$injector.get('$rootScope');
    var i18n = this.$injector.get('i18n');
    var me = this;

    var _watchStateExpression = function() {
      return me.state;
    };

    var _watchStateCallback = function(newState, oldState) {
      if (newState === oldState) {
        return;
      }

      notification.success(
        i18n.get(
          'Congratulations, you have reached the state %s!',
          i18n.get(me.getStateAsString())
        )
      );
    };

    var _watchTicketsExpression = function() {
      return me.tickets;
    };

    var _watchTicketsCallback = function(newTickets, oldTickets) {
      if (newTickets === oldTickets) {
        return;
      }
      var tickets = newTickets - oldTickets;
      if (tickets < 0) {
        return;
      }

      var message = tickets === 1 ?
        i18n.get('Congratulations, you have earned 1 new ticket!') :
        i18n.get('Congratulations, you have earned %s new tickets!', tickets);

      notification.primary(message);
    };

    this._unwatchTickets = $rootScope.$watch(
      _watchTicketsExpression,
      _watchTicketsCallback
    );

    this._unwatchState = $rootScope.$watch(
      _watchStateExpression,
      _watchStateCallback
    );
  };


  /**
   * Destroys user session and redirects to login.
   *
   * @private
   * @method _initSSE
   * @return {Void}
   */
  User.prototype._initSSE = function()
    {
      var $rootScope = this.$injector.get('$rootScope');
      var API_URL = this.$injector.get('API_URL');
      var sse = this.$injector.get('sse');

      // don't setup SSE when playing remote
      var workshop = this._payload.workshop;
      if (!workshop.isActive) {
        return;
      }

      var me = this;

      var _onMessage = function(data) {
        $rootScope.$evalAsync(function(){
          angular.forEach(data, function(item) {
            var unix = Date.parse(item.updatedAt);
            var task = me._tasks[item.type];
            task.isActive = !!item.isActive;

            if (!isNaN(unix)) {
              item.updatedAt = unix;
            }
          });
        });
      };

      var url = API_URL + '/sse/workshop/' + workshop.id + '/tasks';
      var options = { onMessage: _onMessage, sleep: 1 };
      this._eventSource = sse.addSource(url, options);
    };

  /**
   * Caches task hash map from workshop
   * for lookups from `getTaskByType()`.
   *
   * @private
   * @method _initTasks
   * @return {void}
   */
  User.prototype._initTasks = function() {
    var workshop = this._payload.workshop;
    if (!workshop) {
      return;
    }

    var me = this;
    angular.forEach(workshop.tasks,function(task) {
      me._tasks[task.type] = task;
    });
  };

  /**
   * Caches pending hash map from workshop
   * for lookups from `getPendingByType()`.
   *
   * @private
   * @method _initPending
   * @return {void}
   */
  User.prototype._initPending = function() {
    var pending = this._payload.pending;
    if (!pending) {
      return;
    }

    var me = this;
    angular.forEach(pending,function(result) {
      me._pending[result.task.type] = result;
    });
  };

  //
  // REGISTRY
  //
  angular.module(module).service('user', User);

})(ANGULAR_MODULE, angular);

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9zZXJ2aWNlcy91c2VyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwiZmlsZSI6ImFwcC9zZXJ2aWNlcy91c2VyLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGdsb2JhbCBBTkdVTEFSX01PRFVMRSwgYW5ndWxhciAqL1xuKGZ1bmN0aW9uKG1vZHVsZSwgYW5ndWxhcikge1xuICAndXNlIHN0cmljdCc7XG5cbiAgLy9cbiAgLy8gU0VSVklDRVxuICAvL1xuXG4gIC8qKlxuICAgKiBAY29uc3RydWN0b3JcbiAgICovXG4gIHZhciBVc2VyID0gZnVuY3Rpb24oJGluamVjdG9yKSB7XG4gICAgdGhpcy4kaW5qZWN0b3IgPSAkaW5qZWN0b3I7XG5cbiAgICB0aGlzLl9zdGF0ZXMgPSBbXG4gICAgICAkaW5qZWN0b3IuZ2V0KCdTVEFURV9CRUdJTk5FUicpLFxuICAgICAgJGluamVjdG9yLmdldCgnU1RBVEVfQU1BVEVVUicpLFxuICAgICAgJGluamVjdG9yLmdldCgnU1RBVEVfQURWQU5DRUQnKSxcbiAgICAgICRpbmplY3Rvci5nZXQoJ1NUQVRFX0VYUEVSVCcpXG4gICAgXTtcblxuICAgIHRoaXMuX2V2ZW50U291cmNlID0gbnVsbDtcbiAgICB0aGlzLl9wYXlsb2FkID0ge307XG4gICAgdGhpcy5fcGVuZGluZyA9IHt9O1xuICAgIHRoaXMuX3Rhc2tzID0ge307XG4gIH07XG5cbiAgVXNlci4kaW5qZWN0ID0gWyckaW5qZWN0b3InXTtcblxuICAvL1xuICAvLyBQUk9QRVJUSUVTXG4gIC8vXG5cbiAgLyoqIEB2YXIge251bWJlcn0gc3RhdGUgQ3VycmVudCBzdGF0ZSBvZiB1c2VyLiAqL1xuICBVc2VyLnByb3RvdHlwZS5zdGF0ZSA9IG51bGw7XG5cbiAgLyoqIEB2YXIge251bWJlcn0gZ3JvdXAgQ3VycmVudCBzdGF0ZSBvZiB1c2VyLiAqL1xuICBVc2VyLnByb3RvdHlwZS5ncm91cCA9IG51bGw7XG5cbiAgLyoqIEB2YXIge251bWJlcn0gdGlja2V0cyBDdXJyZW50IHN0YXRlIG9mIHVzZXIuICovXG4gIFVzZXIucHJvdG90eXBlLnRpY2tldHMgPSBudWxsO1xuXG4gIC8vXG4gIC8vIE1FVEhPRFNcbiAgLy9cblxuICAvKipcbiAgICogRmV0Y2hlcyBjdXJyZW50IHVzZXIgdGhyb3VnaCBgVXNlcmAgcmVzb3VyY2UuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBsb2FkXG4gICAqIEByZXR1cm4ge3ZvaWR9XG4gICAqL1xuICBVc2VyLnByb3RvdHlwZS5sb2FkID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIFVzZXIgPSB0aGlzLiRpbmplY3Rvci5nZXQoJ1VzZXInKTtcblxuICAgIHZhciBtZSA9IHRoaXM7XG4gICAgdmFyIHN1Y2Nlc3NDYWxsYmFjayA9IGZ1bmN0aW9uKHVzZXIpIHtcblxuICAgICAgLy8gc2F2ZSBvbmx5IGpzb24gcGF5bG9hZCBmcm9tXG4gICAgICAvLyBuZy1yZXNvdXJjZSdzIGB1c2VyYCBvYmplY3RcbiAgICAgIG1lLl9wYXlsb2FkID0gdXNlci50b0pTT04oKTtcblxuICAgICAgLy8gaW5pdGlhbGl6ZSBtZW1iZXJzXG4gICAgICBtZS5faW5pdFRpY2tldHMoKTtcbiAgICAgIG1lLl9pbml0U3RhdGUoKTtcbiAgICAgIG1lLl9pbml0R3JvdXAoKTtcblxuICAgICAgLy8gZ2FtZXBsYXkgc2V0dXAgY2FsbHNcbiAgICAgIC8vIG9ubHkgZm9yIGBST0xFX1VTRVJgIVxuICAgICAgaWYgKCFtZS5pc1VzZXIoKSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIG1lLl9pbml0V2F0Y2hlcygpO1xuICAgICAgbWUuX2luaXRQZW5kaW5nKCk7XG4gICAgICBtZS5faW5pdFRhc2tzKCk7XG4gICAgICBtZS5faW5pdFNTRSgpO1xuICAgIH07XG5cbiAgICB2YXIgZmFpbHVyZUNhbGxiYWNrID0gZnVuY3Rpb24oKSB7XG4gICAgICAvLyBub29wXG4gICAgfTtcblxuICAgIHZhciBjdXJyZW50ID0gVXNlci5jdXJyZW50KCk7XG5cbiAgICBjdXJyZW50LiRwcm9taXNlLnRoZW4oXG4gICAgICBzdWNjZXNzQ2FsbGJhY2ssXG4gICAgICBmYWlsdXJlQ2FsbGJhY2tcbiAgICApO1xuXG4gICAgcmV0dXJuIGN1cnJlbnQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIFJlc2V0cyBjdXJyZW50IHVzZXIgc2Vzc2lvbiBmcm9tIGFwcGxpY2F0aW9uLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgcmVzZXRcbiAgICogQHJldHVybiB7dm9pZH1cbiAgICovXG4gIFVzZXIucHJvdG90eXBlLnVubG9hZCA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciBzc2UgPSB0aGlzLiRpbmplY3Rvci5nZXQoJ3NzZScpO1xuXG4gICAgaWYgKHRoaXMuX2V2ZW50U291cmNlKSB7XG4gICAgICBzc2UucmVtb3ZlU291cmNlKHRoaXMuX2V2ZW50U291cmNlKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5fdW53YXRjaFRpY2tldHMpIHtcbiAgICAgIHRoaXMuX3Vud2F0Y2hUaWNrZXRzKCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX3Vud2F0Y2hTdGF0ZSkge1xuICAgICAgdGhpcy5fdW53YXRjaFN0YXRlKCk7XG4gICAgfVxuXG4gICAgdGhpcy5fZXZlbnRTb3VyY2UgPSBudWxsO1xuICAgIHRoaXMuX3BheWxvYWQgPSB7fTtcbiAgICB0aGlzLl9wZW5kaW5nID0ge307XG4gICAgdGhpcy5fdGFza3MgPSB7fTtcblxuICAgIHRoaXMudGlja2V0cyA9IG51bGw7XG4gICAgdGhpcy5zdGF0ZSA9IG51bGw7XG4gICAgdGhpcy5ncm91cCA9IG51bGw7XG4gIH07XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgdXNlciBmcm9tIGV4dGVybmFsIHNjb3Blcy5cbiAgICogVGhpcyBpcyBoZWxwZnVsIGZvciByZWZyZXNoaW5nIGl0c1xuICAgKiBzdGF0ZSB3aXRob3V0IGludm9raW5nIGEgcmVxdWVzdCB0b1xuICAgKiB0aGUgc2VydmVyIHdoZW4gdXNlciB3YXMgZW1iZWRkZWQgaW5cbiAgICogYW5vdGhlciByZXF1ZXN0J3MgcmVzcG9uc2UuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCB1cGRhdGVcbiAgICogQHBhcmFtIHtvYmplY3R9IHVzZXJcbiAgICogQHJldHVybiB7dm9pZH1cbiAgICpcbiAgICovXG4gIFVzZXIucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKHVzZXIpIHtcbiAgICB0aGlzLl9wYXlsb2FkID0gdXNlcjtcblxuICAgIHRoaXMuX2luaXRUaWNrZXRzKCk7XG4gICAgdGhpcy5faW5pdFN0YXRlKCk7XG4gICAgdGhpcy5faW5pdEdyb3VwKCk7XG4gIH07XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpZiBjdXJyZW50IHVzZXIgaGFzIHJvbGUgYFJPTEVfVVNFUmAuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBpc1VzZXJcbiAgICogQHJldHVybiB7Ym9vbGVhbn1cbiAgICovXG4gIFVzZXIucHJvdG90eXBlLmlzVXNlciA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB0aGlzLmhhc1JvbGUoJ1JPTEVfVVNFUicpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgY3VycmVudCB1c2VyIGhhcyByb2xlIGBST0xFX0FETUlOYC5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIGlzQWRtaW5cbiAgICogQHJldHVybiB7Ym9vbGVhbn1cbiAgICovXG4gIFVzZXIucHJvdG90eXBlLmlzQWRtaW4gPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5oYXNSb2xlKCdST0xFX0FETUlOJyk7XG4gIH07XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpZiBjdXJyZW50IHVzZXIgaGFzIHJvbGUgYFJPTEVfU1VQRVJfQURNSU5gLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgaXNTdXBlckFkbWluXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59XG4gICAqL1xuICBVc2VyLnByb3RvdHlwZS5pc1N1cGVyQWRtaW4gPSBmdW5jdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5oYXNSb2xlKCdST0xFX1NVUEVSX0FETUlOJyk7XG4gIH07XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpZiBjdXJyZW50IHVzZXIncyB3b3Jrc2hvcCBpcyBhY3RpdmUuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBpc0luV29ya3Nob3BcbiAgICogQHJldHVybiB7Ym9vbGVhbn1cbiAgICovXG4gIFVzZXIucHJvdG90eXBlLmlzSW5Xb3Jrc2hvcCA9IGZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5pc1VzZXIoKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuX3BheWxvYWQud29ya3Nob3AuaXNBY3RpdmU7XG4gIH07XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpZiBjdXJyZW50IHVzZXIgaGFzIGdpdmVuIHJvbGUuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBoYXNSb2xlXG4gICAqIEBwYXJhbSB7c3RyaW5nfGFycmF5fSByb2xlXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59XG4gICAqL1xuICBVc2VyLnByb3RvdHlwZS5oYXNSb2xlID0gZnVuY3Rpb24ocm9sZSkge1xuICAgIGlmICghYW5ndWxhci5pc0FycmF5KHJvbGUpKSB7XG4gICAgICByb2xlID0gW3JvbGVdO1xuICAgIH1cblxuICAgIHZhciByb2xlcyA9IHRoaXMuX3BheWxvYWQucm9sZXMgfHzCoFtdO1xuICAgIGZvciAodmFyIGk9MDsgaTxyb2xlLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAocm9sZXMuaW5kZXhPZihyb2xlW2ldKT49MCkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH07XG5cbiAgLyoqXG4gICAqIEdldHMgYHRhc2tgIHJlc291cmNlIG9mIHVzZXIgYnkgdHlwZS5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIGdldFRhc2tCeVR5cGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGVcbiAgICogQHJldHVybiB7b2JqZWN0fG51bGx9XG4gICAqL1xuICBVc2VyLnByb3RvdHlwZS5nZXRUYXNrQnlUeXBlID0gZnVuY3Rpb24odHlwZSkge1xuICAgIHJldHVybiB0aGlzLl90YXNrc1t0eXBlXSB8fMKgbnVsbDtcbiAgfTtcblxuICAvKipcbiAgICogR2V0cyBgcmVzdWx0YCByZXNvdXJjZSBvZiB1c2VyIGJ5IHR5cGUuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBnZXRSZXN1bHRCeVR5cGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IHR5cGVcbiAgICogQHJldHVybiB7b2JqZWN0fG51bGx9XG4gICAqL1xuICBVc2VyLnByb3RvdHlwZS5nZXRQZW5kaW5nQnlUeXBlID0gZnVuY3Rpb24odHlwZSkge1xuICAgIHJldHVybiB0aGlzLl9wZW5kaW5nW3R5cGVdIHx8wqBudWxsO1xuICB9O1xuXG4gIC8qKlxuICAgKiBHZXRzIGBzdGF0ZWAgbWFwcGVkIHRvIHN0cmluZyByZXByZXNlbnRhdGlvbi5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIGdldEdyb3VwQXNTdHJpbmdcbiAgICogQHJldHVybiB7c3RyaW5nfVxuICAgKi9cbiAgVXNlci5wcm90b3R5cGUuZ2V0R3JvdXBBc1N0cmluZyA9IGZ1bmN0aW9uKCkge1xuICAgIHN3aXRjaCh0aGlzLmdyb3VwKSB7XG4gICAgICBjYXNlIHRoaXMuJGluamVjdG9yLmdldCgnR1JPVVBfQScpOlxuICAgICAgICByZXR1cm4gJ0dST1VQX0EnO1xuICAgICAgY2FzZSB0aGlzLiRpbmplY3Rvci5nZXQoJ0dST1VQX0InKTpcbiAgICAgICAgcmV0dXJuICdHUk9VUF9CJztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogR2V0cyBgc3RhdGVgIG1hcHBlZCB0byBzdHJpbmcgcmVwcmVzZW50YXRpb24uXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBnZXRTdGF0ZUFzU3RyaW5nXG4gICAqIEByZXR1cm4ge3N0cmluZ31cbiAgICovXG4gIFVzZXIucHJvdG90eXBlLmdldFN0YXRlQXNTdHJpbmcgPSBmdW5jdGlvbigpIHtcbiAgICBzd2l0Y2godGhpcy5zdGF0ZSkge1xuICAgICAgY2FzZSB0aGlzLiRpbmplY3Rvci5nZXQoJ1NUQVRFX0FNQVRFVVInKTpcbiAgICAgICAgcmV0dXJuICdTVEFURV9BTUFURVVSJztcbiAgICAgIGNhc2UgdGhpcy4kaW5qZWN0b3IuZ2V0KCdTVEFURV9BRFZBTkNFRCcpOlxuICAgICAgICByZXR1cm4gJ1NUQVRFX0FEVkFOQ0VEJztcbiAgICAgIGNhc2UgdGhpcy4kaW5qZWN0b3IuZ2V0KCdTVEFURV9FWFBFUlQnKTpcbiAgICAgICAgcmV0dXJuICdTVEFURV9FWFBFUlQnO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuICdTVEFURV9CRUdJTk5FUic7XG4gICAgfVxuICB9O1xuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplcyBgc3RhdGVgIG1lbWJlci5cbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQG1ldGhvZCBfaW5pdFN0YXRlXG4gICAqIEByZXR1cm4ge3ZvaWR9XG4gICAqL1xuICBVc2VyLnByb3RvdHlwZS5faW5pdFN0YXRlID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIFNUQVRFX0JFR0lOTkVSID0gdGhpcy4kaW5qZWN0b3IuZ2V0KCdTVEFURV9CRUdJTk5FUicpO1xuICAgIHRoaXMuc3RhdGUgPSB0aGlzLl9wYXlsb2FkLnN0YXRlIHx8wqBTVEFURV9CRUdJTk5FUjtcbiAgfTtcblxuICAvKipcbiAgICogSW5pdGlhbGl6ZXMgYGdyb3VwYCBtZW1iZXIuXG4gICAqXG4gICAqIEBwcml2YXRlXG4gICAqIEBtZXRob2QgX2luaXRHcm91cFxuICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgKi9cbiAgVXNlci5wcm90b3R5cGUuX2luaXRHcm91cCA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuZ3JvdXAgPSB0aGlzLl9wYXlsb2FkLmdyb3VwIHx8wqBudWxsO1xuICB9O1xuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplcyBgdGlja2V0c2AgbWVtYmVyLlxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAbWV0aG9kIGluaXRcbiAgICogQHJldHVybiB7dm9pZH1cbiAgICovXG4gIFVzZXIucHJvdG90eXBlLl9pbml0VGlja2V0cyA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciB0aWNrZXRzID0gdGhpcy5fcGF5bG9hZC50aWNrZXRzO1xuICAgIHRoaXMudGlja2V0cyA9IHRpY2tldHMgfHzCoDA7XG4gIH07XG5cbiAgLyoqXG4gICAqIFdhdGNoZXMgYHN0YXRlYCBhbmQgYHRpY2tldHNgIGZvciBjaGFuZ2VzIHRvXG4gICAqIHNob3cgdGhlIGNvcnJlc3BvbmRpbmcgdXNlciBub3RpZmljYXRpb25zLlxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAbWV0aG9kIF9pbml0V2F0Y2hlc1xuICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgKi9cbiAgVXNlci5wcm90b3R5cGUuX2luaXRXYXRjaGVzID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIG5vdGlmaWNhdGlvbiA9IHRoaXMuJGluamVjdG9yLmdldCgnbm90aWZpY2F0aW9uJyk7XG4gICAgdmFyICRyb290U2NvcGUgPSB0aGlzLiRpbmplY3Rvci5nZXQoJyRyb290U2NvcGUnKTtcbiAgICB2YXIgaTE4biA9IHRoaXMuJGluamVjdG9yLmdldCgnaTE4bicpO1xuICAgIHZhciBtZSA9IHRoaXM7XG5cbiAgICB2YXIgX3dhdGNoU3RhdGVFeHByZXNzaW9uID0gZnVuY3Rpb24oKSB7XG4gICAgICByZXR1cm4gbWUuc3RhdGU7XG4gICAgfTtcblxuICAgIHZhciBfd2F0Y2hTdGF0ZUNhbGxiYWNrID0gZnVuY3Rpb24obmV3U3RhdGUsIG9sZFN0YXRlKSB7XG4gICAgICBpZiAobmV3U3RhdGUgPT09IG9sZFN0YXRlKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgbm90aWZpY2F0aW9uLnN1Y2Nlc3MoXG4gICAgICAgIGkxOG4uZ2V0KFxuICAgICAgICAgICdDb25ncmF0dWxhdGlvbnMsIHlvdSBoYXZlIHJlYWNoZWQgdGhlIHN0YXRlICVzIScsXG4gICAgICAgICAgaTE4bi5nZXQobWUuZ2V0U3RhdGVBc1N0cmluZygpKVxuICAgICAgICApXG4gICAgICApO1xuICAgIH07XG5cbiAgICB2YXIgX3dhdGNoVGlja2V0c0V4cHJlc3Npb24gPSBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiBtZS50aWNrZXRzO1xuICAgIH07XG5cbiAgICB2YXIgX3dhdGNoVGlja2V0c0NhbGxiYWNrID0gZnVuY3Rpb24obmV3VGlja2V0cywgb2xkVGlja2V0cykge1xuICAgICAgaWYgKG5ld1RpY2tldHMgPT09IG9sZFRpY2tldHMpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdmFyIHRpY2tldHMgPSBuZXdUaWNrZXRzIC0gb2xkVGlja2V0cztcbiAgICAgIGlmICh0aWNrZXRzIDwgMCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHZhciBtZXNzYWdlID0gdGlja2V0cyA9PT0gMSA/XG4gICAgICAgIGkxOG4uZ2V0KCdDb25ncmF0dWxhdGlvbnMsIHlvdSBoYXZlIGVhcm5lZCAxIG5ldyB0aWNrZXQhJykgOlxuICAgICAgICBpMThuLmdldCgnQ29uZ3JhdHVsYXRpb25zLCB5b3UgaGF2ZSBlYXJuZWQgJXMgbmV3IHRpY2tldHMhJywgdGlja2V0cyk7XG5cbiAgICAgIG5vdGlmaWNhdGlvbi5wcmltYXJ5KG1lc3NhZ2UpO1xuICAgIH07XG5cbiAgICB0aGlzLl91bndhdGNoVGlja2V0cyA9ICRyb290U2NvcGUuJHdhdGNoKFxuICAgICAgX3dhdGNoVGlja2V0c0V4cHJlc3Npb24sXG4gICAgICBfd2F0Y2hUaWNrZXRzQ2FsbGJhY2tcbiAgICApO1xuXG4gICAgdGhpcy5fdW53YXRjaFN0YXRlID0gJHJvb3RTY29wZS4kd2F0Y2goXG4gICAgICBfd2F0Y2hTdGF0ZUV4cHJlc3Npb24sXG4gICAgICBfd2F0Y2hTdGF0ZUNhbGxiYWNrXG4gICAgKTtcbiAgfTtcblxuXG4gIC8qKlxuICAgKiBEZXN0cm95cyB1c2VyIHNlc3Npb24gYW5kIHJlZGlyZWN0cyB0byBsb2dpbi5cbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQG1ldGhvZCBfaW5pdFNTRVxuICAgKiBAcmV0dXJuIHtWb2lkfVxuICAgKi9cbiAgVXNlci5wcm90b3R5cGUuX2luaXRTU0UgPSBmdW5jdGlvbigpXG4gICAge1xuICAgICAgdmFyICRyb290U2NvcGUgPSB0aGlzLiRpbmplY3Rvci5nZXQoJyRyb290U2NvcGUnKTtcbiAgICAgIHZhciBBUElfVVJMID0gdGhpcy4kaW5qZWN0b3IuZ2V0KCdBUElfVVJMJyk7XG4gICAgICB2YXIgc3NlID0gdGhpcy4kaW5qZWN0b3IuZ2V0KCdzc2UnKTtcblxuICAgICAgLy8gZG9uJ3Qgc2V0dXAgU1NFIHdoZW4gcGxheWluZyByZW1vdGVcbiAgICAgIHZhciB3b3Jrc2hvcCA9IHRoaXMuX3BheWxvYWQud29ya3Nob3A7XG4gICAgICBpZiAoIXdvcmtzaG9wLmlzQWN0aXZlKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdmFyIG1lID0gdGhpcztcblxuICAgICAgdmFyIF9vbk1lc3NhZ2UgPSBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICRyb290U2NvcGUuJGV2YWxBc3luYyhmdW5jdGlvbigpe1xuICAgICAgICAgIGFuZ3VsYXIuZm9yRWFjaChkYXRhLCBmdW5jdGlvbihpdGVtKSB7XG4gICAgICAgICAgICB2YXIgdW5peCA9IERhdGUucGFyc2UoaXRlbS51cGRhdGVkQXQpO1xuICAgICAgICAgICAgdmFyIHRhc2sgPSBtZS5fdGFza3NbaXRlbS50eXBlXTtcbiAgICAgICAgICAgIHRhc2suaXNBY3RpdmUgPSAhIWl0ZW0uaXNBY3RpdmU7XG5cbiAgICAgICAgICAgIGlmICghaXNOYU4odW5peCkpIHtcbiAgICAgICAgICAgICAgaXRlbS51cGRhdGVkQXQgPSB1bml4O1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICAgIH07XG5cbiAgICAgIHZhciB1cmwgPSBBUElfVVJMICsgJy9zc2Uvd29ya3Nob3AvJyArIHdvcmtzaG9wLmlkICsgJy90YXNrcyc7XG4gICAgICB2YXIgb3B0aW9ucyA9IHsgb25NZXNzYWdlOiBfb25NZXNzYWdlLCBzbGVlcDogMSB9O1xuICAgICAgdGhpcy5fZXZlbnRTb3VyY2UgPSBzc2UuYWRkU291cmNlKHVybCwgb3B0aW9ucyk7XG4gICAgfTtcblxuICAvKipcbiAgICogQ2FjaGVzIHRhc2sgaGFzaCBtYXAgZnJvbSB3b3Jrc2hvcFxuICAgKiBmb3IgbG9va3VwcyBmcm9tIGBnZXRUYXNrQnlUeXBlKClgLlxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKiBAbWV0aG9kIF9pbml0VGFza3NcbiAgICogQHJldHVybiB7dm9pZH1cbiAgICovXG4gIFVzZXIucHJvdG90eXBlLl9pbml0VGFza3MgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgd29ya3Nob3AgPSB0aGlzLl9wYXlsb2FkLndvcmtzaG9wO1xuICAgIGlmICghd29ya3Nob3ApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB2YXIgbWUgPSB0aGlzO1xuICAgIGFuZ3VsYXIuZm9yRWFjaCh3b3Jrc2hvcC50YXNrcyxmdW5jdGlvbih0YXNrKSB7XG4gICAgICBtZS5fdGFza3NbdGFzay50eXBlXSA9IHRhc2s7XG4gICAgfSk7XG4gIH07XG5cbiAgLyoqXG4gICAqIENhY2hlcyBwZW5kaW5nIGhhc2ggbWFwIGZyb20gd29ya3Nob3BcbiAgICogZm9yIGxvb2t1cHMgZnJvbSBgZ2V0UGVuZGluZ0J5VHlwZSgpYC5cbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQG1ldGhvZCBfaW5pdFBlbmRpbmdcbiAgICogQHJldHVybiB7dm9pZH1cbiAgICovXG4gIFVzZXIucHJvdG90eXBlLl9pbml0UGVuZGluZyA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciBwZW5kaW5nID0gdGhpcy5fcGF5bG9hZC5wZW5kaW5nO1xuICAgIGlmICghcGVuZGluZykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHZhciBtZSA9IHRoaXM7XG4gICAgYW5ndWxhci5mb3JFYWNoKHBlbmRpbmcsZnVuY3Rpb24ocmVzdWx0KSB7XG4gICAgICBtZS5fcGVuZGluZ1tyZXN1bHQudGFzay50eXBlXSA9IHJlc3VsdDtcbiAgICB9KTtcbiAgfTtcblxuICAvL1xuICAvLyBSRUdJU1RSWVxuICAvL1xuICBhbmd1bGFyLm1vZHVsZShtb2R1bGUpLnNlcnZpY2UoJ3VzZXInLCBVc2VyKTtcblxufSkoQU5HVUxBUl9NT0RVTEUsIGFuZ3VsYXIpO1xuIl19

/*!
 * eFit Website
 * An app for financial training in educational environments
 * http://www.e-fit.com
 * @author Armin Pfurtscheller
 * @version 1.0.0
 * Copyright 2017. MIT licensed.
 */
/* global ANGULAR_MODULE, angular */
(function(module, angular) {
  'use strict';

  // --------------------------------------------------
  // BombTask
  // --------------------------------------------------

  //
  // CONTROLLER
  //

  /**
   * @constructor
   */
  var BombTask = function($scope, $attrs, $element, $injector) {
    var type = $injector.get('TYPE_RISK');
    var user = $injector.get('user');

    this.$scope = $scope;
    this.$attrs = $attrs;
    this.$element = $element;
    this.$injector = $injector;

    this.task = user.getTaskByType(type);
  };

  BombTask.$inject = ['$scope', '$attrs', '$element', '$injector'];

  //
  // PROPERTIES
  //

  // SERVER

  /** @var {object} task Task's resource from server. */
  BombTask.prototype.task = null;

  // GAMEPLAY

  /** @var {boolean} started If the task has started. */
  BombTask.prototype.started = false;

  /** @var {boolean} stopped If the task has stopped. */
  BombTask.prototype.stopped = false;

  /** @var {boolean} hasBomb If bomb is in current collection. */
  BombTask.prototype.hasBomb = false;

  /** @var {boolean} resolved If player has resolved the game. */
  BombTask.prototype.resolved = false;

  /** @var {number} totalBoxes Total boxes of current game. */
  BombTask.prototype.totalBoxes = 0;

  /** @var {number} remainingBoxes Remaining boxes of current game. */
  BombTask.prototype.remainingBoxes = 0;

  /** @var {number} collectedBoxes Collected boxes of current game. */
  BombTask.prototype.collectedBoxes = 0;

  // SETTINGS

  /** @var {number} avg Average of collected boxes from statistics. */
  BombTask.prototype.avg = 12;

  /** @var {number} rows Amount of rows for bomb task. */
  BombTask.prototype.rows = 5;

  /** @var {number} cols Amount of cols for bomb task. */
  BombTask.prototype.cols = 5;

  /** @var {number} interval Timeout for interval in seconds. */
  BombTask.prototype.interval = 1;

  /** @var {boolean} random
   * - If `random` = false, boxes are collected row-wise one-by-one, starting in the top-left corner
   * - If `random` = true, boxes are collected randomly (Fisher-Yates Algorithm)
   * Note that this affects game play independently of `dynamic` property
   */
  BombTask.prototype.random = false;

  /** @var {boolean} dynamic
   * - If `dynamic` = true, one box per time interval is collected automatically
   * - In case of `dynamic` = true, game play is affected by the variables `interval` and `random`
   * - If `dynamic` = false, subjects collect as many boxes as they want by clicking or entering the respective number
   * - In case of `dynamic` = false, game play is affected by the variables `random`
   */
  BombTask.prototype.dynamic = false;

  //
  // METHODS
  //

  /**
   * Proxies to `init()` if controller's ready.
   *
   * @public
   * @method $onInit
   * @return {Void}
   */
  BombTask.prototype.$onInit = function() {
    this.init();
  };

  /**
   * Retrieves result payload for server.
   *
   * @public
   * @method getPayload
   * @return {Void}
   */
  BombTask.prototype.getPayload = function() {
    /* jshint camelcase: false */
    return {
      task: this.task,
      json: {
        has_bomb: this.hasBomb,
        collected_boxes: this.collectedBoxes
      }
    };
    /* jshint camelcase: true */
  };

  /**
   * Whether or not task is currently locked.
   *
   * @public
   * @method isLocked
   * @return {boolean}
   */
  BombTask.prototype.isLocked = function() {
    if (this.task === null) {
      return true;
    }

    return !this.task.isActive;
  };

  /**
   * Whether or not task can be sent to server.
   *
   * @public
   * @method canResolve
   * @return {boolean}
   */
  BombTask.prototype.canResolve = function() {
    var user = this.$injector.get('user');
    if (!user.isUser()) {
      return false;
    }

    if (this.isLocked()) {
      return false;
    }

    if (this.resolved) {
      return false;
    }

    if (this.dynamic) {
      return this.stopped;
    }

    if (!this.collectedBoxes) {
      return false;
    }

    return true;
  };

  /**
   * Sets up initial state.
   *
   * @public
   * @method init
   * @return {Void}
   */
  BombTask.prototype.init = function() {
    this._initMembers();
    this._initMatrix();
    this._initBomb();

    if (!this.dynamic) {
      this.start();
    }
  };

  /**
   * Resets initial state.
   *
   * @public
   * @method reset
   * @return {Void}
   */
  BombTask.prototype.reset = function() {
    this.init();
  };

  /**
   * Sets `started` flag. If `dynamic` is true,
   * the interval will start to reveal cards.
   *
   * @public
   * @method start
   * @return {Void}
   */
  BombTask.prototype.start = function(index) {
    if (this.dynamic) {
      var $interval = this.$injector.get('$interval');

      this._intIndex = index || 0;

      var me = this;
      var max = this.iterator.length;
      this._intervalId = $interval(
        function(){

          var item = me.iterator[me._intIndex];
          me.update(item,true);

          me._intIndex++;
          if (me._intIndex===max) {
            me.stop();
          }

        },
        this.interval*1000, // = from seconds
        max - this._intIndex // = max iterations
      );
    }

    this.started = true;
  };

  /**
   * Sets `stopped` flag. If `dynamic` is true,
   * the interval will be stopped in addition.
   *
   * @public
   * @method start
   * @return {Void}
   */
  BombTask.prototype.stop = function() {
    if (this.dynamic && this._intervalId) {
      var $interval = this.$injector.get('$interval');
      $interval.cancel(this._intervalId);
    }

    this.stopped = true;
  };

  /**
   * Sets `resolved` flag. Calls `onResolve`
   * callback with JSON result for consumer.
   *
   * @public
   * @method resolve
   * @return {Void}
   */
  BombTask.prototype.resolve = function() {
    var $q = this.$injector.get('$q');
    var result = this.onResolve({
      payload: this.getPayload()
    });

    var resolveCard = function(card) {
      card.$$resolved = true;
    };

    var me = this;
    var successCallback = function() {
      angular.forEach(me.collection, resolveCard);
      me.resolved = true;
    };
    var failureCallback = function() {

    };

    var promise = $q.when(result);
    promise.then(
      successCallback,
      failureCallback
    );

    return promise;
  };

  /**
   * Callback for card click. Updates all
   * related properties for final result.
   *
   * @public
   * @method update
   * @param {object} column
   * @param {boolean} active
   * @return {Void}
   */
  BombTask.prototype.update = function(column, active) {
    var index = this.collection.indexOf(column);

    if (active) {
      if (index<0)Â {
        this.collection.push(column);
        this.collectedBoxes++;
      }

      column.$$active = true;
    } else {
      if (index>=0) {
        this.collection.splice(index,1);
        column.$$active = false;
        this.collectedBoxes--;
      }
    }

    if (this.isBomb(column)) {
      this.hasBomb = true;
    }

    var total = this.totalBoxes;
    var collected = this.collectedBoxes;
    this.remainingBoxes = total - collected;
  };

  /**
   * Provides indiviual tracking id for column.
   *
   * @public
   * @method trackId
   * @param {object} column
   * @return {Void}
   */
  BombTask.prototype.trackId = function(column) {
    return column.row + '_' + column.col;
  };

  /**
   * Determines if column is actual bomb.
   *
   * @public
   * @method isBomb
   * @param {object} column
   * @return {Void}
   */
  BombTask.prototype.isBomb = function(column) {
    return angular.equals(this.bomb,column);
  };

  /**
   * Initialzes internal properties.
   *
   * @private
   * @method _initMembers
   * @return {Void}
   */
  BombTask.prototype._initMembers = function() {
    this.collection = [];

    this.hasBomb = false;
    this.started = false;
    this.stopped = false;
    this.resolved = false;

    this.collectedBoxes = 0;
    this.remainingBoxes = 0;
    this.totalBoxes = this.rows * this.cols;
  };

  /**
   * Calculates the actual matrix.
   *
   * @private
   * @method _initMatrix
   * @return {Void}
   */
  BombTask.prototype._initMatrix = function() {
    this.matrix = [];
    this.iterator = [];

    for (var i=0; i<this.rows; i++) {

      var columns = [];
      for( var j=0; j<this.cols; j++ ) {
        var data = {
          row: i+1,
          col: j+1
        };

        columns.push(data);

        if (this.dynamic) {
          if (!this.random) {
            this.iterator.push(data);
          } else {
            var random = this.$injector.get('random');
            random.push(this.iterator,data);
          }
        }
      }

      this.matrix.push(columns);
    }
  };

  /**
   * Initializes bomb's actual location.
   *
   * @private
   * @method _initBomb
   * @return {Void}
   */
  BombTask.prototype._initBomb = function() {
    var random = this.$injector.get('random');

    var row = random.between(0,this.rows-1);
    var col = random.between(0,this.cols-1);

    this.bomb = this.matrix[row][col];
  };

  //
  // REGISTRY
  //
  angular.module(module).directive('bombTask',function(){
    return {
      scope: {
        avg: '=?bombTaskAvg',
        rows: '=?bombTaskRows',
        cols: '=?bombTaskCols',
        random: '=?bombTaskRandom',
        dynamic: '=?bombTaskDynamic',
        interval: '=?bombTaskInterval',
        onResolve: '&bombTaskOnResolve'
      },
      restrict: 'A',
      transclude: true,
      controller: BombTask,
      bindToController: true,
      controllerAs: 'bombTaskController',
      templateUrl: 'views/directives/tasks/bomb-task.html'
    };
  });

  // --------------------------------------------------
  // BombTask Card
  // --------------------------------------------------

  //
  // CONTROLLER
  //

  /**
   * @constructor
   */
  var BombTaskCard = function(){
  };

  //
  // PROPERTIES
  //

  /** @var {string} id Card's accociated model. */
  BombTaskCard.prototype.model = null;

  /** @var {string} isActive If card is active. */
  BombTaskCard.prototype.isActive = false;

  /** @var {string} isDisabled If card is disabled. */
  BombTaskCard.prototype.isDisabled = false;

  /** @var {string} isClickable If card is clickable. */
  BombTaskCard.prototype.isClickable = true;

  //
  // METHODS
  //

  /**
   * Toggles `isActive` if `isDisabled` and
   * `isClickable` allow the action. Invokes
   * `onToggle` callback for consumer.
   *
   * @public
   * @method toggle
   * @return {Void}
   */
  BombTaskCard.prototype.toggle = function() {
    if (this.isDisabled || !this.isClickable) {
      return;
    }

    this.isActive = !this.isActive;

    this.onToggle({
      model:this.model,
      state:this.isActive
    });
  };

  // registry
  angular.module(module).directive('bombTaskCard', function(){
    return {
      scope: {
        model:'=bombTaskCard',
        onToggle:'&bombTaskCardOnToggle',
        isActive:'=?bombTaskCardIsActive',
        isDisabled:'=?bombTaskCardIsDisabled',
        isClickable:'=?bombTaskCardIsClickable'
      },
      restrict: 'A',
      transclude: true,
      controller: BombTaskCard,
      bindToController: true,
      controllerAs: 'bombTaskCardController',
      templateUrl: 'views/directives/tasks/bomb-task-card.html'
    };
  });

})(ANGULAR_MODULE, angular);

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9kaXJlY3RpdmVzL3Rhc2tzL2JvbWItdGFzay5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiYXBwL2RpcmVjdGl2ZXMvdGFza3MvYm9tYi10YXNrLm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qIGdsb2JhbCBBTkdVTEFSX01PRFVMRSwgYW5ndWxhciAqL1xuKGZ1bmN0aW9uKG1vZHVsZSwgYW5ndWxhcikge1xuICAndXNlIHN0cmljdCc7XG5cbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLy8gQm9tYlRhc2tcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuICAvL1xuICAvLyBDT05UUk9MTEVSXG4gIC8vXG5cbiAgLyoqXG4gICAqIEBjb25zdHJ1Y3RvclxuICAgKi9cbiAgdmFyIEJvbWJUYXNrID0gZnVuY3Rpb24oJHNjb3BlLCAkYXR0cnMsICRlbGVtZW50LCAkaW5qZWN0b3IpIHtcbiAgICB2YXIgdHlwZSA9ICRpbmplY3Rvci5nZXQoJ1RZUEVfUklTSycpO1xuICAgIHZhciB1c2VyID0gJGluamVjdG9yLmdldCgndXNlcicpO1xuXG4gICAgdGhpcy4kc2NvcGUgPSAkc2NvcGU7XG4gICAgdGhpcy4kYXR0cnMgPSAkYXR0cnM7XG4gICAgdGhpcy4kZWxlbWVudCA9ICRlbGVtZW50O1xuICAgIHRoaXMuJGluamVjdG9yID0gJGluamVjdG9yO1xuXG4gICAgdGhpcy50YXNrID0gdXNlci5nZXRUYXNrQnlUeXBlKHR5cGUpO1xuICB9O1xuXG4gIEJvbWJUYXNrLiRpbmplY3QgPSBbJyRzY29wZScsICckYXR0cnMnLCAnJGVsZW1lbnQnLCAnJGluamVjdG9yJ107XG5cbiAgLy9cbiAgLy8gUFJPUEVSVElFU1xuICAvL1xuXG4gIC8vIFNFUlZFUlxuXG4gIC8qKiBAdmFyIHtvYmplY3R9IHRhc2sgVGFzaydzIHJlc291cmNlIGZyb20gc2VydmVyLiAqL1xuICBCb21iVGFzay5wcm90b3R5cGUudGFzayA9IG51bGw7XG5cbiAgLy8gR0FNRVBMQVlcblxuICAvKiogQHZhciB7Ym9vbGVhbn0gc3RhcnRlZCBJZiB0aGUgdGFzayBoYXMgc3RhcnRlZC4gKi9cbiAgQm9tYlRhc2sucHJvdG90eXBlLnN0YXJ0ZWQgPSBmYWxzZTtcblxuICAvKiogQHZhciB7Ym9vbGVhbn0gc3RvcHBlZCBJZiB0aGUgdGFzayBoYXMgc3RvcHBlZC4gKi9cbiAgQm9tYlRhc2sucHJvdG90eXBlLnN0b3BwZWQgPSBmYWxzZTtcblxuICAvKiogQHZhciB7Ym9vbGVhbn0gaGFzQm9tYiBJZiBib21iIGlzIGluIGN1cnJlbnQgY29sbGVjdGlvbi4gKi9cbiAgQm9tYlRhc2sucHJvdG90eXBlLmhhc0JvbWIgPSBmYWxzZTtcblxuICAvKiogQHZhciB7Ym9vbGVhbn0gcmVzb2x2ZWQgSWYgcGxheWVyIGhhcyByZXNvbHZlZCB0aGUgZ2FtZS4gKi9cbiAgQm9tYlRhc2sucHJvdG90eXBlLnJlc29sdmVkID0gZmFsc2U7XG5cbiAgLyoqIEB2YXIge251bWJlcn0gdG90YWxCb3hlcyBUb3RhbCBib3hlcyBvZiBjdXJyZW50IGdhbWUuICovXG4gIEJvbWJUYXNrLnByb3RvdHlwZS50b3RhbEJveGVzID0gMDtcblxuICAvKiogQHZhciB7bnVtYmVyfSByZW1haW5pbmdCb3hlcyBSZW1haW5pbmcgYm94ZXMgb2YgY3VycmVudCBnYW1lLiAqL1xuICBCb21iVGFzay5wcm90b3R5cGUucmVtYWluaW5nQm94ZXMgPSAwO1xuXG4gIC8qKiBAdmFyIHtudW1iZXJ9IGNvbGxlY3RlZEJveGVzIENvbGxlY3RlZCBib3hlcyBvZiBjdXJyZW50IGdhbWUuICovXG4gIEJvbWJUYXNrLnByb3RvdHlwZS5jb2xsZWN0ZWRCb3hlcyA9IDA7XG5cbiAgLy8gU0VUVElOR1NcblxuICAvKiogQHZhciB7bnVtYmVyfSBhdmcgQXZlcmFnZSBvZiBjb2xsZWN0ZWQgYm94ZXMgZnJvbSBzdGF0aXN0aWNzLiAqL1xuICBCb21iVGFzay5wcm90b3R5cGUuYXZnID0gMTI7XG5cbiAgLyoqIEB2YXIge251bWJlcn0gcm93cyBBbW91bnQgb2Ygcm93cyBmb3IgYm9tYiB0YXNrLiAqL1xuICBCb21iVGFzay5wcm90b3R5cGUucm93cyA9IDU7XG5cbiAgLyoqIEB2YXIge251bWJlcn0gY29scyBBbW91bnQgb2YgY29scyBmb3IgYm9tYiB0YXNrLiAqL1xuICBCb21iVGFzay5wcm90b3R5cGUuY29scyA9IDU7XG5cbiAgLyoqIEB2YXIge251bWJlcn0gaW50ZXJ2YWwgVGltZW91dCBmb3IgaW50ZXJ2YWwgaW4gc2Vjb25kcy4gKi9cbiAgQm9tYlRhc2sucHJvdG90eXBlLmludGVydmFsID0gMTtcblxuICAvKiogQHZhciB7Ym9vbGVhbn0gcmFuZG9tXG4gICAqIC0gSWYgYHJhbmRvbWAgPSBmYWxzZSwgYm94ZXMgYXJlIGNvbGxlY3RlZCByb3ctd2lzZSBvbmUtYnktb25lLCBzdGFydGluZyBpbiB0aGUgdG9wLWxlZnQgY29ybmVyXG4gICAqIC0gSWYgYHJhbmRvbWAgPSB0cnVlLCBib3hlcyBhcmUgY29sbGVjdGVkIHJhbmRvbWx5IChGaXNoZXItWWF0ZXMgQWxnb3JpdGhtKVxuICAgKiBOb3RlIHRoYXQgdGhpcyBhZmZlY3RzIGdhbWUgcGxheSBpbmRlcGVuZGVudGx5IG9mIGBkeW5hbWljYCBwcm9wZXJ0eVxuICAgKi9cbiAgQm9tYlRhc2sucHJvdG90eXBlLnJhbmRvbSA9IGZhbHNlO1xuXG4gIC8qKiBAdmFyIHtib29sZWFufSBkeW5hbWljXG4gICAqIC0gSWYgYGR5bmFtaWNgID0gdHJ1ZSwgb25lIGJveCBwZXIgdGltZSBpbnRlcnZhbCBpcyBjb2xsZWN0ZWQgYXV0b21hdGljYWxseVxuICAgKiAtIEluIGNhc2Ugb2YgYGR5bmFtaWNgID0gdHJ1ZSwgZ2FtZSBwbGF5IGlzIGFmZmVjdGVkIGJ5IHRoZSB2YXJpYWJsZXMgYGludGVydmFsYCBhbmQgYHJhbmRvbWBcbiAgICogLSBJZiBgZHluYW1pY2AgPSBmYWxzZSwgc3ViamVjdHMgY29sbGVjdCBhcyBtYW55IGJveGVzIGFzIHRoZXkgd2FudCBieSBjbGlja2luZyBvciBlbnRlcmluZyB0aGUgcmVzcGVjdGl2ZSBudW1iZXJcbiAgICogLSBJbiBjYXNlIG9mIGBkeW5hbWljYCA9IGZhbHNlLCBnYW1lIHBsYXkgaXMgYWZmZWN0ZWQgYnkgdGhlIHZhcmlhYmxlcyBgcmFuZG9tYFxuICAgKi9cbiAgQm9tYlRhc2sucHJvdG90eXBlLmR5bmFtaWMgPSBmYWxzZTtcblxuICAvL1xuICAvLyBNRVRIT0RTXG4gIC8vXG5cbiAgLyoqXG4gICAqIFByb3hpZXMgdG8gYGluaXQoKWAgaWYgY29udHJvbGxlcidzIHJlYWR5LlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgJG9uSW5pdFxuICAgKiBAcmV0dXJuIHtWb2lkfVxuICAgKi9cbiAgQm9tYlRhc2sucHJvdG90eXBlLiRvbkluaXQgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLmluaXQoKTtcbiAgfTtcblxuICAvKipcbiAgICogUmV0cmlldmVzIHJlc3VsdCBwYXlsb2FkIGZvciBzZXJ2ZXIuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBnZXRQYXlsb2FkXG4gICAqIEByZXR1cm4ge1ZvaWR9XG4gICAqL1xuICBCb21iVGFzay5wcm90b3R5cGUuZ2V0UGF5bG9hZCA9IGZ1bmN0aW9uKCkge1xuICAgIC8qIGpzaGludCBjYW1lbGNhc2U6IGZhbHNlICovXG4gICAgcmV0dXJuIHtcbiAgICAgIHRhc2s6IHRoaXMudGFzayxcbiAgICAgIGpzb246IHtcbiAgICAgICAgaGFzX2JvbWI6IHRoaXMuaGFzQm9tYixcbiAgICAgICAgY29sbGVjdGVkX2JveGVzOiB0aGlzLmNvbGxlY3RlZEJveGVzXG4gICAgICB9XG4gICAgfTtcbiAgICAvKiBqc2hpbnQgY2FtZWxjYXNlOiB0cnVlICovXG4gIH07XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgb3Igbm90IHRhc2sgaXMgY3VycmVudGx5IGxvY2tlZC5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIGlzTG9ja2VkXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59XG4gICAqL1xuICBCb21iVGFzay5wcm90b3R5cGUuaXNMb2NrZWQgPSBmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy50YXNrID09PSBudWxsKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXR1cm4gIXRoaXMudGFzay5pc0FjdGl2ZTtcbiAgfTtcblxuICAvKipcbiAgICogV2hldGhlciBvciBub3QgdGFzayBjYW4gYmUgc2VudCB0byBzZXJ2ZXIuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBjYW5SZXNvbHZlXG4gICAqIEByZXR1cm4ge2Jvb2xlYW59XG4gICAqL1xuICBCb21iVGFzay5wcm90b3R5cGUuY2FuUmVzb2x2ZSA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciB1c2VyID0gdGhpcy4kaW5qZWN0b3IuZ2V0KCd1c2VyJyk7XG4gICAgaWYgKCF1c2VyLmlzVXNlcigpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNMb2NrZWQoKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnJlc29sdmVkKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuZHluYW1pYykge1xuICAgICAgcmV0dXJuIHRoaXMuc3RvcHBlZDtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuY29sbGVjdGVkQm94ZXMpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfTtcblxuICAvKipcbiAgICogU2V0cyB1cCBpbml0aWFsIHN0YXRlLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgaW5pdFxuICAgKiBAcmV0dXJuIHtWb2lkfVxuICAgKi9cbiAgQm9tYlRhc2sucHJvdG90eXBlLmluaXQgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLl9pbml0TWVtYmVycygpO1xuICAgIHRoaXMuX2luaXRNYXRyaXgoKTtcbiAgICB0aGlzLl9pbml0Qm9tYigpO1xuXG4gICAgaWYgKCF0aGlzLmR5bmFtaWMpIHtcbiAgICAgIHRoaXMuc3RhcnQoKTtcbiAgICB9XG4gIH07XG5cbiAgLyoqXG4gICAqIFJlc2V0cyBpbml0aWFsIHN0YXRlLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgcmVzZXRcbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEJvbWJUYXNrLnByb3RvdHlwZS5yZXNldCA9IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuaW5pdCgpO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTZXRzIGBzdGFydGVkYCBmbGFnLiBJZiBgZHluYW1pY2AgaXMgdHJ1ZSxcbiAgICogdGhlIGludGVydmFsIHdpbGwgc3RhcnQgdG8gcmV2ZWFsIGNhcmRzLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2Qgc3RhcnRcbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEJvbWJUYXNrLnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uKGluZGV4KSB7XG4gICAgaWYgKHRoaXMuZHluYW1pYykge1xuICAgICAgdmFyICRpbnRlcnZhbCA9IHRoaXMuJGluamVjdG9yLmdldCgnJGludGVydmFsJyk7XG5cbiAgICAgIHRoaXMuX2ludEluZGV4ID0gaW5kZXggfHwgMDtcblxuICAgICAgdmFyIG1lID0gdGhpcztcbiAgICAgIHZhciBtYXggPSB0aGlzLml0ZXJhdG9yLmxlbmd0aDtcbiAgICAgIHRoaXMuX2ludGVydmFsSWQgPSAkaW50ZXJ2YWwoXG4gICAgICAgIGZ1bmN0aW9uKCl7XG5cbiAgICAgICAgICB2YXIgaXRlbSA9IG1lLml0ZXJhdG9yW21lLl9pbnRJbmRleF07XG4gICAgICAgICAgbWUudXBkYXRlKGl0ZW0sdHJ1ZSk7XG5cbiAgICAgICAgICBtZS5faW50SW5kZXgrKztcbiAgICAgICAgICBpZiAobWUuX2ludEluZGV4PT09bWF4KSB7XG4gICAgICAgICAgICBtZS5zdG9wKCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgIH0sXG4gICAgICAgIHRoaXMuaW50ZXJ2YWwqMTAwMCwgLy8gPSBmcm9tIHNlY29uZHNcbiAgICAgICAgbWF4IC0gdGhpcy5faW50SW5kZXggLy8gPSBtYXggaXRlcmF0aW9uc1xuICAgICAgKTtcbiAgICB9XG5cbiAgICB0aGlzLnN0YXJ0ZWQgPSB0cnVlO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTZXRzIGBzdG9wcGVkYCBmbGFnLiBJZiBgZHluYW1pY2AgaXMgdHJ1ZSxcbiAgICogdGhlIGludGVydmFsIHdpbGwgYmUgc3RvcHBlZCBpbiBhZGRpdGlvbi5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIHN0YXJ0XG4gICAqIEByZXR1cm4ge1ZvaWR9XG4gICAqL1xuICBCb21iVGFzay5wcm90b3R5cGUuc3RvcCA9IGZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLmR5bmFtaWMgJiYgdGhpcy5faW50ZXJ2YWxJZCkge1xuICAgICAgdmFyICRpbnRlcnZhbCA9IHRoaXMuJGluamVjdG9yLmdldCgnJGludGVydmFsJyk7XG4gICAgICAkaW50ZXJ2YWwuY2FuY2VsKHRoaXMuX2ludGVydmFsSWQpO1xuICAgIH1cblxuICAgIHRoaXMuc3RvcHBlZCA9IHRydWU7XG4gIH07XG5cbiAgLyoqXG4gICAqIFNldHMgYHJlc29sdmVkYCBmbGFnLiBDYWxscyBgb25SZXNvbHZlYFxuICAgKiBjYWxsYmFjayB3aXRoIEpTT04gcmVzdWx0IGZvciBjb25zdW1lci5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIHJlc29sdmVcbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEJvbWJUYXNrLnByb3RvdHlwZS5yZXNvbHZlID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyICRxID0gdGhpcy4kaW5qZWN0b3IuZ2V0KCckcScpO1xuICAgIHZhciByZXN1bHQgPSB0aGlzLm9uUmVzb2x2ZSh7XG4gICAgICBwYXlsb2FkOiB0aGlzLmdldFBheWxvYWQoKVxuICAgIH0pO1xuXG4gICAgdmFyIHJlc29sdmVDYXJkID0gZnVuY3Rpb24oY2FyZCkge1xuICAgICAgY2FyZC4kJHJlc29sdmVkID0gdHJ1ZTtcbiAgICB9O1xuXG4gICAgdmFyIG1lID0gdGhpcztcbiAgICB2YXIgc3VjY2Vzc0NhbGxiYWNrID0gZnVuY3Rpb24oKSB7XG4gICAgICBhbmd1bGFyLmZvckVhY2gobWUuY29sbGVjdGlvbiwgcmVzb2x2ZUNhcmQpO1xuICAgICAgbWUucmVzb2x2ZWQgPSB0cnVlO1xuICAgIH07XG4gICAgdmFyIGZhaWx1cmVDYWxsYmFjayA9IGZ1bmN0aW9uKCkge1xuXG4gICAgfTtcblxuICAgIHZhciBwcm9taXNlID0gJHEud2hlbihyZXN1bHQpO1xuICAgIHByb21pc2UudGhlbihcbiAgICAgIHN1Y2Nlc3NDYWxsYmFjayxcbiAgICAgIGZhaWx1cmVDYWxsYmFja1xuICAgICk7XG5cbiAgICByZXR1cm4gcHJvbWlzZTtcbiAgfTtcblxuICAvKipcbiAgICogQ2FsbGJhY2sgZm9yIGNhcmQgY2xpY2suIFVwZGF0ZXMgYWxsXG4gICAqIHJlbGF0ZWQgcHJvcGVydGllcyBmb3IgZmluYWwgcmVzdWx0LlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgdXBkYXRlXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBjb2x1bW5cbiAgICogQHBhcmFtIHtib29sZWFufSBhY3RpdmVcbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEJvbWJUYXNrLnByb3RvdHlwZS51cGRhdGUgPSBmdW5jdGlvbihjb2x1bW4sIGFjdGl2ZSkge1xuICAgIHZhciBpbmRleCA9IHRoaXMuY29sbGVjdGlvbi5pbmRleE9mKGNvbHVtbik7XG5cbiAgICBpZiAoYWN0aXZlKSB7XG4gICAgICBpZiAoaW5kZXg8MCnCoHtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9uLnB1c2goY29sdW1uKTtcbiAgICAgICAgdGhpcy5jb2xsZWN0ZWRCb3hlcysrO1xuICAgICAgfVxuXG4gICAgICBjb2x1bW4uJCRhY3RpdmUgPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoaW5kZXg+PTApIHtcbiAgICAgICAgdGhpcy5jb2xsZWN0aW9uLnNwbGljZShpbmRleCwxKTtcbiAgICAgICAgY29sdW1uLiQkYWN0aXZlID0gZmFsc2U7XG4gICAgICAgIHRoaXMuY29sbGVjdGVkQm94ZXMtLTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc0JvbWIoY29sdW1uKSkge1xuICAgICAgdGhpcy5oYXNCb21iID0gdHJ1ZTtcbiAgICB9XG5cbiAgICB2YXIgdG90YWwgPSB0aGlzLnRvdGFsQm94ZXM7XG4gICAgdmFyIGNvbGxlY3RlZCA9IHRoaXMuY29sbGVjdGVkQm94ZXM7XG4gICAgdGhpcy5yZW1haW5pbmdCb3hlcyA9IHRvdGFsIC0gY29sbGVjdGVkO1xuICB9O1xuXG4gIC8qKlxuICAgKiBQcm92aWRlcyBpbmRpdml1YWwgdHJhY2tpbmcgaWQgZm9yIGNvbHVtbi5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIHRyYWNrSWRcbiAgICogQHBhcmFtIHtvYmplY3R9IGNvbHVtblxuICAgKiBAcmV0dXJuIHtWb2lkfVxuICAgKi9cbiAgQm9tYlRhc2sucHJvdG90eXBlLnRyYWNrSWQgPSBmdW5jdGlvbihjb2x1bW4pIHtcbiAgICByZXR1cm4gY29sdW1uLnJvdyArICdfJyArIGNvbHVtbi5jb2w7XG4gIH07XG5cbiAgLyoqXG4gICAqIERldGVybWluZXMgaWYgY29sdW1uIGlzIGFjdHVhbCBib21iLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgaXNCb21iXG4gICAqIEBwYXJhbSB7b2JqZWN0fSBjb2x1bW5cbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEJvbWJUYXNrLnByb3RvdHlwZS5pc0JvbWIgPSBmdW5jdGlvbihjb2x1bW4pIHtcbiAgICByZXR1cm4gYW5ndWxhci5lcXVhbHModGhpcy5ib21iLGNvbHVtbik7XG4gIH07XG5cbiAgLyoqXG4gICAqIEluaXRpYWx6ZXMgaW50ZXJuYWwgcHJvcGVydGllcy5cbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQG1ldGhvZCBfaW5pdE1lbWJlcnNcbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEJvbWJUYXNrLnByb3RvdHlwZS5faW5pdE1lbWJlcnMgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLmNvbGxlY3Rpb24gPSBbXTtcblxuICAgIHRoaXMuaGFzQm9tYiA9IGZhbHNlO1xuICAgIHRoaXMuc3RhcnRlZCA9IGZhbHNlO1xuICAgIHRoaXMuc3RvcHBlZCA9IGZhbHNlO1xuICAgIHRoaXMucmVzb2x2ZWQgPSBmYWxzZTtcblxuICAgIHRoaXMuY29sbGVjdGVkQm94ZXMgPSAwO1xuICAgIHRoaXMucmVtYWluaW5nQm94ZXMgPSAwO1xuICAgIHRoaXMudG90YWxCb3hlcyA9IHRoaXMucm93cyAqIHRoaXMuY29scztcbiAgfTtcblxuICAvKipcbiAgICogQ2FsY3VsYXRlcyB0aGUgYWN0dWFsIG1hdHJpeC5cbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQG1ldGhvZCBfaW5pdE1hdHJpeFxuICAgKiBAcmV0dXJuIHtWb2lkfVxuICAgKi9cbiAgQm9tYlRhc2sucHJvdG90eXBlLl9pbml0TWF0cml4ID0gZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5tYXRyaXggPSBbXTtcbiAgICB0aGlzLml0ZXJhdG9yID0gW107XG5cbiAgICBmb3IgKHZhciBpPTA7IGk8dGhpcy5yb3dzOyBpKyspIHtcblxuICAgICAgdmFyIGNvbHVtbnMgPSBbXTtcbiAgICAgIGZvciggdmFyIGo9MDsgajx0aGlzLmNvbHM7IGorKyApIHtcbiAgICAgICAgdmFyIGRhdGEgPSB7XG4gICAgICAgICAgcm93OiBpKzEsXG4gICAgICAgICAgY29sOiBqKzFcbiAgICAgICAgfTtcblxuICAgICAgICBjb2x1bW5zLnB1c2goZGF0YSk7XG5cbiAgICAgICAgaWYgKHRoaXMuZHluYW1pYykge1xuICAgICAgICAgIGlmICghdGhpcy5yYW5kb20pIHtcbiAgICAgICAgICAgIHRoaXMuaXRlcmF0b3IucHVzaChkYXRhKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIHJhbmRvbSA9IHRoaXMuJGluamVjdG9yLmdldCgncmFuZG9tJyk7XG4gICAgICAgICAgICByYW5kb20ucHVzaCh0aGlzLml0ZXJhdG9yLGRhdGEpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB0aGlzLm1hdHJpeC5wdXNoKGNvbHVtbnMpO1xuICAgIH1cbiAgfTtcblxuICAvKipcbiAgICogSW5pdGlhbGl6ZXMgYm9tYidzIGFjdHVhbCBsb2NhdGlvbi5cbiAgICpcbiAgICogQHByaXZhdGVcbiAgICogQG1ldGhvZCBfaW5pdEJvbWJcbiAgICogQHJldHVybiB7Vm9pZH1cbiAgICovXG4gIEJvbWJUYXNrLnByb3RvdHlwZS5faW5pdEJvbWIgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgcmFuZG9tID0gdGhpcy4kaW5qZWN0b3IuZ2V0KCdyYW5kb20nKTtcblxuICAgIHZhciByb3cgPSByYW5kb20uYmV0d2VlbigwLHRoaXMucm93cy0xKTtcbiAgICB2YXIgY29sID0gcmFuZG9tLmJldHdlZW4oMCx0aGlzLmNvbHMtMSk7XG5cbiAgICB0aGlzLmJvbWIgPSB0aGlzLm1hdHJpeFtyb3ddW2NvbF07XG4gIH07XG5cbiAgLy9cbiAgLy8gUkVHSVNUUllcbiAgLy9cbiAgYW5ndWxhci5tb2R1bGUobW9kdWxlKS5kaXJlY3RpdmUoJ2JvbWJUYXNrJyxmdW5jdGlvbigpe1xuICAgIHJldHVybiB7XG4gICAgICBzY29wZToge1xuICAgICAgICBhdmc6ICc9P2JvbWJUYXNrQXZnJyxcbiAgICAgICAgcm93czogJz0/Ym9tYlRhc2tSb3dzJyxcbiAgICAgICAgY29sczogJz0/Ym9tYlRhc2tDb2xzJyxcbiAgICAgICAgcmFuZG9tOiAnPT9ib21iVGFza1JhbmRvbScsXG4gICAgICAgIGR5bmFtaWM6ICc9P2JvbWJUYXNrRHluYW1pYycsXG4gICAgICAgIGludGVydmFsOiAnPT9ib21iVGFza0ludGVydmFsJyxcbiAgICAgICAgb25SZXNvbHZlOiAnJmJvbWJUYXNrT25SZXNvbHZlJ1xuICAgICAgfSxcbiAgICAgIHJlc3RyaWN0OiAnQScsXG4gICAgICB0cmFuc2NsdWRlOiB0cnVlLFxuICAgICAgY29udHJvbGxlcjogQm9tYlRhc2ssXG4gICAgICBiaW5kVG9Db250cm9sbGVyOiB0cnVlLFxuICAgICAgY29udHJvbGxlckFzOiAnYm9tYlRhc2tDb250cm9sbGVyJyxcbiAgICAgIHRlbXBsYXRlVXJsOiAndmlld3MvZGlyZWN0aXZlcy90YXNrcy9ib21iLXRhc2suaHRtbCdcbiAgICB9O1xuICB9KTtcblxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBCb21iVGFzayBDYXJkXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgLy9cbiAgLy8gQ09OVFJPTExFUlxuICAvL1xuXG4gIC8qKlxuICAgKiBAY29uc3RydWN0b3JcbiAgICovXG4gIHZhciBCb21iVGFza0NhcmQgPSBmdW5jdGlvbigpe1xuICB9O1xuXG4gIC8vXG4gIC8vIFBST1BFUlRJRVNcbiAgLy9cblxuICAvKiogQHZhciB7c3RyaW5nfSBpZCBDYXJkJ3MgYWNjb2NpYXRlZCBtb2RlbC4gKi9cbiAgQm9tYlRhc2tDYXJkLnByb3RvdHlwZS5tb2RlbCA9IG51bGw7XG5cbiAgLyoqIEB2YXIge3N0cmluZ30gaXNBY3RpdmUgSWYgY2FyZCBpcyBhY3RpdmUuICovXG4gIEJvbWJUYXNrQ2FyZC5wcm90b3R5cGUuaXNBY3RpdmUgPSBmYWxzZTtcblxuICAvKiogQHZhciB7c3RyaW5nfSBpc0Rpc2FibGVkIElmIGNhcmQgaXMgZGlzYWJsZWQuICovXG4gIEJvbWJUYXNrQ2FyZC5wcm90b3R5cGUuaXNEaXNhYmxlZCA9IGZhbHNlO1xuXG4gIC8qKiBAdmFyIHtzdHJpbmd9IGlzQ2xpY2thYmxlIElmIGNhcmQgaXMgY2xpY2thYmxlLiAqL1xuICBCb21iVGFza0NhcmQucHJvdG90eXBlLmlzQ2xpY2thYmxlID0gdHJ1ZTtcblxuICAvL1xuICAvLyBNRVRIT0RTXG4gIC8vXG5cbiAgLyoqXG4gICAqIFRvZ2dsZXMgYGlzQWN0aXZlYCBpZiBgaXNEaXNhYmxlZGAgYW5kXG4gICAqIGBpc0NsaWNrYWJsZWAgYWxsb3cgdGhlIGFjdGlvbi4gSW52b2tlc1xuICAgKiBgb25Ub2dnbGVgIGNhbGxiYWNrIGZvciBjb25zdW1lci5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIHRvZ2dsZVxuICAgKiBAcmV0dXJuIHtWb2lkfVxuICAgKi9cbiAgQm9tYlRhc2tDYXJkLnByb3RvdHlwZS50b2dnbGUgPSBmdW5jdGlvbigpIHtcbiAgICBpZiAodGhpcy5pc0Rpc2FibGVkIHx8ICF0aGlzLmlzQ2xpY2thYmxlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5pc0FjdGl2ZSA9ICF0aGlzLmlzQWN0aXZlO1xuXG4gICAgdGhpcy5vblRvZ2dsZSh7XG4gICAgICBtb2RlbDp0aGlzLm1vZGVsLFxuICAgICAgc3RhdGU6dGhpcy5pc0FjdGl2ZVxuICAgIH0pO1xuICB9O1xuXG4gIC8vIHJlZ2lzdHJ5XG4gIGFuZ3VsYXIubW9kdWxlKG1vZHVsZSkuZGlyZWN0aXZlKCdib21iVGFza0NhcmQnLCBmdW5jdGlvbigpe1xuICAgIHJldHVybiB7XG4gICAgICBzY29wZToge1xuICAgICAgICBtb2RlbDonPWJvbWJUYXNrQ2FyZCcsXG4gICAgICAgIG9uVG9nZ2xlOicmYm9tYlRhc2tDYXJkT25Ub2dnbGUnLFxuICAgICAgICBpc0FjdGl2ZTonPT9ib21iVGFza0NhcmRJc0FjdGl2ZScsXG4gICAgICAgIGlzRGlzYWJsZWQ6Jz0/Ym9tYlRhc2tDYXJkSXNEaXNhYmxlZCcsXG4gICAgICAgIGlzQ2xpY2thYmxlOic9P2JvbWJUYXNrQ2FyZElzQ2xpY2thYmxlJ1xuICAgICAgfSxcbiAgICAgIHJlc3RyaWN0OiAnQScsXG4gICAgICB0cmFuc2NsdWRlOiB0cnVlLFxuICAgICAgY29udHJvbGxlcjogQm9tYlRhc2tDYXJkLFxuICAgICAgYmluZFRvQ29udHJvbGxlcjogdHJ1ZSxcbiAgICAgIGNvbnRyb2xsZXJBczogJ2JvbWJUYXNrQ2FyZENvbnRyb2xsZXInLFxuICAgICAgdGVtcGxhdGVVcmw6ICd2aWV3cy9kaXJlY3RpdmVzL3Rhc2tzL2JvbWItdGFzay1jYXJkLmh0bWwnXG4gICAgfTtcbiAgfSk7XG5cbn0pKEFOR1VMQVJfTU9EVUxFLCBhbmd1bGFyKTtcbiJdfQ==

/*!
 * eFit Website
 * An app for financial training in educational environments
 * http://www.e-fit.com
 * @author Armin Pfurtscheller
 * @version 1.0.0
 * Copyright 2017. MIT licensed.
 */
/* global ANGULAR_MODULE, angular */
(function(module, angular) {
  'use strict';

  // --------------------------------------------------
  // SavingsTargetTask
  // --------------------------------------------------

  //
  // CONTROLLER
  //

  /**
   * @constructor
   */
  var SavingsTargetTask = function($scope, $element, $attrs, $injector) {
    var type = $injector.get('TYPE_SAVINGS_TARGET');

    this.$attrs = $attrs;
    this.$scope = $scope;
    this.$element = $element;
    this.$injector = $injector;

    this.user = this.$injector.get('user');
    this.task = this.user.getTaskByType(type);
    this.result = this.user.getPendingByType(type);

    this.storage = this.$injector.get('storage').getProxy();
    this._storageKey = '__savings__target__task__updated__at__';
  };

  SavingsTargetTask.$inject = ['$scope','$element','$attrs', '$injector'];

  // SERVER

  /** @var {object} user Alias to user service. */
  SavingsTargetTask.prototype.user = null;

  /** @var {object} task Task's resource from server. */
  SavingsTargetTask.prototype.task = null;

  /** @var {object} result Task's pending result from server. */
  SavingsTargetTask.prototype.result = null;

  // GAMEPLAY

  /** @var {number} step Current step . */
  SavingsTargetTask.prototype.step = 1;

  /** @var {number} total Players wish for saving target. */
  SavingsTargetTask.prototype.total = 3;

  /** @var {string} wish Players wish for saving target. */
  SavingsTargetTask.prototype.wish = null;

  /** @var {number} amount Players first amount for saving target. */
  SavingsTargetTask.prototype.amount = null;

  /** @var {number} amountRepeated Players second amount for saving target. */
  SavingsTargetTask.prototype.amountRepeated = null;

  /** @var {boolean} resolved If player has resolved the game. */
  SavingsTargetTask.prototype.resolved = false;

  // MISC

  /** @var {object} form Form collecting user input. */
  SavingsTargetTask.prototype.form = null;

  //
  // METHODS
  //

  /**
   * Proxies to `init()` if controller's ready.
   *
   * @public
   * @method $onInit
   * @return {void}
   */
  SavingsTargetTask.prototype.$onInit = function() {
    this.init();
  };

  /**
   * Retrieves result payload for server.
   *
   * @public
   * @method getPayload
   * @return {void}
   */
  SavingsTargetTask.prototype.getPayload = function() {
    var payload = {
      task: this.task,
      json: {
        step: this.step,
        wish: this.wish,
        total: this.total,
        amount: this.amount,
        amountRepeated: this.amountRepeated
      },
      isPending: this.amountRepeated === null
    };

    if (this.result !== null) {
      payload = angular.extend(
        this.result,
        payload
      );
    }

    return payload;
  };

  /**
   * Whether or not task is currently locked.
   *
   * @public
   * @method isLocked
   * @return {boolean}
   */
  SavingsTargetTask.prototype.isLocked = function() {
    if (this.task === null) {
      return true;
    }

    // if result was created and
    // we are waiting for paused
    // state, we skip unlocking
    // by using internal `_flag`
    if (this.task.isActive) {
      return !!this._flag;
    }

    // reset `_flag` as soon as
    // `isActive` changed again
    this.storage.removeItem(
      this._storageKey
    );

    this._flag = 0;
    return true;
  };

  /**
   * Whether or not task can be sent to server.
   *
   * @public
   * @method canResolve
   * @return {boolean}
   */
  SavingsTargetTask.prototype.canResolve = function() {
    var user = this.$injector.get('user');
    if (!user.isUser()) {
      return false;
    }

    if (this.form.$invalid) {
      return false;
    }

    if (this.isLocked()) {
      return false;
    }

    if (this.resolved) {
      return false;
    }

    return true;
  };

  /**
   * Sets up initial state.
   *
   * @public
   * @method init
   * @return {void}
   */
  SavingsTargetTask.prototype.init = function() {
    if (this.result !== null) {
      var json = this.result.json;

      // set flag only if still waiting for `isActive` change
      var updatedAt = this.storage.getItem(this._storageKey);
      if (angular.isNumber(updatedAt)) {
        this._flag = updatedAt >= this.task.updatedAt;
      }

      this.amountRepeated = json.amountRepeated ||Â 100;
      this.amount = json.amount;
      this.total = json.total;
      this.wish = json.wish;
      this.step = json.step;
    }

    this.resolved = false;
  };

  /**
   * Resets initial state.
   *
   * @public
   * @method reset
   * @return {void}
   */
  SavingsTargetTask.prototype.reset = function(){
    this.init();
  };

  /**
   * Increases `step` and invokes `resolve()`.
   *
   * @public
   * @method update
   * @return {void}
   */
  SavingsTargetTask.prototype.update = function(){
    if (this.step < this.total) {
      this.step++;
    }

    if (!this.canResolve()) {
      return;
    }

    var me = this;
    var successCallback = function(){};
    var failureCallback = function(){
      me.step--;
    };

    this.resolve().then(
      successCallback,
      failureCallback
    );
  };

  /**
   * Sets `resolved` flag. Calls `onResolve`
   * callback with JSON result for consumer.
   *
   * @public
   * @method resolve
   * @return {void}
   */
  SavingsTargetTask.prototype.resolve = function(){
    var notification = this.$injector.get('notification');
    var i18n = this.$injector.get('i18n');
    var $q = this.$injector.get('$q');

    var callback = this.result === null ?
      this.onResolve :
      this.onUpdate;

    var result = callback({
      payload: this.getPayload()
    });

    var me = this;
    var successCallback = function(result) {
      if (result.isPending) {
        if (me.step < me.total) {
          var message = i18n.get('Thank you for your input!');
          notification.success(message);
        }

        me.result = result;

        me.storage.setItem(
          me._storageKey,
          me.task.updatedAt
        );

        me._flag = 1;
        return;
      }

      me.resolved = true;
    };

    var failureCallback = function() {
    };

    var promise = $q.when(result);
    promise.then(
      successCallback,
      failureCallback
    );

    return promise;
  };

  /**
   * Calculates difference between `amount` and `amountRepeated`.
   *
   * @public
   * @method getDifference
   * @return {void}
   */
  SavingsTargetTask.prototype.getDifference = function(){
    return this.amountRepeated - this.amount;
  };

  //
  // REGISTRY
  //
  angular.module(module).directive('savingsTargetTask', function(){
    return {
      scope: {
        onUpdate: '&savingsTargetTaskOnUpdate',
        onResolve: '&savingsTargetTaskOnResolve'
      },
      restrict: 'A',
      transclude: true,
      controller: SavingsTargetTask,
      bindToController: true,
      controllerAs: 'savingsTargetTaskController',
      templateUrl: 'views/directives/tasks/savings-target-task.html'
    };
  });

})(ANGULAR_MODULE, angular);

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9kaXJlY3RpdmVzL3Rhc2tzL3NhdmluZ3MtdGFyZ2V0LXRhc2suanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoiYXBwL2RpcmVjdGl2ZXMvdGFza3Mvc2F2aW5ncy10YXJnZXQtdGFzay5taW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBnbG9iYWwgQU5HVUxBUl9NT0RVTEUsIGFuZ3VsYXIgKi9cbihmdW5jdGlvbihtb2R1bGUsIGFuZ3VsYXIpIHtcbiAgJ3VzZSBzdHJpY3QnO1xuXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIFNhdmluZ3NUYXJnZXRUYXNrXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5cbiAgLy9cbiAgLy8gQ09OVFJPTExFUlxuICAvL1xuXG4gIC8qKlxuICAgKiBAY29uc3RydWN0b3JcbiAgICovXG4gIHZhciBTYXZpbmdzVGFyZ2V0VGFzayA9IGZ1bmN0aW9uKCRzY29wZSwgJGVsZW1lbnQsICRhdHRycywgJGluamVjdG9yKSB7XG4gICAgdmFyIHR5cGUgPSAkaW5qZWN0b3IuZ2V0KCdUWVBFX1NBVklOR1NfVEFSR0VUJyk7XG5cbiAgICB0aGlzLiRhdHRycyA9ICRhdHRycztcbiAgICB0aGlzLiRzY29wZSA9ICRzY29wZTtcbiAgICB0aGlzLiRlbGVtZW50ID0gJGVsZW1lbnQ7XG4gICAgdGhpcy4kaW5qZWN0b3IgPSAkaW5qZWN0b3I7XG5cbiAgICB0aGlzLnVzZXIgPSB0aGlzLiRpbmplY3Rvci5nZXQoJ3VzZXInKTtcbiAgICB0aGlzLnRhc2sgPSB0aGlzLnVzZXIuZ2V0VGFza0J5VHlwZSh0eXBlKTtcbiAgICB0aGlzLnJlc3VsdCA9IHRoaXMudXNlci5nZXRQZW5kaW5nQnlUeXBlKHR5cGUpO1xuXG4gICAgdGhpcy5zdG9yYWdlID0gdGhpcy4kaW5qZWN0b3IuZ2V0KCdzdG9yYWdlJykuZ2V0UHJveHkoKTtcbiAgICB0aGlzLl9zdG9yYWdlS2V5ID0gJ19fc2F2aW5nc19fdGFyZ2V0X190YXNrX191cGRhdGVkX19hdF9fJztcbiAgfTtcblxuICBTYXZpbmdzVGFyZ2V0VGFzay4kaW5qZWN0ID0gWyckc2NvcGUnLCckZWxlbWVudCcsJyRhdHRycycsICckaW5qZWN0b3InXTtcblxuICAvLyBTRVJWRVJcblxuICAvKiogQHZhciB7b2JqZWN0fSB1c2VyIEFsaWFzIHRvIHVzZXIgc2VydmljZS4gKi9cbiAgU2F2aW5nc1RhcmdldFRhc2sucHJvdG90eXBlLnVzZXIgPSBudWxsO1xuXG4gIC8qKiBAdmFyIHtvYmplY3R9IHRhc2sgVGFzaydzIHJlc291cmNlIGZyb20gc2VydmVyLiAqL1xuICBTYXZpbmdzVGFyZ2V0VGFzay5wcm90b3R5cGUudGFzayA9IG51bGw7XG5cbiAgLyoqIEB2YXIge29iamVjdH0gcmVzdWx0IFRhc2sncyBwZW5kaW5nIHJlc3VsdCBmcm9tIHNlcnZlci4gKi9cbiAgU2F2aW5nc1RhcmdldFRhc2sucHJvdG90eXBlLnJlc3VsdCA9IG51bGw7XG5cbiAgLy8gR0FNRVBMQVlcblxuICAvKiogQHZhciB7bnVtYmVyfSBzdGVwIEN1cnJlbnQgc3RlcCAuICovXG4gIFNhdmluZ3NUYXJnZXRUYXNrLnByb3RvdHlwZS5zdGVwID0gMTtcblxuICAvKiogQHZhciB7bnVtYmVyfSB0b3RhbCBQbGF5ZXJzIHdpc2ggZm9yIHNhdmluZyB0YXJnZXQuICovXG4gIFNhdmluZ3NUYXJnZXRUYXNrLnByb3RvdHlwZS50b3RhbCA9IDM7XG5cbiAgLyoqIEB2YXIge3N0cmluZ30gd2lzaCBQbGF5ZXJzIHdpc2ggZm9yIHNhdmluZyB0YXJnZXQuICovXG4gIFNhdmluZ3NUYXJnZXRUYXNrLnByb3RvdHlwZS53aXNoID0gbnVsbDtcblxuICAvKiogQHZhciB7bnVtYmVyfSBhbW91bnQgUGxheWVycyBmaXJzdCBhbW91bnQgZm9yIHNhdmluZyB0YXJnZXQuICovXG4gIFNhdmluZ3NUYXJnZXRUYXNrLnByb3RvdHlwZS5hbW91bnQgPSBudWxsO1xuXG4gIC8qKiBAdmFyIHtudW1iZXJ9IGFtb3VudFJlcGVhdGVkIFBsYXllcnMgc2Vjb25kIGFtb3VudCBmb3Igc2F2aW5nIHRhcmdldC4gKi9cbiAgU2F2aW5nc1RhcmdldFRhc2sucHJvdG90eXBlLmFtb3VudFJlcGVhdGVkID0gbnVsbDtcblxuICAvKiogQHZhciB7Ym9vbGVhbn0gcmVzb2x2ZWQgSWYgcGxheWVyIGhhcyByZXNvbHZlZCB0aGUgZ2FtZS4gKi9cbiAgU2F2aW5nc1RhcmdldFRhc2sucHJvdG90eXBlLnJlc29sdmVkID0gZmFsc2U7XG5cbiAgLy8gTUlTQ1xuXG4gIC8qKiBAdmFyIHtvYmplY3R9IGZvcm0gRm9ybSBjb2xsZWN0aW5nIHVzZXIgaW5wdXQuICovXG4gIFNhdmluZ3NUYXJnZXRUYXNrLnByb3RvdHlwZS5mb3JtID0gbnVsbDtcblxuICAvL1xuICAvLyBNRVRIT0RTXG4gIC8vXG5cbiAgLyoqXG4gICAqIFByb3hpZXMgdG8gYGluaXQoKWAgaWYgY29udHJvbGxlcidzIHJlYWR5LlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgJG9uSW5pdFxuICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgKi9cbiAgU2F2aW5nc1RhcmdldFRhc2sucHJvdG90eXBlLiRvbkluaXQgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLmluaXQoKTtcbiAgfTtcblxuICAvKipcbiAgICogUmV0cmlldmVzIHJlc3VsdCBwYXlsb2FkIGZvciBzZXJ2ZXIuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCBnZXRQYXlsb2FkXG4gICAqIEByZXR1cm4ge3ZvaWR9XG4gICAqL1xuICBTYXZpbmdzVGFyZ2V0VGFzay5wcm90b3R5cGUuZ2V0UGF5bG9hZCA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciBwYXlsb2FkID0ge1xuICAgICAgdGFzazogdGhpcy50YXNrLFxuICAgICAganNvbjoge1xuICAgICAgICBzdGVwOiB0aGlzLnN0ZXAsXG4gICAgICAgIHdpc2g6IHRoaXMud2lzaCxcbiAgICAgICAgdG90YWw6IHRoaXMudG90YWwsXG4gICAgICAgIGFtb3VudDogdGhpcy5hbW91bnQsXG4gICAgICAgIGFtb3VudFJlcGVhdGVkOiB0aGlzLmFtb3VudFJlcGVhdGVkXG4gICAgICB9LFxuICAgICAgaXNQZW5kaW5nOiB0aGlzLmFtb3VudFJlcGVhdGVkID09PSBudWxsXG4gICAgfTtcblxuICAgIGlmICh0aGlzLnJlc3VsdCAhPT0gbnVsbCkge1xuICAgICAgcGF5bG9hZCA9IGFuZ3VsYXIuZXh0ZW5kKFxuICAgICAgICB0aGlzLnJlc3VsdCxcbiAgICAgICAgcGF5bG9hZFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gcGF5bG9hZDtcbiAgfTtcblxuICAvKipcbiAgICogV2hldGhlciBvciBub3QgdGFzayBpcyBjdXJyZW50bHkgbG9ja2VkLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgaXNMb2NrZWRcbiAgICogQHJldHVybiB7Ym9vbGVhbn1cbiAgICovXG4gIFNhdmluZ3NUYXJnZXRUYXNrLnByb3RvdHlwZS5pc0xvY2tlZCA9IGZ1bmN0aW9uKCkge1xuICAgIGlmICh0aGlzLnRhc2sgPT09IG51bGwpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIGlmIHJlc3VsdCB3YXMgY3JlYXRlZCBhbmRcbiAgICAvLyB3ZSBhcmUgd2FpdGluZyBmb3IgcGF1c2VkXG4gICAgLy8gc3RhdGUsIHdlIHNraXAgdW5sb2NraW5nXG4gICAgLy8gYnkgdXNpbmcgaW50ZXJuYWwgYF9mbGFnYFxuICAgIGlmICh0aGlzLnRhc2suaXNBY3RpdmUpIHtcbiAgICAgIHJldHVybiAhIXRoaXMuX2ZsYWc7XG4gICAgfVxuXG4gICAgLy8gcmVzZXQgYF9mbGFnYCBhcyBzb29uIGFzXG4gICAgLy8gYGlzQWN0aXZlYCBjaGFuZ2VkIGFnYWluXG4gICAgdGhpcy5zdG9yYWdlLnJlbW92ZUl0ZW0oXG4gICAgICB0aGlzLl9zdG9yYWdlS2V5XG4gICAgKTtcblxuICAgIHRoaXMuX2ZsYWcgPSAwO1xuICAgIHJldHVybiB0cnVlO1xuICB9O1xuXG4gIC8qKlxuICAgKiBXaGV0aGVyIG9yIG5vdCB0YXNrIGNhbiBiZSBzZW50IHRvIHNlcnZlci5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIGNhblJlc29sdmVcbiAgICogQHJldHVybiB7Ym9vbGVhbn1cbiAgICovXG4gIFNhdmluZ3NUYXJnZXRUYXNrLnByb3RvdHlwZS5jYW5SZXNvbHZlID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIHVzZXIgPSB0aGlzLiRpbmplY3Rvci5nZXQoJ3VzZXInKTtcbiAgICBpZiAoIXVzZXIuaXNVc2VyKCkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5mb3JtLiRpbnZhbGlkKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNMb2NrZWQoKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnJlc29sdmVkKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH07XG5cbiAgLyoqXG4gICAqIFNldHMgdXAgaW5pdGlhbCBzdGF0ZS5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIGluaXRcbiAgICogQHJldHVybiB7dm9pZH1cbiAgICovXG4gIFNhdmluZ3NUYXJnZXRUYXNrLnByb3RvdHlwZS5pbml0ID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMucmVzdWx0ICE9PSBudWxsKSB7XG4gICAgICB2YXIganNvbiA9IHRoaXMucmVzdWx0Lmpzb247XG5cbiAgICAgIC8vIHNldCBmbGFnIG9ubHkgaWYgc3RpbGwgd2FpdGluZyBmb3IgYGlzQWN0aXZlYCBjaGFuZ2VcbiAgICAgIHZhciB1cGRhdGVkQXQgPSB0aGlzLnN0b3JhZ2UuZ2V0SXRlbSh0aGlzLl9zdG9yYWdlS2V5KTtcbiAgICAgIGlmIChhbmd1bGFyLmlzTnVtYmVyKHVwZGF0ZWRBdCkpIHtcbiAgICAgICAgdGhpcy5fZmxhZyA9IHVwZGF0ZWRBdCA+PSB0aGlzLnRhc2sudXBkYXRlZEF0O1xuICAgICAgfVxuXG4gICAgICB0aGlzLmFtb3VudFJlcGVhdGVkID0ganNvbi5hbW91bnRSZXBlYXRlZCB8fMKgMTAwO1xuICAgICAgdGhpcy5hbW91bnQgPSBqc29uLmFtb3VudDtcbiAgICAgIHRoaXMudG90YWwgPSBqc29uLnRvdGFsO1xuICAgICAgdGhpcy53aXNoID0ganNvbi53aXNoO1xuICAgICAgdGhpcy5zdGVwID0ganNvbi5zdGVwO1xuICAgIH1cblxuICAgIHRoaXMucmVzb2x2ZWQgPSBmYWxzZTtcbiAgfTtcblxuICAvKipcbiAgICogUmVzZXRzIGluaXRpYWwgc3RhdGUuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCByZXNldFxuICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgKi9cbiAgU2F2aW5nc1RhcmdldFRhc2sucHJvdG90eXBlLnJlc2V0ID0gZnVuY3Rpb24oKXtcbiAgICB0aGlzLmluaXQoKTtcbiAgfTtcblxuICAvKipcbiAgICogSW5jcmVhc2VzIGBzdGVwYCBhbmQgaW52b2tlcyBgcmVzb2x2ZSgpYC5cbiAgICpcbiAgICogQHB1YmxpY1xuICAgKiBAbWV0aG9kIHVwZGF0ZVxuICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgKi9cbiAgU2F2aW5nc1RhcmdldFRhc2sucHJvdG90eXBlLnVwZGF0ZSA9IGZ1bmN0aW9uKCl7XG4gICAgaWYgKHRoaXMuc3RlcCA8IHRoaXMudG90YWwpIHtcbiAgICAgIHRoaXMuc3RlcCsrO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5jYW5SZXNvbHZlKCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB2YXIgbWUgPSB0aGlzO1xuICAgIHZhciBzdWNjZXNzQ2FsbGJhY2sgPSBmdW5jdGlvbigpe307XG4gICAgdmFyIGZhaWx1cmVDYWxsYmFjayA9IGZ1bmN0aW9uKCl7XG4gICAgICBtZS5zdGVwLS07XG4gICAgfTtcblxuICAgIHRoaXMucmVzb2x2ZSgpLnRoZW4oXG4gICAgICBzdWNjZXNzQ2FsbGJhY2ssXG4gICAgICBmYWlsdXJlQ2FsbGJhY2tcbiAgICApO1xuICB9O1xuXG4gIC8qKlxuICAgKiBTZXRzIGByZXNvbHZlZGAgZmxhZy4gQ2FsbHMgYG9uUmVzb2x2ZWBcbiAgICogY2FsbGJhY2sgd2l0aCBKU09OIHJlc3VsdCBmb3IgY29uc3VtZXIuXG4gICAqXG4gICAqIEBwdWJsaWNcbiAgICogQG1ldGhvZCByZXNvbHZlXG4gICAqIEByZXR1cm4ge3ZvaWR9XG4gICAqL1xuICBTYXZpbmdzVGFyZ2V0VGFzay5wcm90b3R5cGUucmVzb2x2ZSA9IGZ1bmN0aW9uKCl7XG4gICAgdmFyIG5vdGlmaWNhdGlvbiA9IHRoaXMuJGluamVjdG9yLmdldCgnbm90aWZpY2F0aW9uJyk7XG4gICAgdmFyIGkxOG4gPSB0aGlzLiRpbmplY3Rvci5nZXQoJ2kxOG4nKTtcbiAgICB2YXIgJHEgPSB0aGlzLiRpbmplY3Rvci5nZXQoJyRxJyk7XG5cbiAgICB2YXIgY2FsbGJhY2sgPSB0aGlzLnJlc3VsdCA9PT0gbnVsbCA/XG4gICAgICB0aGlzLm9uUmVzb2x2ZSA6XG4gICAgICB0aGlzLm9uVXBkYXRlO1xuXG4gICAgdmFyIHJlc3VsdCA9IGNhbGxiYWNrKHtcbiAgICAgIHBheWxvYWQ6IHRoaXMuZ2V0UGF5bG9hZCgpXG4gICAgfSk7XG5cbiAgICB2YXIgbWUgPSB0aGlzO1xuICAgIHZhciBzdWNjZXNzQ2FsbGJhY2sgPSBmdW5jdGlvbihyZXN1bHQpIHtcbiAgICAgIGlmIChyZXN1bHQuaXNQZW5kaW5nKSB7XG4gICAgICAgIGlmIChtZS5zdGVwIDwgbWUudG90YWwpIHtcbiAgICAgICAgICB2YXIgbWVzc2FnZSA9IGkxOG4uZ2V0KCdUaGFuayB5b3UgZm9yIHlvdXIgaW5wdXQhJyk7XG4gICAgICAgICAgbm90aWZpY2F0aW9uLnN1Y2Nlc3MobWVzc2FnZSk7XG4gICAgICAgIH1cblxuICAgICAgICBtZS5yZXN1bHQgPSByZXN1bHQ7XG5cbiAgICAgICAgbWUuc3RvcmFnZS5zZXRJdGVtKFxuICAgICAgICAgIG1lLl9zdG9yYWdlS2V5LFxuICAgICAgICAgIG1lLnRhc2sudXBkYXRlZEF0XG4gICAgICAgICk7XG5cbiAgICAgICAgbWUuX2ZsYWcgPSAxO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIG1lLnJlc29sdmVkID0gdHJ1ZTtcbiAgICB9O1xuXG4gICAgdmFyIGZhaWx1cmVDYWxsYmFjayA9IGZ1bmN0aW9uKCkge1xuICAgIH07XG5cbiAgICB2YXIgcHJvbWlzZSA9ICRxLndoZW4ocmVzdWx0KTtcbiAgICBwcm9taXNlLnRoZW4oXG4gICAgICBzdWNjZXNzQ2FsbGJhY2ssXG4gICAgICBmYWlsdXJlQ2FsbGJhY2tcbiAgICApO1xuXG4gICAgcmV0dXJuIHByb21pc2U7XG4gIH07XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZXMgZGlmZmVyZW5jZSBiZXR3ZWVuIGBhbW91bnRgIGFuZCBgYW1vdW50UmVwZWF0ZWRgLlxuICAgKlxuICAgKiBAcHVibGljXG4gICAqIEBtZXRob2QgZ2V0RGlmZmVyZW5jZVxuICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgKi9cbiAgU2F2aW5nc1RhcmdldFRhc2sucHJvdG90eXBlLmdldERpZmZlcmVuY2UgPSBmdW5jdGlvbigpe1xuICAgIHJldHVybiB0aGlzLmFtb3VudFJlcGVhdGVkIC0gdGhpcy5hbW91bnQ7XG4gIH07XG5cbiAgLy9cbiAgLy8gUkVHSVNUUllcbiAgLy9cbiAgYW5ndWxhci5tb2R1bGUobW9kdWxlKS5kaXJlY3RpdmUoJ3NhdmluZ3NUYXJnZXRUYXNrJywgZnVuY3Rpb24oKXtcbiAgICByZXR1cm4ge1xuICAgICAgc2NvcGU6IHtcbiAgICAgICAgb25VcGRhdGU6ICcmc2F2aW5nc1RhcmdldFRhc2tPblVwZGF0ZScsXG4gICAgICAgIG9uUmVzb2x2ZTogJyZzYXZpbmdzVGFyZ2V0VGFza09uUmVzb2x2ZSdcbiAgICAgIH0sXG4gICAgICByZXN0cmljdDogJ0EnLFxuICAgICAgdHJhbnNjbHVkZTogdHJ1ZSxcbiAgICAgIGNvbnRyb2xsZXI6IFNhdmluZ3NUYXJnZXRUYXNrLFxuICAgICAgYmluZFRvQ29udHJvbGxlcjogdHJ1ZSxcbiAgICAgIGNvbnRyb2xsZXJBczogJ3NhdmluZ3NUYXJnZXRUYXNrQ29udHJvbGxlcicsXG4gICAgICB0ZW1wbGF0ZVVybDogJ3ZpZXdzL2RpcmVjdGl2ZXMvdGFza3Mvc2F2aW5ncy10YXJnZXQtdGFzay5odG1sJ1xuICAgIH07XG4gIH0pO1xuXG59KShBTkdVTEFSX01PRFVMRSwgYW5ndWxhcik7XG4iXX0=
